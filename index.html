<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; img-src 'self' data: https:; connect-src 'self' https://*.supabase.co https://*.supabase.com;">
    <title>Repward OS ‚Äî Plateforme de R√©putation Intelligente</title>
    <meta name="description" content="Repward OS transforme vos avis clients en levier de croissance gr√¢ce √† l'IA. R√©ponses automatiques, QR codes, r√©compenses et analyse multi-plateformes.">
    <meta name="theme-color" content="#0f172a">
    <meta property="og:title" content="Repward OS ‚Äî Plateforme de R√©putation Intelligente">
    <meta property="og:description" content="Transformez vos avis clients en levier de croissance gr√¢ce √† l'IA.">
    <meta property="og:type" content="website">
    <meta name="robots" content="index, follow">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiUmVwd2FyZCBPUyIsInNob3J0X25hbWUiOiJSZXB3YXJkIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMwZjE3MmEiLCJ0aGVtZV9jb2xvciI6IiMwZjE3MmEiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sLDxzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB2aWV3Qm94PScwIDAgMTAwIDEwMCc+PHRleHQgeT0nLjllbScgZm9udC1zaXplPSc5MCc+8J+PhjwvdGV4dD48L3N2Zz4iLCJzaXplcyI6ImFueSIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn1dfQ==">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèÜ</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.4/build/qrcode.min.js" onerror="
        var s=document.createElement('script');
        s.src='https://unpkg.com/qrcode@1.5.4/build/qrcode.min.js';
        document.head.appendChild(s);
    "></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" async defer onerror="console.warn('Supabase CDN unavailable, running in offline mode')"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'system-ui', 'sans-serif'] },
                    colors: {
                        slate: { 750: '#293548', 850: '#172033' },
                        brand: { 50: '#eef2ff', 100: '#e0e7ff', light: '#818cf8', DEFAULT: '#6366f1', dark: '#4f46e5', darker: '#3730a3' },
                        success: { light: '#34d399', DEFAULT: '#10b981', dark: '#059669' },
                        danger: { light: '#fb7185', DEFAULT: '#f43f5e', dark: '#e11d48' },
                        warning: { light: '#fbbf24', DEFAULT: '#f59e0b', dark: '#d97706' },
                        google: '#4285F4', airbnb: '#FF5A5F', booking: '#003580',
                        tripadvisor: '#34E0A1', yelp: '#FF1A1A', thefork: '#5C8A47',
                        ubereats: '#06C167', deliveroo: '#00CCBC', trustpilot: '#00B67A',
                        facebook: '#1877F2', instagram: '#E1306C', justeat: '#FF8000', expedia: '#00008C'
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                        'slide-down': 'slideDown 0.3s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'shimmer': 'shimmer 2s linear infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        slideDown: { '0%': { opacity: '0', transform: 'translateY(-10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        float: { '0%, 100%': { transform: 'translateY(0px)' }, '50%': { transform: 'translateY(-10px)' } },
                        shimmer: { '0%': { backgroundPosition: '-200% 0' }, '100%': { backgroundPosition: '200% 0' } },
                    }
                }
            }
        }
    </script>
    <style>
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: 'Outfit', system-ui, sans-serif; background: #0f172a; color: #f8fafc; overflow: hidden; height: 100dvh; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }

        /* Glassmorphism */
        .glass { background: rgba(30, 41, 59, 0.5); backdrop-filter: blur(24px) saturate(180%); -webkit-backdrop-filter: blur(24px) saturate(180%); border: 1px solid rgba(255, 255, 255, 0.08); }
        .glass-card { background: linear-gradient(145deg, rgba(41, 53, 72, 0.5) 0%, rgba(15, 23, 42, 0.7) 100%); border: 1px solid rgba(255,255,255,0.08); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .glass-card:hover { border-color: rgba(255,255,255,0.15); transform: translateY(-1px); box-shadow: 0 8px 30px rgba(0,0,0,0.2); }

        /* Background effects */
        .bg-mesh { background: linear-gradient(135deg, #0f172a 0%, #172033 50%, #1a1a2e 100%); position: relative; }
        .bg-mesh::before { content: ''; position: absolute; inset: 0; background: radial-gradient(ellipse 80% 50% at 50% -20%, rgba(99,102,241,0.12), transparent), radial-gradient(ellipse 60% 40% at 80% 50%, rgba(16,185,129,0.06), transparent); pointer-events: none; z-index: 0; }

        /* iPhone Frame */
        .iphone-frame { width: 100%; max-width: 340px; height: 650px; border-radius: 44px; padding: 10px; background: linear-gradient(145deg, #1e293b, #0f172a); box-shadow: 0 0 0 2px #334155, inset 0 0 0 1px rgba(255,255,255,0.05), 0 25px 60px rgba(0,0,0,0.6); position: relative; margin: 0 auto; overflow: hidden; }
        .iphone-screen { width: 100%; height: 100%; border-radius: 34px; overflow-y: auto; overflow-x: hidden; background: #f8fafc; position: relative; color: #0f172a; }
        .iphone-notch { position: absolute; top: 14px; left: 50%; transform: translateX(-50%); width: 120px; height: 28px; background: #0f172a; border-radius: 20px; z-index: 50; }

        /* Views */
        .app-view { transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); position: absolute; inset: 0; }
        .view-hidden { opacity: 0; pointer-events: none; transform: scale(0.98); z-index: -1; }
        .view-active { opacity: 1; pointer-events: auto; transform: scale(1); z-index: 10; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(51, 65, 85, 0.5); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(51, 65, 85, 0.8); }

        /* Toggle */
        .toggle-checkbox { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .toggle-checkbox:checked { left: calc(100% - 1.5rem); border-color: #10b981; }
        .toggle-checkbox:checked + .toggle-label { background-color: #10b981; }

        /* Reward card */
        .reward-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .reward-card:hover { transform: translateY(-2px); }
        .reward-card.selected { box-shadow: 0 0 20px rgba(99,102,241,0.25), 0 0 0 1px rgba(99,102,241,0.5); }

        /* Buttons */
        .btn-primary { background: white; color: #0f172a; font-weight: 700; padding: 0.875rem 1.5rem; border-radius: 0.75rem; transition: all 0.2s ease; box-shadow: 0 4px 14px rgba(0,0,0,0.1); }
        .btn-primary:hover { background: #f1f5f9; transform: translateY(-1px); box-shadow: 0 6px 20px rgba(0,0,0,0.15); }
        .btn-primary:active { transform: translateY(0); }

        /* Nav active indicator */
        .nav-item { position: relative; transition: all 0.2s ease; }
        .nav-item.active { color: #818cf8 !important; }
        .nav-item.active::after { content: ''; position: absolute; bottom: -4px; left: 50%; transform: translateX(-50%); width: 4px; height: 4px; background: #818cf8; border-radius: 50%; }

        /* Toast */
        .toast { transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .toast.show { transform: translateX(0) !important; opacity: 1 !important; }

        /* Message item */
        .message-item { transition: all 0.2s ease; }
        .message-item:hover { background: rgba(255,255,255,0.03); }
        .message-item.active { background: rgba(99,102,241,0.08); border-color: rgba(99,102,241,0.3) !important; }

        /* Shimmer loading */
        .shimmer { background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.05) 50%, transparent 100%); background-size: 200% 100%; animation: shimmer 2s linear infinite; }

        /* Gradient text */
        .gradient-text { background: linear-gradient(135deg, #818cf8, #6366f1, #4f46e5); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }

        /* KPI card glow */
        .kpi-card { position: relative; overflow: hidden; }
        .kpi-card::before { content: ''; position: absolute; top: -50%; right: -50%; width: 100%; height: 100%; background: radial-gradient(circle, rgba(99,102,241,0.08) 0%, transparent 70%); pointer-events: none; }

        /* Platform badge */
        .platform-badge { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; background: rgba(255,255,255,0.06); backdrop-filter: blur(4px); }

        /* Insight bar animation */
        .insight-bar { transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); }

        /* Mobile customer view */
        @media (max-width: 767px) {
            .iphone-frame-customer { max-width: 100%; height: calc(100dvh - 120px); border-radius: 0; padding: 0; background: transparent; box-shadow: none; }
            .iphone-frame-customer .iphone-screen { border-radius: 0; }
        }

        /* Print styles for QR */
        @media print {
            body { background: white !important; overflow: visible !important; }
            .no-print { display: none !important; }
        }

        /* Focus styles for accessibility */
        :focus-visible { outline: 2px solid #6366f1; outline-offset: 2px; border-radius: 4px; }

        /* Smooth number counter */
        .counter { display: inline-block; }

        /* ========== FORTUNE WHEEL ‚Äî PREMIUM ========== */
        .wheel-wrapper {
            position: relative;
            display: inline-block;
        }
        .wheel-wrapper::before {
            content: '';
            position: absolute;
            inset: -18px;
            border-radius: 50%;
            background: conic-gradient(from 0deg, #fbbf24, #f59e0b, #d97706, #fbbf24, #f59e0b, #d97706, #fbbf24);
            z-index: 0;
            animation: wheelRingGlow 4s linear infinite;
        }
        .wheel-wrapper::after {
            content: '';
            position: absolute;
            inset: -12px;
            border-radius: 50%;
            background: radial-gradient(circle, transparent 55%, rgba(0,0,0,0.7) 100%);
            z-index: 1;
            pointer-events: none;
        }
        @keyframes wheelRingGlow {
            0% { filter: brightness(1) drop-shadow(0 0 8px rgba(251,191,36,0.4)); }
            50% { filter: brightness(1.2) drop-shadow(0 0 20px rgba(251,191,36,0.7)); }
            100% { filter: brightness(1) drop-shadow(0 0 8px rgba(251,191,36,0.4)); }
        }
        .wheel-container { perspective: 1000px; position: relative; z-index: 2; }
        .wheel-canvas {
            width: 300px;
            height: 300px;
            margin: 0 auto;
            border-radius: 50%;
            filter: drop-shadow(0 0 24px rgba(99, 102, 241, 0.3));
            transition: filter 0.3s ease;
        }
        .wheel-canvas:hover {
            filter: drop-shadow(0 0 32px rgba(99, 102, 241, 0.5));
        }
        /* Triangle pointer at top */
        .wheel-pointer {
            position: absolute;
            top: -22px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            width: 0; height: 0;
            border-left: 18px solid transparent;
            border-right: 18px solid transparent;
            border-top: 32px solid #fbbf24;
            filter: drop-shadow(0 4px 10px rgba(251, 191, 36, 0.6));
        }
        .wheel-pointer::after {
            content: '';
            position: absolute;
            top: -32px; left: -12px;
            width: 0; height: 0;
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-top: 22px solid #fde68a;
        }
        .wheel-spinning {
            animation: wheelSpin 3s cubic-bezier(0.25, 0.46, 0.45, 0.94) 1;
        }
        @keyframes wheelSpin {
            from { transform: rotate(0deg); }
            to { transform: rotate(1800deg); }
        }
        .wheel-btn {
            background: linear-gradient(135deg, #818cf8, #6366f1, #7c3aed);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4), inset 0 1px 0 rgba(255,255,255,0.2);
            letter-spacing: 0.5px;
            text-transform: uppercase;
            font-size: 14px;
        }
        .wheel-btn:hover {
            background: linear-gradient(135deg, #6366f1, #4f46e5, #6d28d9);
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 16px 40px rgba(99, 102, 241, 0.5), inset 0 1px 0 rgba(255,255,255,0.2);
        }
        .wheel-btn:active {
            transform: translateY(0) scale(0.98);
        }
        .wheel-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            animation: wheelBtnPulse 1s ease-in-out infinite;
        }
        @keyframes wheelBtnPulse {
            0%, 100% { box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4); }
            50% { box-shadow: 0 8px 32px rgba(99, 102, 241, 0.7); }
        }

        /* ========== FOMO BUBBLE ========== */
        .fomo-bubble {
            position: fixed;
            bottom: 100px;
            left: -400px;
            width: 350px;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.95), rgba(5, 150, 105, 0.95));
            border: 1px solid rgba(16, 185, 129, 0.5);
            border-radius: 16px;
            padding: 16px;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            z-index: 999;
            animation: fomoSlideIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }
        .fomo-bubble.slide-out {
            animation: fomoSlideOut 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }
        @keyframes fomoSlideIn {
            from { left: -400px; opacity: 0; }
            to { left: 20px; opacity: 1; }
        }
        @keyframes fomoSlideOut {
            from { left: 20px; opacity: 1; }
            to { left: -400px; opacity: 0; }
        }
        .fomo-close {
            cursor: pointer;
            color: white;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        .fomo-close:hover { opacity: 1; }

        /* ========== KIOSK MODE ========== */
        .kiosk-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #0f172a 0%, #172033 100%);
            padding: 40px;
        }
        .kiosk-content {
            text-align: center;
            animation: kiosk-fade-in 1s ease-out;
        }
        @keyframes kiosk-fade-in {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }
        .kiosk-logo {
            font-size: 72px;
            margin-bottom: 30px;
            animation: kiosk-float 3s ease-in-out infinite;
        }
        @keyframes kiosk-float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        .kiosk-message {
            font-size: 48px;
            font-weight: 900;
            color: white;
            margin-bottom: 20px;
            letter-spacing: -1px;
        }
        .kiosk-qr {
            background: white;
            padding: 40px;
            border-radius: 24px;
            margin: 40px 0;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        }
        .kiosk-qr canvas {
            width: 300px;
            height: 300px;
        }
        .kiosk-reward-info {
            color: #cbd5e1;
            font-size: 20px;
            margin-top: 30px;
        }

        /* ========== LEADERBOARD ========== */
        .medal-gold { color: #fbbf24; }
        .medal-silver { color: #d1d5db; }
        .medal-bronze { color: #d97706; }
        .podium {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 20px;
            height: 300px;
            margin: 40px 0;
        }
        .podium-place {
            text-align: center;
            padding: 20px;
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            flex: 0 1 150px;
        }
        .podium-place.first {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(217, 119, 6, 0.1));
            border-color: rgba(251, 191, 36, 0.3);
            height: 280px;
            order: 2;
        }
        .podium-place.second {
            background: linear-gradient(135deg, rgba(209, 213, 219, 0.2), rgba(107, 114, 128, 0.1));
            border-color: rgba(209, 213, 219, 0.3);
            height: 220px;
            order: 1;
        }
        .podium-place.third {
            background: linear-gradient(135deg, rgba(217, 119, 6, 0.2), rgba(120, 53, 15, 0.1));
            border-color: rgba(217, 119, 6, 0.3);
            height: 180px;
            order: 3;
        }
        .medal { font-size: 48px; margin-bottom: 12px; }
        .podium-rank { font-size: 28px; font-weight: 900; margin-bottom: 8px; }
        .podium-name { font-size: 14px; font-weight: 600; margin-bottom: 12px; }
        .podium-stats { font-size: 12px; color: #94a3b8; }

            </style>
</head>
<body class="bg-mesh flex flex-col relative">

    <!-- V3+ Noise Grain Overlay -->
    <!-- V3+ Visual overlays (purely decorative, cannot block content) -->
        
    <!-- Toast Notification -->
    <div id="toast-notification" class="toast fixed bottom-6 right-6 bg-gradient-to-r from-success to-success-dark text-white px-6 py-4 rounded-2xl shadow-2xl shadow-success/20 flex items-center gap-3 transform translate-x-[150%] opacity-0 z-[200]" role="alert" aria-live="polite">
        <div class="toast-icon w-8 h-8 bg-white/20 rounded-full flex items-center justify-center flex-shrink-0">
            <i class="fa-solid fa-check text-sm"></i>
        </div>
        <div>
            <p class="toast-title font-bold text-sm">R√©ponse publi√©e</p>
            <p class="toast-msg text-[11px] text-white/80">L'avis a √©t√© trait√© avec succ√®s</p>
        </div>
    </div>

    <!-- Master Navigation -->
    <header class="fixed top-4 left-1/2 -translate-x-1/2 z-[100] no-print">
        <div class="glass rounded-2xl p-1.5 flex shadow-2xl border border-white/10">
            <button onclick="switchMasterView('merchant')" id="btn-merchant" class="px-5 md:px-8 py-2.5 rounded-xl text-xs md:text-sm font-bold bg-white text-slate-900 transition-all duration-300 whitespace-nowrap" aria-label="Vue tableau de bord commer√ßant">
                <i class="fa-solid fa-chart-pie mr-1.5 hidden sm:inline"></i> Tableau de Bord
            </button>
            <button onclick="switchMasterView('customer')" id="btn-customer" class="px-5 md:px-8 py-2.5 rounded-xl text-xs md:text-sm font-bold text-slate-400 hover:text-white transition-all duration-300 whitespace-nowrap" aria-label="Vue client mobile">
                <i class="fa-solid fa-mobile-screen mr-1.5 hidden sm:inline"></i> Vue Client
            </button>
        </div>
    </header>

    <!-- ========================================== -->
    <!-- ONBOARDING / INSCRIPTION                   -->
    <!-- ========================================== -->
    <div id="view-onboarding" class="app-view view-active fixed inset-0 z-[100] bg-slate-950 flex items-center justify-center p-4 overflow-y-auto" style="display: none;">
        <div class="w-full max-w-md">
            <!-- Step 1: Language + Welcome -->
            <div id="onboard-step-1" class="text-center animate-fade-in">
                <div class="w-20 h-20 rounded-2xl bg-gradient-to-br from-brand to-brand-dark flex items-center justify-center mx-auto mb-6 shadow-2xl shadow-brand/30">
                    <i class="fa-solid fa-award text-white text-3xl"></i>
                </div>
                <h1 class="text-3xl font-black text-white mb-2" id="welcome-title">Welcome to Repward</h1>
                <p class="text-slate-400 text-sm mb-6" id="welcome-subtitle">Choose your language</p>
                <div class="grid grid-cols-2 gap-2.5 mb-6" id="lang-grid">
                    <button onclick="chooseLang('fr')" class="lang-btn flex items-center gap-3 p-3.5 rounded-xl border border-white/10 bg-white/[0.03] hover:bg-brand/10 hover:border-brand/40 transition-all text-left">
                        <span class="text-2xl">üá´üá∑</span><span class="text-sm font-bold text-white">Fran√ßais</span>
                    </button>
                    <button onclick="chooseLang('en')" class="lang-btn flex items-center gap-3 p-3.5 rounded-xl border border-white/10 bg-white/[0.03] hover:bg-brand/10 hover:border-brand/40 transition-all text-left">
                        <span class="text-2xl">üá¨üáß</span><span class="text-sm font-bold text-white">English</span>
                    </button>
                    <button onclick="chooseLang('es')" class="lang-btn flex items-center gap-3 p-3.5 rounded-xl border border-white/10 bg-white/[0.03] hover:bg-brand/10 hover:border-brand/40 transition-all text-left">
                        <span class="text-2xl">üá™üá∏</span><span class="text-sm font-bold text-white">Espa√±ol</span>
                    </button>
                    <button onclick="chooseLang('it')" class="lang-btn flex items-center gap-3 p-3.5 rounded-xl border border-white/10 bg-white/[0.03] hover:bg-brand/10 hover:border-brand/40 transition-all text-left">
                        <span class="text-2xl">üáÆüáπ</span><span class="text-sm font-bold text-white">Italiano</span>
                    </button>
                    <button onclick="chooseLang('de')" class="lang-btn flex items-center gap-3 p-3.5 rounded-xl border border-white/10 bg-white/[0.03] hover:bg-brand/10 hover:border-brand/40 transition-all text-left">
                        <span class="text-2xl">üá©üá™</span><span class="text-sm font-bold text-white">Deutsch</span>
                    </button>
                    <button onclick="chooseLang('pt')" class="lang-btn flex items-center gap-3 p-3.5 rounded-xl border border-white/10 bg-white/[0.03] hover:bg-brand/10 hover:border-brand/40 transition-all text-left">
                        <span class="text-2xl">üáµüáπ</span><span class="text-sm font-bold text-white">Portugu√™s</span>
                    </button>
                    <button onclick="chooseLang('nl')" class="lang-btn flex items-center gap-3 p-3.5 rounded-xl border border-white/10 bg-white/[0.03] hover:bg-brand/10 hover:border-brand/40 transition-all text-left">
                        <span class="text-2xl">üá≥üá±</span><span class="text-sm font-bold text-white">Nederlands</span>
                    </button>
                    <button onclick="chooseLang('ar')" class="lang-btn flex items-center gap-3 p-3.5 rounded-xl border border-white/10 bg-white/[0.03] hover:bg-brand/10 hover:border-brand/40 transition-all text-left">
                        <span class="text-2xl">üá∏üá¶</span><span class="text-sm font-bold text-white">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</span>
                    </button>
                </div>
                <p class="text-[10px] text-slate-600 mt-2">Free registration ¬∑ No credit card required</p>
            </div>

            <!-- Step 2: Type de commerce -->
            <div id="onboard-step-2" class="animate-fade-in" style="display: none;">
                <div class="text-center mb-5">
                    <span class="text-xs font-bold text-brand-light bg-brand/10 px-3 py-1 rounded-full" data-i18n="onboardStepIndustry">Votre activit√©</span>
                    <h2 class="text-2xl font-extrabold text-white mt-3" data-i18n="onboardIndustryTitle">Quel est votre commerce ?</h2>
                    <p class="text-sm text-slate-400 mt-1" data-i18n="onboardIndustrySubtitle">Repward s'adapte √† votre m√©tier</p>
                </div>
                <div class="grid grid-cols-2 gap-2.5 mb-5" id="industry-grid">
                    <button onclick="chooseIndustry('restaurant')" class="industry-btn flex flex-col items-center gap-1.5 p-3.5 rounded-xl border border-white/10 bg-white/[0.03] hover:bg-brand/10 hover:border-brand/40 transition-all text-center">
                        <span class="text-3xl">üçΩÔ∏è</span><span class="text-[11px] font-bold text-white leading-tight">Restaurant & Bar</span>
                    </button>
                    <button onclick="chooseIndustry('coffee')" class="industry-btn flex flex-col items-center gap-1.5 p-3.5 rounded-xl border border-white/10 bg-white/[0.03] hover:bg-brand/10 hover:border-brand/40 transition-all text-center">
                        <span class="text-3xl">‚òï</span><span class="text-[11px] font-bold text-white leading-tight">Coffee Shop</span>
                    </button>
                    <button onclick="chooseIndustry('streetfood')" class="industry-btn flex flex-col items-center gap-1.5 p-3.5 rounded-xl border border-white/10 bg-white/[0.03] hover:bg-brand/10 hover:border-brand/40 transition-all text-center">
                        <span class="text-3xl">üåÆ</span><span class="text-[11px] font-bold text-white leading-tight">Street Food</span>
                    </button>
                    <button onclick="chooseIndustry('hotel')" class="industry-btn flex flex-col items-center gap-1.5 p-3.5 rounded-xl border border-white/10 bg-white/[0.03] hover:bg-brand/10 hover:border-brand/40 transition-all text-center">
                        <span class="text-3xl">üè®</span><span class="text-[11px] font-bold text-white leading-tight">H√¥tel & Spa</span>
                    </button>
                    <button onclick="chooseIndustry('airbnb')" class="industry-btn flex flex-col items-center gap-1.5 p-3.5 rounded-xl border border-white/10 bg-white/[0.03] hover:bg-brand/10 hover:border-brand/40 transition-all text-center">
                        <span class="text-3xl">üîë</span><span class="text-[11px] font-bold text-white leading-tight">Airbnb</span>
                    </button>
                    <button onclick="chooseIndustry('beauty')" class="industry-btn flex flex-col items-center gap-1.5 p-3.5 rounded-xl border border-white/10 bg-white/[0.03] hover:bg-brand/10 hover:border-brand/40 transition-all text-center">
                        <span class="text-3xl">‚úÇÔ∏è</span><span class="text-[11px] font-bold text-white leading-tight">Coiffure & Beaut√©</span>
                    </button>
                    <button onclick="chooseIndustry('retail')" class="industry-btn flex flex-col items-center gap-1.5 p-3.5 rounded-xl border border-white/10 bg-white/[0.03] hover:bg-brand/10 hover:border-brand/40 transition-all text-center">
                        <span class="text-3xl">üõçÔ∏è</span><span class="text-[11px] font-bold text-white leading-tight">Boutique & Retail</span>
                    </button>
                    <button onclick="chooseIndustry('bakery')" class="industry-btn flex flex-col items-center gap-1.5 p-3.5 rounded-xl border border-white/10 bg-white/[0.03] hover:bg-brand/10 hover:border-brand/40 transition-all text-center">
                        <span class="text-3xl">ü•ê</span><span class="text-[11px] font-bold text-white leading-tight">Boulangerie</span>
                    </button>
                    <button onclick="chooseIndustry('gym')" class="industry-btn flex flex-col items-center gap-1.5 p-3.5 rounded-xl border border-white/10 bg-white/[0.03] hover:bg-brand/10 hover:border-brand/40 transition-all text-center">
                        <span class="text-3xl">üí™</span><span class="text-[11px] font-bold text-white leading-tight">Sport & Fitness</span>
                    </button>
                    <button onclick="chooseIndustry('garage')" class="industry-btn flex flex-col items-center gap-1.5 p-3.5 rounded-xl border border-white/10 bg-white/[0.03] hover:bg-brand/10 hover:border-brand/40 transition-all text-center">
                        <span class="text-3xl">üîß</span><span class="text-[11px] font-bold text-white leading-tight">Garage & Auto</span>
                    </button>
                </div>
                <button onclick="onboardNext(1)" class="w-full text-sm text-slate-500 hover:text-slate-300 transition-colors py-2">
                    <i class="fa-solid fa-arrow-left mr-1"></i> Retour
                </button>
            </div>

            <!-- Step 3: Compte + Commerce (tout en un) -->
            <div id="onboard-step-3" class="animate-fade-in" style="display: none;">
                <div class="text-center mb-4">
                    <div id="onboard-industry-display" class="inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-brand/10 border border-brand/20 mb-3">
                        <span id="onboard-industry-emoji" class="text-lg">üçΩÔ∏è</span>
                        <span id="onboard-industry-label" class="text-xs font-bold text-white">Restaurant & Bar</span>
                        <button onclick="onboardNext(2)" class="text-[10px] text-brand-light hover:text-white transition-colors ml-1"><i class="fa-solid fa-pen"></i></button>
                    </div>
                    <h2 class="text-xl font-extrabold text-white mt-1">Cr√©ez votre compte</h2>
                    <p class="text-sm text-slate-400 mt-1">Derni√®re √©tape avant de commencer</p>
                </div>
                <input type="hidden" id="onboard-industry" value="restaurant">
                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 mb-1 uppercase tracking-wider">Nom complet</label>
                            <input id="onboard-name" type="text" class="w-full bg-slate-800/80 border border-white/10 rounded-xl p-3 text-white text-sm focus:border-brand focus:ring-2 focus:ring-brand/20 outline-none transition-all" placeholder="Jean Dupont">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 mb-1 uppercase tracking-wider">Nom de l'√©tablissement</label>
                            <input id="onboard-business" type="text" class="w-full bg-slate-800/80 border border-white/10 rounded-xl p-3 text-white text-sm focus:border-brand focus:ring-2 focus:ring-brand/20 outline-none transition-all" placeholder="Le Gourmet">
                        </div>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500 mb-1 uppercase tracking-wider">Email professionnel</label>
                        <input id="onboard-email" type="email" class="w-full bg-slate-800/80 border border-white/10 rounded-xl p-3 text-white text-sm focus:border-brand focus:ring-2 focus:ring-brand/20 outline-none transition-all" placeholder="jean@moncommerce.fr">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500 mb-1 uppercase tracking-wider">Mot de passe</label>
                        <input id="onboard-password" type="password" class="w-full bg-slate-800/80 border border-white/10 rounded-xl p-3 text-white text-sm focus:border-brand focus:ring-2 focus:ring-brand/20 outline-none transition-all" placeholder="Min. 6 caract√®res">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 mb-1 uppercase tracking-wider">T√©l√©phone (optionnel)</label>
                            <input id="onboard-phone" type="tel" class="w-full bg-slate-800/80 border border-white/10 rounded-xl p-3 text-white text-sm focus:border-brand focus:ring-2 focus:ring-brand/20 outline-none transition-all" placeholder="+33 6 12 34 56 78">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 mb-1 uppercase tracking-wider">Code promo (optionnel)</label>
                            <div class="flex gap-1.5">
                                <input id="onboard-promo" type="text" class="flex-1 bg-slate-800/80 border border-white/10 rounded-xl p-3 text-white text-sm font-mono uppercase focus:border-brand focus:ring-2 focus:ring-brand/20 outline-none transition-all tracking-wider" placeholder="DEMO2026">
                                <button onclick="validatePromoCode()" class="bg-brand/20 text-brand-light border border-brand/30 px-3 rounded-xl font-bold text-[10px] hover:bg-brand/30 transition-all">
                                    <i class="fa-solid fa-tag"></i>
                                </button>
                            </div>
                            <p id="promo-status" class="text-[10px] text-slate-500 mt-1 hidden"></p>
                        </div>
                    </div>
                    <button onclick="completeOnboarding()" class="btn-primary w-full py-3.5">
                        <i class="fa-solid fa-rocket mr-2"></i> Lancer Repward
                    </button>
                    <button onclick="onboardNext(2)" class="w-full text-sm text-slate-500 hover:text-slate-300 transition-colors py-1">
                        <i class="fa-solid fa-arrow-left mr-1"></i> Retour
                    </button>
                    <p id="onboard-error-3" class="text-danger text-xs text-center hidden"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- VUE COMMER√áANT                             -->
    <!-- ========================================== -->
    <div id="view-merchant" class="app-view view-active flex h-[100dvh] w-full flex-col md:flex-row pb-20 md:pb-0">

        <!-- Sidebar Desktop -->
        <aside class="hidden md:flex w-64 lg:w-72 border-r border-white/5 glass flex-col py-6 z-20 flex-shrink-0">
            <div class="px-6 mb-10 flex items-center">
                <div class="w-11 h-11 rounded-xl bg-gradient-to-br from-brand to-brand-dark flex items-center justify-center shadow-lg shadow-brand/20">
                    <i class="fa-solid fa-award text-white text-lg"></i>
                </div>
                <div class="ml-3">
                    <span class="font-extrabold text-xl tracking-tight">Repward</span>
                    <span class="text-[9px] font-bold text-brand-light bg-brand/10 px-1.5 py-0.5 rounded ml-1 uppercase tracking-wider">OS</span>
                </div>
            </div>
            <nav class="flex-1 px-4 space-y-1" aria-label="Navigation principale">
                <button onclick="switchTab('analytics')" id="nav-analytics-desk" class="nav-item w-full flex items-center px-4 py-3 rounded-xl text-slate-400 hover:bg-white/5 font-medium text-sm transition-all">
                    <i class="fa-solid fa-chart-line w-5 text-center"></i><span class="ml-3">Analyses</span>
                </button>
                <button onclick="switchTab('triage')" id="nav-triage-desk" class="nav-item w-full flex items-center px-4 py-3 rounded-xl text-slate-400 hover:bg-white/5 font-medium text-sm transition-all relative">
                    <i class="fa-solid fa-inbox w-5 text-center"></i><span class="ml-3">Messageries</span>
                    <span class="absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 bg-danger rounded-full text-[10px] font-bold flex items-center justify-center text-white">3</span>
                </button>
                <button onclick="switchTab('portal')" id="nav-portal-desk" class="nav-item w-full flex items-center px-4 py-3 rounded-xl text-slate-400 hover:bg-white/5 font-medium text-sm transition-all">
                    <i class="fa-solid fa-qrcode w-5 text-center"></i><span class="ml-3">QR & Cadeaux</span>
                </button>
                <button onclick="switchTab('history')" id="nav-history-desk" class="nav-item w-full flex items-center px-4 py-3 rounded-xl text-slate-400 hover:bg-white/5 font-medium text-sm transition-all">
                    <i class="fa-solid fa-clock-rotate-left w-5 text-center"></i><span class="ml-3">Historique</span>
                </button>
                <button onclick="switchTab('integrations')" id="nav-integrations-desk" class="nav-item w-full flex items-center px-4 py-3 rounded-xl text-slate-400 hover:bg-white/5 font-medium text-sm transition-all">
                    <i class="fa-solid fa-plug w-5 text-center"></i><span class="ml-3">Int√©grations</span>
                    <span class="ml-auto text-[10px] font-bold text-brand-light bg-brand/10 px-2 py-0.5 rounded-full">14</span>
                </button>
                <button onclick="switchTab('fortune')" id="nav-fortune-desk" class="nav-item w-full flex items-center px-4 py-3 rounded-xl text-slate-400 hover:bg-white/5 font-medium text-sm transition-all">
                    <i class="fa-solid fa-circle-notch w-5 text-center"></i><span class="ml-3">Roue</span>
                </button>
                <button onclick="switchTab('team')" id="nav-team-desk" class="nav-item w-full flex items-center px-4 py-3 rounded-xl text-slate-400 hover:bg-white/5 font-medium text-sm transition-all">
                    <i class="fa-solid fa-users w-5 text-center"></i><span class="ml-3">√âquipe</span>
                </button>

                <div class="pt-4 pb-2"><div class="border-t border-white/5"></div></div>

                <button onclick="switchTab('settings')" id="nav-settings-desk" class="nav-item w-full flex items-center px-4 py-3 rounded-xl text-slate-400 hover:bg-white/5 font-medium text-sm transition-all">
                    <i class="fa-solid fa-gear w-5 text-center"></i><span class="ml-3">Compte & Pro</span>
                </button>
            </nav>

            <!-- Reputation Score -->
            <div class="px-4 mb-4">
                <div class="glass-card rounded-xl p-4 border-success/20 text-center">
                    <div class="relative w-16 h-16 mx-auto mb-2">
                        <svg class="w-16 h-16 -rotate-90" viewBox="0 0 36 36">
                            <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#1e293b" stroke-width="3"/>
                            <path id="rep-score-circle" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#10b981" stroke-width="3" stroke-dasharray="87, 100" stroke-linecap="round" class="transition-all duration-1000"/>
                        </svg>
                        <span id="rep-score-num" class="absolute inset-0 flex items-center justify-center text-lg font-black text-success">87</span>
                    </div>
                    <p id="rep-score-label" class="text-[10px] font-bold text-success">Excellente r√©putation</p>
                    <p id="rep-score-rank" class="text-[9px] font-bold text-brand-light mt-0.5"><i class="fa-solid fa-trophy mr-0.5"></i> Expert</p>
                </div>
            </div>

            <!-- Sidebar footer -->
            <div class="px-4 mt-auto">
                <div class="glass-card rounded-xl p-4 border-brand/20">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-brand to-brand-dark flex items-center justify-center text-xs font-bold text-white">CR</div>
                        <div>
                            <p class="text-xs font-bold text-white" id="sidebar-biz-name">Mon Commerce</p>
                            <p class="text-[10px] text-slate-400">Plan Gratuit</p>
                        </div>
                    </div>
                    <div class="w-full bg-slate-800 rounded-full h-1.5">
                        <div class="bg-brand rounded-full h-1.5 w-[30%] transition-all"></div>
                    </div>
                    <p class="text-[10px] text-slate-500 mt-1.5">3/10 r√©ponses IA ce mois</p>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 relative overflow-y-auto pt-20 md:pt-8 p-4 md:p-8 lg:p-10 xl:p-12 w-full" id="main-content">

            <!-- CONTENU : PORTAL (QR & CADEAUX) -->
            <div id="tab-portal" class="hidden">
                <div class="space-y-4 max-w-7xl mx-auto">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-xl md:text-2xl font-extrabold text-white">QR Code & R√©compenses</h2>
                            <p class="text-xs text-slate-400 mt-0.5">Configurez votre syst√®me de collecte d'avis</p>
                        </div>
                    </div>

                    <div class="flex flex-col xl:flex-row gap-4">
                        <!-- GAUCHE: Config -->
                        <div class="flex-1 space-y-3">
                            <!-- Industry badge (read-only, set by onboarding) -->
                            <div id="portal-industry-badge" class="flex items-center gap-2.5 px-3 py-2 rounded-xl bg-brand/5 border border-brand/10">
                                <span id="portal-industry-emoji" class="text-lg">üçΩÔ∏è</span>
                                <span id="portal-industry-name" class="text-sm font-bold text-white">Restaurant & Bar</span>
                                <span class="ml-auto text-[9px] text-slate-500 bg-slate-800 px-2 py-0.5 rounded-full">D√©fini √† l'inscription</span>
                            </div>
                            <!-- Hidden select kept for JS compatibility -->
                            <select id="ind-selector" onchange="updateInd()" class="hidden" style="display:none;">
                                <option value="restaurant">Restaurant & Bar</option>
                                <option value="coffee">Coffee Shop & Salon de Th√©</option>
                                <option value="streetfood">Street Food & Fast Food</option>
                                <option value="hotel">H√¥tel & Spa</option>
                                <option value="airbnb">Airbnb & Conciergerie</option>
                                <option value="beauty">Coiffure & Beaut√©</option>
                                <option value="retail">Boutique & Retail</option>
                                <option value="bakery">Boulangerie & P√¢tisserie</option>
                                <option value="gym">Salle de Sport & Fitness</option>
                                <option value="garage">Garage & Auto</option>
                            </select>

                            <!-- Rewards grid (compact) -->
                            <div class="glass-card p-3 rounded-2xl">
                                <h3 class="font-bold mb-2 flex items-center text-white text-sm">
                                    <span class="w-6 h-6 rounded-lg bg-brand/10 flex items-center justify-center mr-2"><i class="fa-solid fa-gift text-brand text-[10px]"></i></span>
                                    R√©compense client
                                </h3>
                                <div id="rew-grid" class="grid grid-cols-3 gap-1.5"></div>
                            </div>

                            <!-- QR Code + Actions (compact) -->
                            <div class="glass-card p-3 rounded-2xl">
                                <div id="qr-code-container" class="flex justify-center p-2 bg-white rounded-xl mb-2 hidden">
                                    <canvas id="qr-canvas"></canvas>
                                </div>
                                <div class="flex gap-2">
                                    <button class="btn-primary flex-1 flex items-center justify-center text-xs py-2" onclick="generateQRCode()">
                                        <i class="fa-solid fa-qrcode mr-1.5"></i> G√©n√©rer QR
                                    </button>
                                    <button id="btn-download-qr" class="flex-1 flex items-center justify-center text-xs font-bold text-brand-light hover:text-white border border-brand/20 rounded-xl transition-all py-2 hidden" onclick="downloadQR()">
                                        <i class="fa-solid fa-download mr-1.5"></i> PNG
                                    </button>
                                </div>
                                <!-- Short Link -->
                                <div class="mt-2 pt-2 border-t border-white/5">
                                    <div class="flex gap-1.5">
                                        <input id="short-link-display" type="text" readonly class="flex-1 bg-slate-900/50 border border-white/10 rounded-lg px-2.5 py-1.5 text-[10px] text-brand-light font-mono cursor-pointer" onclick="this.select();copyShortLink()" value="">
                                        <button onclick="copyShortLink()" class="px-2.5 bg-brand/20 text-brand-light border border-brand/30 rounded-lg text-[10px] font-bold hover:bg-brand/30 transition-all">
                                            <i class="fa-solid fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                                <!-- Kiosk + NFC -->
                                <div class="grid grid-cols-2 gap-2 mt-2 pt-2 border-t border-white/5">
                                    <button onclick="activateKioskMode()" class="py-2 rounded-xl font-bold text-[11px] bg-gradient-to-r from-cyan-400 to-cyan-600 text-slate-900 hover:from-cyan-300 hover:to-cyan-500 transition-all shadow-lg shadow-cyan-500/20 flex items-center justify-center gap-1">
                                        üì± Kiosque
                                    </button>
                                    <button onclick="showNFCModal()" class="py-2 rounded-xl font-bold text-[11px] bg-gradient-to-r from-yellow-400 to-yellow-600 text-slate-900 hover:from-yellow-300 hover:to-yellow-500 transition-all shadow-lg shadow-yellow-500/20 flex items-center justify-center gap-1">
                                        üì° NFC <span class="text-[9px] bg-white/30 px-1 py-0.5 rounded-full font-black">49‚Ç¨</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- DROITE: iPhone preview -->
                        <div class="hidden lg:flex w-[340px] flex-col items-center flex-shrink-0">
                            <p class="text-[10px] font-bold text-slate-500 uppercase tracking-[0.2em] mb-3 flex items-center gap-2">
                                <span class="w-1.5 h-1.5 bg-success rounded-full animate-pulse"></span>
                                Aper√ßu en temps r√©el
                            </p>
                            <div class="iphone-frame animate-float" style="transform-origin: top center; transform: scale(0.92);">
                                <div class="iphone-notch"></div>
                                <div class="iphone-screen" id="preview-screen" aria-hidden="true">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CONTENU : ANALYSES -->
            <div id="tab-analytics" class="hidden">
                <div class="space-y-6 max-w-7xl mx-auto">
                    <div>
                        <h2 class="text-2xl md:text-3xl font-extrabold text-white">Performances & Croissance</h2>
                        <p class="text-sm text-slate-400 mt-1">Vue d'ensemble de votre r√©putation en ligne</p>
                    </div>

                    <!-- KPI Cards -->
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 md:gap-6">
                        <div class="glass-card kpi-card p-5 md:p-6 rounded-2xl">
                            <div class="flex items-center justify-between mb-3">
                                <p class="text-slate-400 text-[10px] md:text-xs uppercase font-bold tracking-wider">Avis 5‚òÖ ce mois</p>
                                <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center"><i class="fa-solid fa-star text-yellow-400 text-xs"></i></div>
                            </div>
                            <p id="kpi-reviews" class="text-3xl md:text-4xl font-black text-white">+84</p>
                            <p class="text-xs text-success mt-1.5 font-medium"><i class="fa-solid fa-arrow-trend-up mr-1"></i> +12% vs mois dernier</p>
                        </div>
                        <div class="glass-card kpi-card p-5 md:p-6 rounded-2xl border-brand/10">
                            <div class="flex items-center justify-between mb-3">
                                <p class="text-slate-400 text-[10px] md:text-xs uppercase font-bold tracking-wider">Temps gagn√© (IA)</p>
                                <div class="w-8 h-8 rounded-lg bg-brand/10 flex items-center justify-center"><i class="fa-solid fa-clock text-brand-light text-xs"></i></div>
                            </div>
                            <p id="kpi-time" class="text-3xl md:text-4xl font-black text-brand-light">16h</p>
                            <p class="text-xs text-slate-400 mt-1.5 font-medium">‚âà 2 jours de travail √©conomis√©s</p>
                        </div>
                        <div class="glass-card kpi-card p-5 md:p-6 rounded-2xl border-success/10">
                            <div class="flex items-center justify-between mb-3">
                                <p class="text-slate-400 text-[10px] md:text-xs uppercase font-bold tracking-wider">R.O.I Win-Back</p>
                                <div class="w-8 h-8 rounded-lg bg-success/10 flex items-center justify-center"><i class="fa-solid fa-euro-sign text-success text-xs"></i></div>
                            </div>
                            <p id="kpi-roi" class="text-3xl md:text-4xl font-black text-success">1 240 ‚Ç¨</p>
                            <p class="text-xs text-success mt-1.5 font-medium"><i class="fa-solid fa-arrow-trend-up mr-1"></i> Revenus r√©cup√©r√©s</p>
                        </div>
                    </div>

                    <!-- AI Insights -->
                    <div class="glass-card p-5 md:p-6 rounded-2xl">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-bold text-white flex items-center">
                                <span class="w-8 h-8 rounded-lg bg-danger/10 flex items-center justify-center mr-3"><i class="fa-solid fa-brain text-danger text-sm"></i></span>
                                Radar Op√©rationnel IA
                            </h3>
                            <span class="text-[10px] font-bold text-slate-500 bg-slate-800 px-3 py-1 rounded-full">Mis √† jour il y a 2h</span>
                        </div>
                        <p class="text-xs text-slate-400 mb-4">Probl√®mes r√©currents d√©tect√©s automatiquement dans vos avis</p>
                        <div class="space-y-3" id="ai-insights"></div>
                    </div>

                    <!-- Heatmap 30 jours (style GitHub) -->
                    <div class="glass-card p-5 md:p-6 rounded-2xl">
                        <h3 class="font-bold text-white flex items-center mb-4">
                            <span class="w-8 h-8 rounded-lg bg-brand/10 flex items-center justify-center mr-3"><i class="fa-solid fa-fire text-brand text-sm"></i></span>
                            Heatmap des avis ‚Äî 30 derniers jours
                        </h3>
                        <div class="grid grid-cols-10 sm:grid-cols-15 gap-1" id="heatmap-container" style="display:grid;grid-template-columns:repeat(15,1fr);"></div>
                        <div class="flex items-center gap-2 mt-3">
                            <span class="text-[10px] text-slate-500">Moins</span>
                            <div class="w-3 h-3 rounded-sm bg-slate-800"></div>
                            <div class="w-3 h-3 rounded-sm bg-brand/20"></div>
                            <div class="w-3 h-3 rounded-sm bg-brand/50"></div>
                            <div class="w-3 h-3 rounded-sm bg-brand/80"></div>
                            <div class="w-3 h-3 rounded-sm bg-brand"></div>
                            <span class="text-[10px] text-slate-500">Plus</span>
                        </div>
                    </div>

                    <!-- Marketplace: R√©compenses Trackables -->
                    <div class="glass-card p-5 md:p-6 rounded-2xl">
                        <h3 class="font-bold text-white flex items-center mb-4">
                            <span class="w-8 h-8 rounded-lg bg-success/10 flex items-center justify-center mr-3"><i class="fa-solid fa-gift text-success text-sm"></i></span>
                            R√©compenses Trackables
                        </h3>
                        <div class="grid grid-cols-1 sm:grid-cols-4 gap-4" id="marketplace-stats">
                            <div class="text-center p-4 bg-white/5 rounded-xl">
                                <p class="text-3xl font-black text-brand-light" id="stat-codes-gen">247</p>
                                <p class="text-[10px] text-slate-400 font-bold mt-1">Codes g√©n√©r√©s</p>
                            </div>
                            <div class="text-center p-4 bg-white/5 rounded-xl">
                                <p class="text-3xl font-black text-success" id="stat-codes-used">89</p>
                                <p class="text-[10px] text-slate-400 font-bold mt-1">Codes utilis√©s</p>
                            </div>
                            <div class="text-center p-4 bg-white/5 rounded-xl">
                                <p class="text-3xl font-black text-warning" id="stat-conversion">36%</p>
                                <p class="text-[10px] text-slate-400 font-bold mt-1">Taux conversion</p>
                            </div>
                            <div class="text-center p-4 bg-white/5 rounded-xl">
                                <p class="text-3xl font-black text-white" id="stat-revenue">1 780‚Ç¨</p>
                                <p class="text-[10px] text-slate-400 font-bold mt-1">CA g√©n√©r√©</p>
                            </div>
                        </div>
                    </div>

                    <!-- Concurrents Radar (Bient√¥t disponible) -->
                    <div class="glass-card p-5 md:p-6 rounded-2xl border-warning/10 opacity-60">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-bold text-white flex items-center">
                                <span class="w-8 h-8 rounded-lg bg-warning/10 flex items-center justify-center mr-3"><i class="fa-solid fa-binoculars text-warning text-sm"></i></span>
                                Concurrents Radar
                            </h3>
                            <span class="text-[10px] font-bold text-amber-400 bg-amber-400/10 px-3 py-1 rounded-full animate-pulse"><i class="fa-solid fa-clock mr-1"></i> Bient√¥t disponible</span>
                        </div>
                        <p class="text-xs text-slate-400">Analysez automatiquement les avis de vos concurrents gr√¢ce √† l'API Google Places. Cette fonctionnalit√© sera disponible dans une prochaine mise √† jour.</p>
                    </div>
                </div>
            </div>

            <!-- CONTENU : TRIAGE (MESSAGERIE) -->
            <div id="tab-triage" class="hidden">
                <div class="space-y-6 max-w-7xl mx-auto">
                    <div>
                        <div class="flex items-center justify-between flex-wrap gap-3">
                            <div>
                                <h2 class="text-2xl md:text-3xl font-extrabold text-white">Hub Messagerie</h2>
                                <p class="text-sm text-slate-400 mt-1">G√©rez et r√©pondez √† tous vos avis depuis un seul endroit</p>
                            </div>
                            <button onclick="openManualReviewModal()" class="px-4 py-2.5 bg-brand/20 text-brand-light border border-brand/30 rounded-xl text-xs font-bold hover:bg-brand/30 transition-all flex items-center gap-2">
                                <i class="fa-solid fa-plus"></i> Ajouter un avis manuellement
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 min-h-[500px]">
                        <!-- Messages List -->
                        <div class="glass-card rounded-2xl flex flex-col overflow-hidden">
                            <div class="p-4 border-b border-white/5 bg-slate-800/30">
                                <div class="flex items-center gap-2 overflow-x-auto pb-1" role="tablist" aria-label="Filtrer par plateforme">
                                    <button onclick="setFilter('all')" id="filter-all" role="tab" aria-selected="true" class="px-3 py-1.5 bg-white/10 text-white text-xs font-bold rounded-lg cursor-pointer transition-all whitespace-nowrap">Tous (4)</button>
                                    <button onclick="setFilter('google')" id="filter-google" role="tab" aria-selected="false" class="px-3 py-1.5 text-slate-400 hover:text-white hover:bg-white/5 text-xs font-bold rounded-lg cursor-pointer transition-all whitespace-nowrap"><i class="fa-brands fa-google mr-1 text-google"></i> Google</button>
                                    <button onclick="setFilter('airbnb')" id="filter-airbnb" role="tab" aria-selected="false" class="px-3 py-1.5 text-slate-400 hover:text-white hover:bg-white/5 text-xs font-bold rounded-lg cursor-pointer transition-all whitespace-nowrap"><i class="fa-brands fa-airbnb mr-1 text-airbnb"></i> Airbnb</button>
                                    <button onclick="setFilter('thefork')" id="filter-thefork" role="tab" aria-selected="false" class="px-3 py-1.5 text-slate-400 hover:text-white hover:bg-white/5 text-xs font-bold rounded-lg cursor-pointer transition-all whitespace-nowrap"><i class="fa-solid fa-utensils mr-1 text-thefork"></i> TheFork</button>
                                    <button onclick="setFilter('booking')" id="filter-booking" role="tab" aria-selected="false" class="px-3 py-1.5 text-slate-400 hover:text-white hover:bg-white/5 text-xs font-bold rounded-lg cursor-pointer transition-all whitespace-nowrap"><i class="fa-solid fa-hotel mr-1 text-[#003580]"></i> Booking</button>
                                    <button onclick="setFilter('tripadvisor')" id="filter-tripadvisor" role="tab" aria-selected="false" class="px-3 py-1.5 text-slate-400 hover:text-white hover:bg-white/5 text-xs font-bold rounded-lg cursor-pointer transition-all whitespace-nowrap"><i class="fa-solid fa-map-location-dot mr-1 text-tripadvisor"></i> TripAdvisor</button>
                                    <button onclick="setFilter('trustpilot')" id="filter-trustpilot" role="tab" aria-selected="false" class="px-3 py-1.5 text-slate-400 hover:text-white hover:bg-white/5 text-xs font-bold rounded-lg cursor-pointer transition-all whitespace-nowrap"><i class="fa-solid fa-star mr-1 text-trustpilot"></i> Trustpilot</button>
                                    <button onclick="setFilter('facebook')" id="filter-facebook" role="tab" aria-selected="false" class="px-3 py-1.5 text-slate-400 hover:text-white hover:bg-white/5 text-xs font-bold rounded-lg cursor-pointer transition-all whitespace-nowrap"><i class="fa-brands fa-facebook mr-1 text-facebook"></i> Facebook</button>
                                    <button onclick="setFilter('instagram')" id="filter-instagram" role="tab" aria-selected="false" class="px-3 py-1.5 text-slate-400 hover:text-white hover:bg-white/5 text-xs font-bold rounded-lg cursor-pointer transition-all whitespace-nowrap"><i class="fa-brands fa-instagram mr-1 text-instagram"></i> Instagram</button>
                                    <button onclick="setFilter('expedia')" id="filter-expedia" role="tab" aria-selected="false" class="px-3 py-1.5 text-slate-400 hover:text-white hover:bg-white/5 text-xs font-bold rounded-lg cursor-pointer transition-all whitespace-nowrap"><i class="fa-solid fa-plane mr-1 text-[#00008C]"></i> Expedia</button>
                                </div>
                            </div>
                            <div class="flex-1 p-3 space-y-2 overflow-y-auto" id="message-list-container" role="tabpanel"></div>
                        </div>

                        <!-- AI Response Panel -->
                        <div class="glass-card rounded-2xl flex flex-col p-4 md:p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold text-white flex items-center">
                                    <span class="w-8 h-8 rounded-lg bg-brand/10 flex items-center justify-center mr-2"><i class="fa-solid fa-robot text-brand text-sm"></i></span>
                                    Assistant IA
                                </h3>
                                <button onclick="regenerateDraft()" class="text-xs bg-slate-800 text-white px-3 py-1.5 rounded-lg hover:bg-slate-700 transition-all flex items-center gap-1.5" aria-label="R√©g√©n√©rer le brouillon">
                                    <i class="fa-solid fa-rotate-right"></i> R√©g√©n√©rer
                                </button>
                            </div>

                            <!-- Auto-pilot toggle -->
                            <div class="mb-4 bg-slate-900/80 p-3.5 rounded-xl border border-white/10 flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="w-9 h-9 rounded-lg bg-gradient-to-br from-brand/20 to-brand/10 flex items-center justify-center mr-3">
                                        <i class="fa-solid fa-bolt text-brand"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm font-bold text-white leading-tight">Pilote Automatique</p>
                                        <p class="text-[10px] text-slate-400">L'IA r√©pond et publie seule</p>
                                    </div>
                                </div>
                                <div class="relative inline-block w-12 align-middle select-none">
                                    <input type="checkbox" id="auto-pilot-toggle" onchange="toggleAutoPilot()" role="switch" aria-checked="false" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer z-10 left-0 border-slate-600 transition-all duration-300" aria-label="Activer le pilote automatique"/>
                                    <label for="auto-pilot-toggle" class="toggle-label block overflow-hidden h-6 rounded-full cursor-pointer bg-slate-600 transition-colors duration-300"></label>
                                </div>
                            </div>

                            <!-- Win-back selector -->
                            <div class="mb-4 bg-slate-800/40 p-4 rounded-xl border border-white/10 transition-all" id="winback-container">
                                <label for="winback-selector" class="block text-xs font-bold text-brand-light uppercase tracking-widest mb-2">
                                    <i class="fa-solid fa-gift mr-1"></i> Compensation Win-Back
                                </label>
                                <p class="text-[10px] text-slate-400 mb-3">L'IA g√©n√©rera un code unique √† pr√©senter en caisse.</p>
                                <select id="winback-selector" onchange="regenerateDraft()" class="w-full bg-slate-900 border border-white/10 rounded-lg p-3 text-white text-sm focus:border-brand focus:ring-2 focus:ring-brand/20 outline-none cursor-pointer transition-all" style="color-scheme: dark;"></select>
                            </div>

                            <!-- AI Tone selector -->
                            <div class="mb-3 flex items-center gap-2 flex-wrap">
                                <span class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mr-1">Ton :</span>
                                <button onclick="setAiTone('professional')" id="tone-professional" class="tone-btn px-2.5 py-1 rounded-lg text-[10px] font-bold transition-all bg-brand/20 text-brand-light border border-brand/30">üé© Pro</button>
                                <button onclick="setAiTone('casual')" id="tone-casual" class="tone-btn px-2.5 py-1 rounded-lg text-[10px] font-bold transition-all bg-white/5 text-slate-400 border border-white/10 hover:bg-white/10">üòé D√©contract√©</button>
                                <button onclick="setAiTone('warm')" id="tone-warm" class="tone-btn px-2.5 py-1 rounded-lg text-[10px] font-bold transition-all bg-white/5 text-slate-400 border border-white/10 hover:bg-white/10">ü§ó Chaleureux</button>
                                <button onclick="setAiTone('humor')" id="tone-humor" class="tone-btn px-2.5 py-1 rounded-lg text-[10px] font-bold transition-all bg-white/5 text-slate-400 border border-white/10 hover:bg-white/10">üòÑ Humour</button>
                            </div>

                            <!-- Quick templates -->
                            <div class="mb-3 flex items-center gap-2">
                                <span class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mr-1">Style :</span>
                                <button onclick="applyTemplate('short')" class="px-2.5 py-1 rounded-lg text-[10px] font-bold bg-white/5 text-slate-400 border border-white/10 hover:bg-white/10 transition-all"><i class="fa-solid fa-compress mr-1"></i> Court</button>
                                <button onclick="applyTemplate('formal')" class="px-2.5 py-1 rounded-lg text-[10px] font-bold bg-white/5 text-slate-400 border border-white/10 hover:bg-white/10 transition-all"><i class="fa-solid fa-briefcase mr-1"></i> Formel</button>
                                <button onclick="applyTemplate('emoji')" class="px-2.5 py-1 rounded-lg text-[10px] font-bold bg-white/5 text-slate-400 border border-white/10 hover:bg-white/10 transition-all"><i class="fa-solid fa-face-smile mr-1"></i> Emojis</button>
                            </div>

                            <!-- Draft textarea -->
                            <label for="ai-draft-textarea" class="sr-only">Brouillon IA</label>
                            <textarea id="ai-draft-textarea" class="flex-1 w-full bg-slate-900/50 border border-white/10 rounded-xl p-4 text-sm text-white resize-none focus:outline-none focus:border-brand focus:ring-2 focus:ring-brand/20 shadow-inner leading-relaxed transition-all min-h-[200px]" spellcheck="false" placeholder="L'IA g√©n√®re votre r√©ponse..."></textarea>

                            <!-- Copier + Publier -->
                            <div class="flex gap-2 mt-4">
                                <button onclick="copyAIResponse()" class="flex-1 py-3.5 rounded-xl font-bold text-sm bg-slate-800 text-white border border-white/10 hover:bg-slate-700 transition-all flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-copy"></i> Copier la r√©ponse
                                </button>
                                <button id="publish-action-btn" onclick="publishAIResponse()" class="flex-1 btn-primary py-3.5 flex justify-center items-center relative overflow-hidden">
                                    <span>Publier <i class="fa-solid fa-paper-plane ml-2"></i></span>
                                </button>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- CONTENU : INTEGRATIONS -->
            <div id="tab-integrations" class="hidden">
                <div class="space-y-8 max-w-7xl mx-auto">

                    <!-- Header -->
                    <div>
                        <h2 class="text-2xl md:text-3xl font-extrabold text-white">Int√©grations Omni-Canal</h2>
                        <p class="text-sm text-slate-400 mt-1">Connectez toutes vos plateformes d'avis ‚Äî API directe, extension Chrome ou copier-coller</p>
                    </div>

                    <!-- ===== BANNI√àRE EXTENSION CHROME ===== -->
                    <div class="relative overflow-hidden rounded-2xl bg-gradient-to-r from-brand/20 to-brand-darker/20 border border-brand/30 p-6 md:p-8">
                        <div class="flex flex-col md:flex-row items-center gap-6">
                            <div class="w-16 h-16 bg-white/10 rounded-2xl flex items-center justify-center flex-shrink-0">
                                <i class="fa-brands fa-chrome text-3xl text-white"></i>
                            </div>
                            <div class="flex-1 text-center md:text-left">
                                <h3 class="text-lg font-extrabold text-white mb-1">Extension Chrome Repward</h3>
                                <p class="text-sm text-brand-light font-bold mb-2">Couvre 5 plateformes d'un coup : Airbnb, Booking, TripAdvisor, TheFork, Expedia</p>
                                <p class="text-xs text-slate-300">L'extension d&eacute;tecte automatiquement vos avis et injecte un bouton <strong class="text-white">R&eacute;pondre avec IA</strong> directement sur chaque plateforme.</p>
                            </div>
                            <button disabled class="flex-shrink-0 px-6 py-3 bg-white/20 text-white/70 rounded-xl font-black text-sm cursor-not-allowed flex items-center gap-2 border border-white/10" onclick="showToast('En d√©veloppement', 'Extension Chrome en d√©veloppement interne', 'info')">
                                <i class="fa-solid fa-clock"></i> Bient√¥t disponible ‚Äî Enterprise
                            </button>
                        </div>
                        <div class="absolute -top-10 -right-10 w-40 h-40 bg-brand/10 rounded-full blur-3xl"></div>
                    </div>

                    <!-- ===== SECTION 1 : CONNEXION DIRECTE API ===== -->
                    <div>
                        <h3 class="text-sm font-bold text-white mb-1 flex items-center gap-2">
                            <span class="w-5 h-5 rounded-md bg-success/20 flex items-center justify-center"><span class="w-2 h-2 bg-success rounded-full"></span></span>
                            Connexion directe API
                        </h3>
                        <p class="text-xs text-slate-400 mb-4">Lecture + R&eacute;ponse automatique &mdash; Repward g&egrave;re tout pour vous</p>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

                            <!-- Google Business -->
                            <div class="glass-card p-5 rounded-2xl border-l-4 border-l-google space-y-3">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 bg-google/10 rounded-xl flex items-center justify-center"><i class="fa-brands fa-google text-lg text-google"></i></div>
                                        <div>
                                            <p class="font-bold text-sm text-white">Google Business</p>
                                            <p class="text-[10px] text-slate-400">OAuth 2.0 &mdash; Avis Google Maps</p>
                                        </div>
                                    </div>
                                    <span id="google-status" class="bg-slate-700 text-slate-400 text-[10px] font-bold px-2.5 py-1 rounded-lg">Non connect&eacute;</span>
                                </div>
                                <p class="text-[10px] text-slate-300">Cliquez &laquo; Se connecter &raquo; &rarr; autorisez l'acc&egrave;s &rarr; vos avis Google se synchronisent automatiquement.</p>
                                <button onclick="connectPlatformOAuth('google')" class="w-full py-2.5 bg-google/20 text-google border border-google/30 rounded-xl text-xs font-bold hover:bg-google/30 transition-all flex items-center justify-center gap-2">
                                    <i class="fa-brands fa-google"></i> Se connecter avec Google
                                </button>
                            </div>

                            <!-- Trustpilot -->
                            <div class="glass-card p-5 rounded-2xl border-l-4 border-l-trustpilot space-y-3">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 bg-trustpilot/10 rounded-xl flex items-center justify-center"><i class="fa-solid fa-star text-lg text-trustpilot"></i></div>
                                        <div>
                                            <p class="font-bold text-sm text-white">Trustpilot</p>
                                            <p class="text-[10px] text-slate-400">OAuth 2.0 &mdash; Avis v&eacute;rifi&eacute;s</p>
                                        </div>
                                    </div>
                                    <span id="trustpilot-status" class="bg-slate-700 text-slate-400 text-[10px] font-bold px-2.5 py-1 rounded-lg">Non connect&eacute;</span>
                                </div>
                                <p class="text-[10px] text-slate-300">N&eacute;cessite un compte Trustpilot Business (~199&euro;/mois). Autorisez Repward &rarr; lecture + r&eacute;ponse automatique.</p>
                                <button onclick="connectPlatformOAuth('trustpilot')" class="w-full py-2.5 bg-trustpilot/20 text-trustpilot border border-trustpilot/30 rounded-xl text-xs font-bold hover:bg-trustpilot/30 transition-all flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-star"></i> Connecter Trustpilot
                                </button>
                            </div>

                            <!-- Facebook -->
                            <div class="glass-card p-5 rounded-2xl border-l-4 border-l-facebook space-y-3">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 bg-facebook/10 rounded-xl flex items-center justify-center"><i class="fa-brands fa-facebook text-lg text-facebook"></i></div>
                                        <div>
                                            <p class="font-bold text-sm text-white">Facebook</p>
                                            <p class="text-[10px] text-slate-400">OAuth 2.0 via Meta &mdash; Pages</p>
                                        </div>
                                    </div>
                                    <span id="facebook-status" class="bg-slate-700 text-slate-400 text-[10px] font-bold px-2.5 py-1 rounded-lg">Non connect&eacute;</span>
                                </div>
                                <p class="text-[10px] text-slate-300">Connectez votre Page Facebook &rarr; Repward lit les recommandations et r&eacute;pond automatiquement.</p>
                                <button onclick="connectPlatformOAuth('facebook')" class="w-full py-2.5 bg-facebook/20 text-facebook border border-facebook/30 rounded-xl text-xs font-bold hover:bg-facebook/30 transition-all flex items-center justify-center gap-2">
                                    <i class="fa-brands fa-facebook"></i> Se connecter avec Facebook
                                </button>
                            </div>

                            <!-- Instagram -->
                            <div class="glass-card p-5 rounded-2xl border-l-4 border-l-instagram space-y-3">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 bg-instagram/10 rounded-xl flex items-center justify-center"><i class="fa-brands fa-instagram text-lg text-instagram"></i></div>
                                        <div>
                                            <p class="font-bold text-sm text-white">Instagram</p>
                                            <p class="text-[10px] text-slate-400">Via Facebook Business &mdash; Commentaires</p>
                                        </div>
                                    </div>
                                    <span id="instagram-status" class="bg-slate-700 text-slate-400 text-[10px] font-bold px-2.5 py-1 rounded-lg">Non connect&eacute;</span>
                                </div>
                                <p class="text-[10px] text-slate-300"><strong class="text-warning-light">Connectez d'abord Facebook</strong> ci-dessus. Instagram est activ&eacute; automatiquement via le m&ecirc;me OAuth Meta.</p>
                                <button disabled class="w-full py-2.5 bg-slate-800 text-slate-500 border border-white/5 rounded-xl text-xs font-bold cursor-not-allowed flex items-center justify-center gap-2">
                                    <i class="fa-brands fa-instagram"></i> Activ&eacute; via Facebook
                                </button>
                            </div>

                        </div>
                    </div>

                    <!-- ===== SECTION 2 : VIA EXTENSION CHROME (Bient√¥t) ===== -->
                    <div class="relative">
                        <h3 class="text-sm font-bold text-white mb-1 flex items-center gap-2">
                            <span class="w-5 h-5 rounded-md bg-brand/20 flex items-center justify-center"><span class="w-2 h-2 bg-brand rounded-full"></span></span>
                            Via Extension Chrome
                            <span class="text-[9px] font-bold text-amber-400 bg-amber-400/10 px-2 py-0.5 rounded-full animate-pulse"><i class="fa-solid fa-clock mr-1"></i>Bient√¥t</span>
                        </h3>
                        <p class="text-xs text-slate-400 mb-4">L'IA vous assistera directement sur le site &mdash; L'extension est en cours de d√©veloppement</p>

                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">

                            <!-- Airbnb -->
                            <div class="glass-card p-5 rounded-2xl space-y-3">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-airbnb/10 rounded-xl flex items-center justify-center"><i class="fa-brands fa-airbnb text-lg text-airbnb"></i></div>
                                    <div>
                                        <p class="font-bold text-sm text-white">Airbnb</p>
                                        <p class="text-[10px] text-slate-400">Locations & Exp&eacute;riences</p>
                                    </div>
                                </div>
                                <div class="bg-slate-900/60 rounded-xl p-3 space-y-1.5">
                                    <p class="text-[10px] text-slate-300"><i class="fa-solid fa-arrow-right text-brand mr-1"></i> Allez sur <span class="text-white font-bold">airbnb.com/hosting/reviews</span></p>
                                    <p class="text-[10px] text-slate-300"><i class="fa-solid fa-wand-magic-sparkles text-brand mr-1"></i> Le bouton Repward appara&icirc;t automatiquement</p>
                                </div>
                                <p class="text-[10px] text-slate-500 flex items-center gap-1.5"><span class="w-1.5 h-1.5 bg-warning rounded-full"></span> Publication imm&eacute;diate, pas de mod&eacute;ration. D&eacute;lai r&eacute;ponse ~30 jours.</p>
                            </div>

                            <!-- Booking -->
                            <div class="glass-card p-5 rounded-2xl space-y-3">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-[#003580]/10 rounded-xl flex items-center justify-center"><i class="fa-solid fa-hotel text-lg text-[#003580]"></i></div>
                                    <div>
                                        <p class="font-bold text-sm text-white">Booking.com</p>
                                        <p class="text-[10px] text-slate-400">H&eacute;bergements</p>
                                    </div>
                                </div>
                                <div class="bg-slate-900/60 rounded-xl p-3 space-y-1.5">
                                    <p class="text-[10px] text-slate-300"><i class="fa-solid fa-arrow-right text-brand mr-1"></i> Allez sur <span class="text-white font-bold">admin.booking.com</span> &rarr; Guest Reviews</p>
                                    <p class="text-[10px] text-slate-300"><i class="fa-solid fa-copy text-brand mr-1"></i> Copiez la r&eacute;ponse IA g&eacute;n&eacute;r&eacute;e et collez-la directement</p>
                                </div>
                                <p class="text-[10px] text-amber-400/80 flex items-center gap-1.5"><i class="fa-solid fa-triangle-exclamation text-[8px]"></i> R&eacute;ponse manuelle uniquement (copier-coller). Pas d'API officielle disponible.</p>
                                <p class="text-[10px] text-slate-500 flex items-center gap-1.5"><span class="w-1.5 h-1.5 bg-blue-400 rounded-full"></span> Mod&eacute;ration Booking 24-72h. R&eacute;ponse en langue de l'avis ou anglais uniquement.</p>
                            </div>

                            <!-- TripAdvisor -->
                            <div class="glass-card p-5 rounded-2xl space-y-3">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-tripadvisor/10 rounded-xl flex items-center justify-center"><i class="fa-solid fa-map-location-dot text-lg text-tripadvisor"></i></div>
                                    <div>
                                        <p class="font-bold text-sm text-white">TripAdvisor</p>
                                        <p class="text-[10px] text-slate-400">Voyages & H&ocirc;tels</p>
                                    </div>
                                </div>
                                <div class="bg-slate-900/60 rounded-xl p-3 space-y-1.5">
                                    <p class="text-[10px] text-slate-300"><i class="fa-solid fa-arrow-right text-brand mr-1"></i> Allez sur <span class="text-white font-bold">tripadvisor.com/Owners</span></p>
                                    <p class="text-[10px] text-slate-300"><i class="fa-solid fa-copy text-brand mr-1"></i> Copiez la r&eacute;ponse IA g&eacute;n&eacute;r&eacute;e et collez-la directement</p>
                                </div>
                                <p class="text-[10px] text-amber-400/80 flex items-center gap-1.5"><i class="fa-solid fa-triangle-exclamation text-[8px]"></i> R&eacute;ponse manuelle uniquement (copier-coller). Aucune API officielle pour r&eacute;pondre.</p>
                            </div>

                            <!-- TheFork -->
                            <div class="glass-card p-5 rounded-2xl space-y-3">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-thefork/10 rounded-xl flex items-center justify-center"><i class="fa-solid fa-utensils text-lg text-thefork"></i></div>
                                    <div>
                                        <p class="font-bold text-sm text-white">TheFork</p>
                                        <p class="text-[10px] text-slate-400">R&eacute;servations resto</p>
                                    </div>
                                </div>
                                <div class="bg-slate-900/60 rounded-xl p-3 space-y-1.5">
                                    <p class="text-[10px] text-slate-300"><i class="fa-solid fa-arrow-right text-brand mr-1"></i> Allez sur <span class="text-white font-bold">manager.thefork.com</span></p>
                                    <p class="text-[10px] text-slate-300"><i class="fa-solid fa-copy text-brand mr-1"></i> Copiez la r&eacute;ponse IA g&eacute;n&eacute;r&eacute;e et collez-la sur manager.thefork.com</p>
                                </div>
                                <p class="text-[10px] text-amber-400/80 flex items-center gap-1.5"><i class="fa-solid fa-triangle-exclamation text-[8px]"></i> R&eacute;ponse manuelle uniquement (copier-coller). Aucune API. Droit de r&eacute;ponse limit&eacute; &agrave; 3 mois.</p>
                            </div>

                            <!-- Expedia -->
                            <div class="glass-card p-5 rounded-2xl space-y-3">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-[#00008C]/10 rounded-xl flex items-center justify-center"><i class="fa-solid fa-plane text-lg text-[#00008C]"></i></div>
                                    <div>
                                        <p class="font-bold text-sm text-white">Expedia</p>
                                        <p class="text-[10px] text-slate-400">Voyages & S&eacute;jours</p>
                                    </div>
                                </div>
                                <div class="bg-slate-900/60 rounded-xl p-3 space-y-1.5">
                                    <p class="text-[10px] text-slate-300"><i class="fa-solid fa-arrow-right text-brand mr-1"></i> Allez sur <span class="text-white font-bold">partner.expedia.com</span></p>
                                    <p class="text-[10px] text-slate-300"><i class="fa-solid fa-copy text-brand mr-1"></i> Copiez la r&eacute;ponse IA g&eacute;n&eacute;r&eacute;e et collez-la sur partner.expedia.com</p>
                                </div>
                                <p class="text-[10px] text-amber-400/80 flex items-center gap-1.5"><i class="fa-solid fa-triangle-exclamation text-[8px]"></i> R&eacute;ponse manuelle uniquement (copier-coller). Aucune API officielle disponible.</p>
                            </div>

                        </div>
                    </div>

                    <!-- ===== SECTION 3 : M√âTHODE MANUELLE ===== -->
                    <div>
                        <h3 class="text-sm font-bold text-white mb-1 flex items-center gap-2">
                            <span class="w-5 h-5 rounded-md bg-warning/20 flex items-center justify-center"><span class="w-2 h-2 bg-warning rounded-full"></span></span>
                            M&eacute;thode Manuelle
                        </h3>
                        <p class="text-xs text-slate-400 mb-4">Toujours disponible, pour n'importe quelle plateforme</p>

                        <div class="glass-card p-5 rounded-2xl flex flex-col sm:flex-row items-center gap-4">
                            <div class="w-12 h-12 bg-warning/10 rounded-xl flex items-center justify-center flex-shrink-0">
                                <i class="fa-solid fa-paste text-xl text-warning"></i>
                            </div>
                            <div class="flex-1 text-center sm:text-left">
                                <p class="text-sm font-bold text-white mb-1">Copiez-collez un avis depuis n'importe quelle plateforme</p>
                                <p class="text-[10px] text-slate-400">Utilisez le bouton <strong class="text-white">&laquo; + Ajouter un avis manuellement &raquo;</strong> dans le Hub Messagerie. L'IA g&eacute;n&egrave;re la r&eacute;ponse instantan&eacute;ment.</p>
                            </div>
                            <button onclick="switchTab('triage'); setTimeout(() => openManualReviewModal(), 300);" class="flex-shrink-0 px-5 py-2.5 bg-warning/20 text-warning border border-warning/30 rounded-xl text-xs font-bold hover:bg-warning/30 transition-all">
                                <i class="fa-solid fa-plus mr-1"></i> Ajouter un avis
                            </button>
                        </div>
                    </div>

                </div>
            </div>

            <!-- CONTENU : HISTORIQUE DES R√âPONSES -->
            <div id="tab-history" class="hidden">
                <div class="space-y-6 max-w-5xl mx-auto">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                        <div>
                            <h2 class="text-2xl md:text-3xl font-extrabold text-white">Historique des R√©ponses</h2>
                            <p class="text-sm text-slate-400 mt-1">Toutes vos r√©ponses publi√©es</p>
                        </div>
                        <div class="flex gap-2">
                            <input id="history-search" type="text" oninput="renderHistory()" placeholder="Rechercher..." class="bg-slate-800 border border-white/10 rounded-xl px-4 py-2 text-sm text-white focus:border-brand outline-none w-48">
                            <button onclick="exportHistoryPDF()" class="px-4 py-2 bg-danger/20 text-danger border border-danger/30 rounded-xl text-xs font-bold hover:bg-danger/30 transition-all">
                                <i class="fa-solid fa-file-pdf mr-1"></i> PDF
                            </button>
                        </div>
                    </div>
                    <div id="history-list" class="space-y-3">
                    </div>
                </div>
            </div>

            <!-- CONTENU : PARAM√àTRES & FACTURATION -->
            <div id="tab-settings" class="hidden">
                <div class="space-y-6 max-w-5xl mx-auto">
                    <div>
                        <h2 class="text-2xl md:text-3xl font-extrabold text-white">Mon Compte Pro</h2>
                        <p class="text-sm text-slate-400 mt-1">G√©rez votre √©tablissement et votre abonnement</p>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Account info -->
                        <div class="glass-card p-6 rounded-2xl space-y-5">
                            <h3 class="font-bold text-lg text-white flex items-center">
                                <span class="w-8 h-8 rounded-lg bg-brand/10 flex items-center justify-center mr-3"><i class="fa-solid fa-building text-brand text-sm"></i></span>
                                √âtablissement
                            </h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="input-nom-etab" class="block text-xs font-bold text-slate-400 mb-1.5 uppercase tracking-wider">Nom</label>
                                    <input id="input-nom-etab" type="text" class="w-full bg-slate-900/50 border border-white/10 rounded-xl p-3.5 text-white focus:border-brand focus:ring-2 focus:ring-brand/20 outline-none transition-all" value="Mon Commerce">
                                </div>
                                <div>
                                    <label for="input-email-etab" class="block text-xs font-bold text-slate-400 mb-1.5 uppercase tracking-wider">Email</label>
                                    <input id="input-email-etab" type="email" class="w-full bg-slate-900/50 border border-white/10 rounded-xl p-3.5 text-white focus:border-brand focus:ring-2 focus:ring-brand/20 outline-none transition-all" value="contact@moncommerce.com">
                                </div>
                                <div>
                                    <label for="input-tel-etab" class="block text-xs font-bold text-slate-400 mb-1.5 uppercase tracking-wider">T√©l√©phone</label>
                                    <input id="input-tel-etab" type="tel" class="w-full bg-slate-900/50 border border-white/10 rounded-xl p-3.5 text-white focus:border-brand focus:ring-2 focus:ring-brand/20 outline-none transition-all" value="+33 1 23 45 67 89" placeholder="+33 ...">
                                </div>
                            </div>
                            <button onclick="saveAccountSettings()" class="btn-primary w-full" id="btn-save-account">
                                <i class="fa-solid fa-floppy-disk mr-2"></i> Sauvegarder
                            </button>

                            <!-- Google Maps Deep-Link -->
                            <div class="pt-4 border-t border-white/5">
                                <label for="input-gmaps-url" class="block text-xs font-bold text-slate-400 mb-1.5 uppercase tracking-wider">
                                    <i class="fa-brands fa-google text-google mr-1"></i> Lien Google Maps
                                </label>
                                <p class="text-[10px] text-slate-500 mb-2">Les clients 5‚òÖ seront redirig√©s vers votre fiche Google</p>
                                <div class="flex gap-2">
                                    <input id="input-gmaps-url" type="url" class="flex-1 bg-slate-900/50 border border-white/10 rounded-xl p-3 text-white text-sm focus:border-google focus:ring-2 focus:ring-google/20 outline-none transition-all" placeholder="https://g.page/mon-commerce/review">
                                    <button onclick="saveGoogleMapsUrl()" class="px-4 bg-google/20 text-google border border-google/30 rounded-xl font-bold text-xs hover:bg-google/30 transition-all">
                                        <i class="fa-solid fa-floppy-disk"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Google Business Profile Connection -->
                            <div class="pt-4 border-t border-white/5">
                                <h4 class="text-sm font-bold text-white mb-3 flex items-center gap-2">
                                    <i class="fa-brands fa-google text-google"></i> Google Business Profile
                                </h4>
                                <div id="google-not-connected" class="">
                                    <p class="text-xs text-slate-300 mb-3">Connectez votre Google pour que Repward r√©ponde automatiquement √† tous vos avis Google.</p>
                                    <button onclick="initGoogleOAuth()" class="w-full py-2.5 rounded-lg bg-google hover:bg-google/90 text-white font-semibold flex items-center justify-center gap-2 transition-all text-sm">
                                        <i class="fa-brands fa-google"></i> Connecter Google
                                    </button>
                                </div>
                                <div id="google-connected" class="hidden">
                                    <div class="flex items-center gap-2 text-success mb-2">
                                        <i class="fa-solid fa-check-circle"></i>
                                        <span class="text-xs font-medium">Connect√©</span>
                                    </div>
                                    <p class="text-xs text-slate-300 mb-2" id="google-business-name"></p>
                                    <div class="flex gap-2">
                                        <button onclick="fetchGoogleReviews()" class="flex-1 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-white text-xs transition-all">
                                            <i class="fa-solid fa-sync mr-1"></i> Sync avis
                                        </button>
                                        <button onclick="disconnectGoogle()" class="py-2 px-3 rounded-lg bg-danger/20 hover:bg-danger/30 text-danger-light text-xs transition-all">
                                            <i class="fa-solid fa-unlink"></i>
                                        </button>
                                    </div>
                                </div>
                                <div id="google-no-gbp" class="hidden">
                                    <div class="bg-warning/10 border border-warning/30 rounded-lg p-3 mb-3">
                                        <div class="flex items-center gap-2 text-warning mb-1">
                                            <i class="fa-solid fa-exclamation-triangle"></i>
                                            <span class="text-xs font-semibold">Aucune fiche Google trouv√©e</span>
                                        </div>
                                        <p class="text-[10px] text-slate-300">Votre compte Google n'a pas de fiche Google Business Profile. C'est gratuit et indispensable pour recevoir des avis.</p>
                                    </div>
                                    <a href="https://business.google.com/create" target="_blank" class="block w-full py-2 rounded-lg bg-warning hover:bg-warning/90 text-slate-900 font-semibold text-center text-sm transition-all">
                                        <i class="fa-solid fa-plus mr-1"></i> Cr√©er ma fiche Google
                                    </a>
                                </div>
                            </div>

                            <!-- IA Status -->
                            <div class="pt-4 border-t border-white/5">
                                <div class="flex items-center gap-2 p-3 bg-success/10 border border-success/20 rounded-xl">
                                    <span class="w-7 h-7 rounded-lg bg-success/20 flex items-center justify-center"><i class="fa-solid fa-robot text-success text-xs"></i></span>
                                    <div>
                                        <span class="text-xs font-bold text-success flex items-center gap-1.5">
                                            <span class="w-2 h-2 bg-success rounded-full animate-pulse"></span>
                                            IA Gemini connect√©e
                                        </span>
                                        <p class="text-[10px] text-slate-400 mt-0.5">R√©ponses automatiques incluses dans votre abonnement</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Subscription Plans -->
                        <div class="rounded-2xl border border-white/10 overflow-hidden">
                            <div class="p-5 bg-gradient-to-r from-brand/20 to-brand-darker/20 border-b border-white/10">
                                <h3 class="font-extrabold text-lg text-white flex items-center gap-2">
                                    <i class="fa-solid fa-crown text-yellow-400"></i> Abonnements Repward
                                </h3>
                                <p class="text-xs text-slate-400 mt-1">Choisissez le plan adapt√© √† votre activit√©</p>
                            </div>
                            <div id="subscription-plans-grid" class="p-4 space-y-3"></div>
                            <div class="p-4 pt-0">
                                <p class="text-[10px] text-slate-500 text-center">Sans engagement ¬∑ Annulable √† tout moment ¬∑ Paiement s√©curis√© Stripe</p>
                            </div>
                        </div>

                    <!-- Multi-√©tablissements (Plan Illimit√©) -->
                    <div class="glass-card p-6 rounded-2xl border-yellow-500/20">
                        <h3 class="font-bold text-lg text-white flex items-center mb-2">
                            <span class="w-8 h-8 rounded-lg bg-yellow-500/10 flex items-center justify-center mr-3"><i class="fa-solid fa-building-columns text-yellow-400 text-sm"></i></span>
                            Multi-√âtablissements
                            <span class="ml-auto text-[10px] font-bold text-yellow-400 bg-yellow-500/10 px-3 py-1 rounded-full">Plan Illimit√©</span>
                        </h3>
                        <p class="text-xs text-slate-400 mb-4">G√©rez tous vos √©tablissements depuis un seul compte. 99,90‚Ç¨ pour le 1er site, +50‚Ç¨ par site suppl√©mentaire.</p>
                        <div class="flex items-center gap-4 mb-4">
                            <label class="text-sm font-bold text-white">Nombre de sites :</label>
                            <input id="multi-sites-slider" type="range" min="1" max="50" value="1" oninput="updateMultiSites()" class="flex-1 accent-yellow-400">
                            <span id="multi-sites-count" class="text-2xl font-black text-yellow-400 w-12 text-center">1</span>
                        </div>
                        <div class="flex items-center justify-between bg-slate-900/50 rounded-xl p-4">
                            <div>
                                <p class="text-sm font-bold text-white">Total mensuel</p>
                                <p class="text-[10px] text-slate-400">Facturation unique Stripe</p>
                            </div>
                            <p class="text-2xl font-black text-yellow-400" id="multi-sites-price">99,90‚Ç¨</p>
                        </div>
                        <div id="multi-sites-list" class="mt-4 space-y-2"></div>
                        <button onclick="addEstablishment()" class="mt-4 w-full py-3 rounded-xl font-bold text-sm bg-yellow-500/20 text-yellow-400 border border-yellow-500/30 hover:bg-yellow-500/30 transition-all">
                            <i class="fa-solid fa-plus mr-2"></i> Ajouter un √©tablissement
                        </button>
                    </div>

                    <!-- Alertes SMS/Email -->
                    <div class="glass-card p-6 rounded-2xl">
                        <h3 class="font-bold text-lg text-white flex items-center mb-4">
                            <span class="w-8 h-8 rounded-lg bg-danger/10 flex items-center justify-center mr-3"><i class="fa-solid fa-bell text-danger text-sm"></i></span>
                            Alertes Instantan√©es
                        </h3>
                        <p class="text-xs text-slate-400 mb-4">Recevez une alerte d√®s qu'un avis n√©gatif (1‚òÖ ou 2‚òÖ) est publi√©</p>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between p-4 bg-slate-900/50 rounded-xl">
                                <div class="flex items-center gap-3">
                                    <i class="fa-solid fa-envelope text-brand text-lg"></i>
                                    <div>
                                        <p class="text-sm font-bold text-white">Alertes Email</p>
                                        <p class="text-[10px] text-slate-400">Notification imm√©diate par email</p>
                                    </div>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="alert-email-toggle" class="sr-only peer" checked onchange="saveAlertPrefs()">
                                    <div class="w-11 h-6 bg-slate-700 peer-focus:ring-2 peer-focus:ring-brand/30 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand"></div>
                                </label>
                            </div>
                            <div class="flex items-center justify-between p-4 bg-slate-900/50 rounded-xl">
                                <div class="flex items-center gap-3">
                                    <i class="fa-solid fa-comment-sms text-success text-lg"></i>
                                    <div>
                                        <p class="text-sm font-bold text-white">Alertes SMS</p>
                                        <p class="text-[10px] text-slate-400">SMS instantan√© sur votre mobile</p>
                                    </div>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="alert-sms-toggle" class="sr-only peer" onchange="saveAlertPrefs()">
                                    <div class="w-11 h-6 bg-slate-700 peer-focus:ring-2 peer-focus:ring-success/30 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-success"></div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- FOMO Bubble Toggle -->
                    <div class="glass-card p-6 rounded-2xl">
                        <h3 class="font-bold text-lg text-white flex items-center mb-4">
                            <span class="w-8 h-8 rounded-lg bg-success/10 flex items-center justify-center mr-3"><i class="fa-solid fa-bell text-success text-sm"></i></span>
                            Notifications FOMO
                        </h3>
                        <p class="text-xs text-slate-400 mb-4">Affichage de bulles de preuve sociale pour cr√©er un effet de manque</p>
                        <div class="flex items-center justify-between p-4 bg-slate-900/50 rounded-xl">
                            <div>
                                <p class="text-sm font-bold text-white">Bulles sociales actives</p>
                                <p class="text-[10px] text-slate-400">Les clients verront les actions d'autres</p>
                            </div>
                            <div class="relative inline-block w-12 align-middle select-none">
                                <input type="checkbox" id="fomo-toggle" onchange="toggleFomoSetting()" checked class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer z-10 left-0 border-slate-600 transition-all duration-300"/>
                                <label for="fomo-toggle" class="toggle-label block overflow-hidden h-6 rounded-full cursor-pointer bg-success transition-colors duration-300"></label>
                            </div>
                        </div>
                    </div>

                    <!-- Widget int√©grable -->
                    <div class="glass-card p-6 rounded-2xl">
                        <h3 class="font-bold text-lg text-white flex items-center mb-4">
                            <span class="w-8 h-8 rounded-lg bg-brand/10 flex items-center justify-center mr-3"><i class="fa-solid fa-code text-brand text-sm"></i></span>
                            Widget Site Web
                        </h3>
                        <p class="text-xs text-slate-400 mb-4">Affichez votre r√©putation en direct sur votre site web</p>
                        <div class="bg-white/5 rounded-xl p-4 mb-4">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="flex items-center bg-white rounded-lg px-3 py-2 shadow-sm">
                                    <span class="text-yellow-500 text-lg mr-1.5">‚òÖ</span>
                                    <span class="text-slate-900 font-black text-lg">4.8</span>
                                    <span class="text-slate-400 text-xs ml-1.5">¬∑ 84 avis Google</span>
                                </div>
                                <span class="text-[10px] text-slate-500">Aper√ßu du widget</span>
                            </div>
                        </div>
                        <div class="relative">
                            <textarea id="widget-code" readonly class="w-full bg-slate-900 border border-white/10 rounded-xl p-4 text-[11px] font-mono text-green-400 h-24 resize-none" onclick="this.select()"></textarea>
                            <button onclick="copyWidgetCode()" class="absolute top-2 right-2 px-3 py-1.5 bg-brand/20 text-brand-light rounded-lg text-[10px] font-bold hover:bg-brand/30 transition-all">
                                <i class="fa-solid fa-copy mr-1"></i> Copier
                            </button>
                        </div>
                    </div>

                    <!-- API Publique -->
                    <div class="glass-card p-6 rounded-2xl border-brand/20">
                        <h3 class="font-bold text-lg text-white flex items-center mb-2">
                            <span class="w-8 h-8 rounded-lg bg-brand/10 flex items-center justify-center mr-3"><i class="fa-solid fa-terminal text-brand text-sm"></i></span>
                            API Publique Repward
                            <span class="ml-auto text-[10px] font-bold text-brand-light bg-brand/10 px-3 py-1 rounded-full">Enterprise</span>
                        </h3>
                        <p class="text-xs text-slate-400 mb-4">Connectez Repward √† votre CRM, POS ou outil interne via notre API REST</p>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-4">
                            <div class="bg-white/5 rounded-xl p-3 text-center">
                                <p class="text-lg font-black text-brand-light">REST</p>
                                <p class="text-[10px] text-slate-400">JSON endpoints</p>
                            </div>
                            <div class="bg-white/5 rounded-xl p-3 text-center">
                                <p class="text-lg font-black text-brand-light">OAuth2</p>
                                <p class="text-[10px] text-slate-400">Auth s√©curis√©e</p>
                            </div>
                            <div class="bg-white/5 rounded-xl p-3 text-center">
                                <p class="text-lg font-black text-brand-light">Webhooks</p>
                                <p class="text-[10px] text-slate-400">Events temps r√©el</p>
                            </div>
                        </div>
                        <button disabled class="w-full py-3 rounded-xl font-bold text-sm bg-white/5 text-slate-500 border border-white/10 cursor-not-allowed opacity-60">
                            <i class="fa-solid fa-book mr-2"></i> Documentation API <span class="ml-2 text-[9px] bg-warning/10 text-warning px-2 py-0.5 rounded-full">Bient√¥t ‚Äî Enterprise</span>
                        </button>
                    </div>

                    </div>
                </div>
            </div>

            <!-- CONTENU : ROUE DE LA FORTUNE -->
            <div id="tab-fortune" class="hidden">
                <div class="space-y-6 max-w-7xl mx-auto">
                    <div>
                        <h2 class="text-2xl md:text-3xl font-extrabold text-white">üé∞ Roue de la Fortune</h2>
                        <p class="text-sm text-slate-400 mt-1">Engagez vos clients avec une exp√©rience ludique et m√©morable</p>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Wheel Display -->
                        <div class="lg:col-span-2">
                            <div class="glass-card p-8 rounded-2xl">
                                <h3 class="font-bold text-white mb-6 flex items-center">
                                    <span class="w-8 h-8 rounded-lg bg-brand/10 flex items-center justify-center mr-3"><i class="fa-solid fa-circle-notch text-brand text-sm"></i></span>
                                    Aper√ßu de la roue
                                </h3>
                                <div class="flex flex-col items-center gap-8">
                                    <div class="wheel-wrapper">
                                        <div class="wheel-pointer"></div>
                                        <div class="wheel-container">
                                            <canvas id="wheel-canvas" class="wheel-canvas"></canvas>
                                        </div>
                                    </div>
                                    <button id="spin-wheel-btn" onclick="spinWheel()" class="wheel-btn px-8 py-3.5 rounded-xl text-white font-bold transition-all">
                                        <i class="fa-solid fa-play mr-2"></i> Tester la roue
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Settings -->
                        <div class="space-y-4">
                            <!-- Enable/Disable -->
                            <div class="glass-card p-5 rounded-2xl">
                                <h4 class="font-bold text-white mb-3 flex items-center">
                                    <i class="fa-solid fa-toggle-on text-brand mr-2"></i> Activation
                                </h4>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-slate-300">Roue active</span>
                                    <div class="relative inline-block w-12 align-middle select-none">
                                        <input type="checkbox" id="fortune-toggle" onchange="toggleFortune()" checked class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer z-10 left-0 border-slate-600 transition-all duration-300"/>
                                        <label for="fortune-toggle" class="toggle-label block overflow-hidden h-6 rounded-full cursor-pointer bg-success transition-colors duration-300"></label>
                                    </div>
                                </div>
                            </div>

                            <!-- Segments Configuration -->
                            <div class="glass-card p-5 rounded-2xl">
                                <h4 class="font-bold text-white mb-3 flex items-center justify-between">
                                    <span><i class="fa-solid fa-gift text-brand mr-2"></i> R√©compenses</span>
                                    <button onclick="addSegment()" class="text-[10px] bg-brand/20 text-brand-light border border-brand/30 px-2.5 py-1 rounded-lg hover:bg-brand/30 transition-all font-bold">
                                        <i class="fa-solid fa-plus mr-1"></i> Ajouter
                                    </button>
                                </h4>
                                <div class="space-y-1.5 max-h-[300px] overflow-y-auto" id="wheel-segments-list"></div>
                                <div class="mt-3 pt-3 border-t border-white/10">
                                    <p class="text-[10px] text-slate-500"><i class="fa-solid fa-lightbulb text-amber-500 mr-1"></i> Cliquez sur un texte pour le modifier. Max 12 segments.</p>
                                </div>
                            </div>

                            <!-- Colors -->
                            <div class="glass-card p-5 rounded-2xl">
                                <h4 class="font-bold text-white mb-3 flex items-center">
                                    <i class="fa-solid fa-palette text-brand mr-2"></i> Couleurs
                                </h4>
                                <div class="space-y-2">
                                    <div class="flex gap-2">
                                        <input type="color" id="wheel-color-1" value="#818cf8" onchange="updateWheelColors()" class="w-10 h-10 rounded cursor-pointer">
                                        <input type="color" id="wheel-color-2" value="#10b981" onchange="updateWheelColors()" class="w-10 h-10 rounded cursor-pointer">
                                        <input type="color" id="wheel-color-3" value="#f59e0b" onchange="updateWheelColors()" class="w-10 h-10 rounded cursor-pointer">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CONTENU : √âQUIPE (LEADERBOARD) -->
            <div id="tab-team" class="hidden">
                <div class="space-y-6 max-w-7xl mx-auto">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                        <div>
                            <h2 class="text-2xl md:text-3xl font-extrabold text-white">üèÜ √âquipe & Leaderboard</h2>
                            <p class="text-sm text-slate-400 mt-1">G√©rez votre √©quipe et visualisez les performances mensuelles</p>
                        </div>
                        <button onclick="openAddEmployeeModal()" class="px-4 py-2.5 bg-brand/20 text-brand-light border border-brand/30 rounded-xl text-xs font-bold hover:bg-brand/30 transition-all flex items-center gap-2">
                            <i class="fa-solid fa-plus"></i> Ajouter un employ√©
                        </button>
                    </div>

                    <!-- Podium -->
                    <div class="glass-card p-8 rounded-2xl">
                        <h3 class="font-bold text-white mb-6 flex items-center">
                            <span class="w-8 h-8 rounded-lg bg-warning/10 flex items-center justify-center mr-3"><i class="fa-solid fa-medal text-warning text-sm"></i></span>
                            Classement du mois
                        </h3>
                        <div class="podium" id="podium-container"></div>
                    </div>

                    <!-- Employees List -->
                    <div class="glass-card p-6 rounded-2xl">
                        <h3 class="font-bold text-white mb-4 flex items-center">
                            <span class="w-8 h-8 rounded-lg bg-brand/10 flex items-center justify-center mr-3"><i class="fa-solid fa-users text-brand text-sm"></i></span>
                            Tous les employ√©s
                        </h3>
                        <div class="space-y-3" id="employees-list"></div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Mobile Bottom Nav -->
        <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-slate-900/95 backdrop-blur-xl border-t border-white/10 flex justify-around py-2 pb-[max(0.5rem,env(safe-area-inset-bottom))] z-50 no-print overflow-x-auto" aria-label="Navigation mobile">
            <button onclick="switchTab('portal')" id="nav-portal-mob" class="nav-item flex flex-col items-center py-1 px-2 text-slate-500 min-w-[3rem]" aria-label="QR Code">
                <i class="fa-solid fa-qrcode text-lg mb-0.5"></i><span class="text-[10px] font-bold">QR</span>
            </button>
            <button onclick="switchTab('triage')" id="nav-triage-mob" class="nav-item flex flex-col items-center py-1 px-2 text-slate-500 min-w-[3rem] relative" aria-label="Messagerie">
                <i class="fa-solid fa-inbox text-lg mb-0.5"></i>
                <span class="absolute top-0 right-1 w-4 h-4 bg-danger rounded-full text-[8px] font-bold flex items-center justify-center text-white">3</span>
                <span class="text-[10px] font-bold">Avis</span>
            </button>
            <button onclick="switchTab('analytics')" id="nav-analytics-mob" class="nav-item flex flex-col items-center py-1 px-2 text-slate-500 min-w-[3rem]" aria-label="Analyses">
                <i class="fa-solid fa-chart-line text-lg mb-0.5"></i><span class="text-[10px] font-bold">Stats</span>
            </button>
            <button onclick="switchTab('fortune')" id="nav-fortune-mob" class="nav-item flex flex-col items-center py-1 px-2 text-slate-500 min-w-[3rem]" aria-label="Roue">
                <i class="fa-solid fa-circle-notch text-lg mb-0.5"></i><span class="text-[10px] font-bold">Roue</span>
            </button>
            <button onclick="switchTab('team')" id="nav-team-mob" class="nav-item flex flex-col items-center py-1 px-2 text-slate-500 min-w-[3rem]" aria-label="√âquipe">
                <i class="fa-solid fa-users text-lg mb-0.5"></i><span class="text-[10px] font-bold">√âquipe</span>
            </button>
            <button onclick="switchTab('integrations')" id="nav-integrations-mob" class="nav-item flex flex-col items-center py-1 px-2 text-slate-500 min-w-[3rem]" aria-label="Int√©grations">
                <i class="fa-solid fa-plug text-lg mb-0.5"></i><span class="text-[10px] font-bold">Int√©g.</span>
            </button>
            <button onclick="switchTab('settings')" id="nav-settings-mob" class="nav-item flex flex-col items-center py-1 px-2 text-slate-500 min-w-[3rem]" aria-label="Param√®tres">
                <i class="fa-solid fa-gear text-lg mb-0.5"></i><span class="text-[10px] font-bold">Pro</span>
            </button>
        </nav>
    </div>
    </div>

    <!-- ========================================== -->
    <!-- VUE CLIENT (MOBILE SCAN)                   -->
    <!-- ========================================== -->
    <div id="view-customer" class="app-view view-hidden flex items-center justify-center h-[100dvh] w-full px-4">
        <div class="iphone-frame iphone-frame-customer w-full max-w-[390px] h-[90dvh] md:h-[750px] shadow-2xl">
            <div class="iphone-notch hidden md:block"></div>
            <div class="iphone-screen bg-slate-50" id="app-customer-container">
            </div>
        </div>
    </div>

    <script>
    // ============================================
    // SECURITY: HTML ESCAPE FUNCTION
    // ============================================
    function escapeHtml(str) {
        if (!str) return '';
        return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
    }

    // ============================================
    // i18n ‚Äî INTERNATIONALIZATION (8 LANGUAGES)
    // ============================================
    let currentLang = 'fr';

    const i18n = {
        fr: {
            // Onboarding
            welcomeTitle: 'Bienvenue sur Repward',
            welcomeSubtitle: 'Choisissez votre langue',
            step1of2: '√âtape 1/2',
            step2of2: '√âtape 2/2',
            createAccount: 'Cr√©ez votre compte',
            personalInfo: 'Vos informations personnelles',
            fullName: 'Nom complet',
            proEmail: 'Email professionnel',
            password: 'Mot de passe',
            minChars: 'Min. 6 caract√®res',
            continue: 'Continuer',
            yourBusiness: 'Votre commerce',
            businessInfo: 'Informations sur votre √©tablissement',
            businessName: 'Nom de l\'√©tablissement',
            businessType: 'Type de commerce',
            phoneOptional: 'T√©l√©phone (optionnel)',
            promoOptional: 'Code promo (optionnel)',
            validate: 'Valider',
            launchRepward: 'Lancer Repward',
            back: 'Retour',
            freeReg: 'Inscription gratuite ¬∑ Aucune carte requise',
            fillAll: 'Veuillez remplir tous les champs',
            minPassword: 'Le mot de passe doit faire au moins 6 caract√®res',
            invalidEmail: 'Veuillez entrer un email valide',
            enterBusiness: 'Veuillez entrer le nom de votre √©tablissement',
            invalidCode: 'Code invalide',
            demoActivated: 'activ√©e !',
            appliedStripe: 'Appliqu√© au paiement Stripe',
            // Dashboard ‚Äî Sidebar
            qrRewards: 'QR Code & R√©compenses',
            qrSubtitle: 'Configurez votre syst√®me de collecte d\'avis',
            businessTypeLabel: 'Type de commerce',
            aiAdapts: 'L\'IA s\'adapte automatiquement √† votre secteur',
            rewardClient: 'R√©compense client (adapt√©e aux √©toiles)',
            chooseGift: 'Choisissez le cadeau √† offrir √† vos clients',
            generateQR: 'G√©n√©rer le QR Code',
            downloadPNG: 'T√©l√©charger en PNG',
            livePreview: 'Aper√ßu en temps r√©el',
            // Dashboard ‚Äî Nav
            navQR: 'QR',
            navReviews: 'Avis',
            navStats: 'Stats',
            navPlugs: 'Plugs',
            navPro: 'Pro',
            // Dashboard ‚Äî Triage
            inbox: 'Bo√Æte de r√©ception',
            inboxSub: 'G√©rez vos avis clients en un seul endroit',
            all: 'Tous',
            pending: 'En attente',
            treated: 'Trait√©s',
            critical: 'Critiques',
            aiDraft: 'Brouillon IA',
            winback: 'Offre Win-Back',
            regenerate: 'R√©g√©n√©rer',
            publishResponse: 'Publier la r√©ponse',
            autoPilot: 'Auto-Pilot',
            autoPilotDesc: 'R√©ponses automatiques pour les avis 4-5‚òÖ',
            // Dashboard ‚Äî Analytics
            analyticsTitle: 'Analytics',
            analyticsSub: 'Donn√©es et performance de vos avis',
            reviewsCollected: 'Avis collect√©s',
            timeSaved: 'Temps gagn√©',
            estimatedROI: 'ROI estim√©',
            aiInsights: 'Insights IA',
            // Dashboard ‚Äî Settings
            settingsTitle: 'Param√®tres',
            settingsSub: 'Configuration de votre compte',
            accountInfo: 'Informations du compte',
            save: 'Sauvegarder',
            aiConnected: 'IA Gemini connect√©e',
            aiIncluded: 'R√©ponses automatiques incluses dans votre abonnement',
            subscriptions: 'Abonnements Repward',
            choosePlan: 'Choisissez le plan adapt√© √† votre activit√©',
            currentPlan: 'Plan actuel',
            subscribe: 'Souscrire',
            popular: 'Populaire',
            noCommit: 'Sans engagement ¬∑ Annulable √† tout moment ¬∑ Paiement s√©curis√© Stripe',
            // Customer view
            thanksVisit: 'Merci pour votre visite !',
            instantGift: 'Cadeau Imm√©diat',
            leave5Stars: 'Laissez-nous 5 √©toiles pour<br>d√©bloquer votre cadeau',
            reviewHelps: 'Votre avis nous aide !',
            tapStars: 'Touchez les √©toiles pour nous noter',
            selectStars: 'S√©lectionnez vos √©toiles',
            publishGoogle: 'Publier sur Google',
            rate4Min: 'Notez 4‚òÖ minimum',
            thanksForFeedback: 'Merci pour votre avis',
            sorry: 'Nous sommes d√©sol√©s',
            helpUnderstand: 'Aidez-nous √† comprendre pour<br>mieux vous servir',
            bravo5Star: 'üéâ Bravo ! Votre cadeau VIP<br>est d√©bloqu√© !',
            thanksSmall: 'Merci ! Un petit geste<br>pour vous remercier',
            feedbackHelps: 'Votre avis nous aide √† nous am√©liorer',
            leaveComment: 'Laissez-nous un commentaire',
            thanksReview: 'Merci !',
            reviewMatters: 'Votre avis compte √©norm√©ment pour nous',
            yourGift: 'Votre Cadeau',
            codeToShow: 'Code √† pr√©senter',
            showCode: 'Pr√©sentez ce code √† l\'√©quipe lors de votre prochaine visite',
            returnBack: 'Retour',
            // Demo
            demoMode: 'Mode D√©mo',
            minRemaining: 'min restantes',
            subscribePlan: 'Souscrire un plan',
            demoExpired: 'D√©mo expir√©e',
            chooseSubToContinue: 'Choisissez un abonnement pour continuer',
            // Misc
            welcome: 'Bienvenue !',
            accountCreated: 'Votre compte Repward est cr√©√©',
            demoActivatedFull: 'Mode D√©mo activ√© !',
            fullAccess: 'Acc√®s complet pendant',
            min: 'min',
            planChanged: 'Plan modifi√©',
            qrGenerated: 'QR Code g√©n√©r√©',
            readyDownload: 'Pr√™t √† t√©l√©charger',
            error: 'Erreur',
            qrError: 'Impossible de g√©n√©rer le QR code',
            // Integrations
            integrationsTitle: 'Int√©grations',
            integrationsSub: 'Connectez vos plateformes d\'avis',
            comingSoon: 'Bient√¥t disponible',
            connected: 'Connect√©',
            connect: 'Connecter',
            merchantView: 'Vue Commer√ßant',
            customerView: 'Vue Client'
        },
        en: {
            welcomeTitle: 'Welcome to Repward',
            welcomeSubtitle: 'Choose your language',
            step1of2: 'Step 1/2', step2of2: 'Step 2/2',
            createAccount: 'Create your account', personalInfo: 'Your personal information',
            fullName: 'Full name', proEmail: 'Professional email', password: 'Password', minChars: 'Min. 6 characters',
            continue: 'Continue', yourBusiness: 'Your business', businessInfo: 'Information about your establishment',
            businessName: 'Business name', businessType: 'Business type', phoneOptional: 'Phone (optional)',
            promoOptional: 'Promo code (optional)', validate: 'Validate', launchRepward: 'Launch Repward',
            back: 'Back', freeReg: 'Free registration ¬∑ No credit card required',
            fillAll: 'Please fill in all fields', minPassword: 'Password must be at least 6 characters',
            invalidEmail: 'Please enter a valid email', enterBusiness: 'Please enter your business name',
            invalidCode: 'Invalid code', demoActivated: 'activated!', appliedStripe: 'Applied at Stripe checkout',
            qrRewards: 'QR Code & Rewards', qrSubtitle: 'Configure your review collection system',
            businessTypeLabel: 'Business type', aiAdapts: 'AI automatically adapts to your industry',
            rewardClient: 'Customer reward (adapted to stars)', chooseGift: 'Choose the gift for your customers',
            generateQR: 'Generate QR Code', downloadPNG: 'Download as PNG', livePreview: 'Live preview',
            navQR: 'QR', navReviews: 'Reviews', navStats: 'Stats', navPlugs: 'Plugs', navPro: 'Pro',
            inbox: 'Inbox', inboxSub: 'Manage your customer reviews in one place',
            all: 'All', pending: 'Pending', treated: 'Treated', critical: 'Critical',
            aiDraft: 'AI Draft', winback: 'Win-Back Offer', regenerate: 'Regenerate',
            publishResponse: 'Publish response', autoPilot: 'Auto-Pilot',
            autoPilotDesc: 'Automatic responses for 4-5‚òÖ reviews',
            analyticsTitle: 'Analytics', analyticsSub: 'Data and performance of your reviews',
            reviewsCollected: 'Reviews collected', timeSaved: 'Time saved', estimatedROI: 'Estimated ROI',
            aiInsights: 'AI Insights',
            settingsTitle: 'Settings', settingsSub: 'Account configuration',
            accountInfo: 'Account information', save: 'Save',
            aiConnected: 'Gemini AI connected', aiIncluded: 'Automatic responses included in your subscription',
            subscriptions: 'Repward Subscriptions', choosePlan: 'Choose the plan for your business',
            currentPlan: 'Current plan', subscribe: 'Subscribe', popular: 'Popular',
            noCommit: 'No commitment ¬∑ Cancel anytime ¬∑ Secure Stripe payment',
            thanksVisit: 'Thanks for your visit!', instantGift: 'Instant Gift',
            leave5Stars: 'Leave us 5 stars to<br>unlock your gift',
            reviewHelps: 'Your review helps us!', tapStars: 'Tap the stars to rate us',
            selectStars: 'Select your stars', publishGoogle: 'Publish on Google',
            rate4Min: 'Rate 4‚òÖ minimum', thanksForFeedback: 'Thanks for your feedback',
            sorry: 'We\'re sorry', helpUnderstand: 'Help us understand to<br>serve you better',
            bravo5Star: 'üéâ Bravo! Your VIP gift<br>is unlocked!',
            thanksSmall: 'Thanks! A small gesture<br>to thank you',
            feedbackHelps: 'Your feedback helps us improve', leaveComment: 'Leave us a comment',
            thanksReview: 'Thank you!', reviewMatters: 'Your review means a lot to us',
            yourGift: 'Your Gift', codeToShow: 'Code to present',
            showCode: 'Show this code to the team on your next visit', returnBack: 'Back',
            demoMode: 'Demo Mode', minRemaining: 'min remaining', subscribePlan: 'Subscribe to a plan',
            demoExpired: 'Demo expired', chooseSubToContinue: 'Choose a subscription to continue',
            welcome: 'Welcome!', accountCreated: 'Your Repward account is created',
            demoActivatedFull: 'Demo Mode activated!', fullAccess: 'Full access for', min: 'min',
            planChanged: 'Plan changed', qrGenerated: 'QR Code generated', readyDownload: 'Ready to download',
            error: 'Error', qrError: 'Unable to generate QR code',
            integrationsTitle: 'Integrations', integrationsSub: 'Connect your review platforms',
            comingSoon: 'Coming soon', connected: 'Connected', connect: 'Connect',
            merchantView: 'Merchant View', customerView: 'Customer View'
        },
        es: {
            welcomeTitle: 'Bienvenido a Repward', welcomeSubtitle: 'Elige tu idioma',
            step1of2: 'Paso 1/2', step2of2: 'Paso 2/2',
            createAccount: 'Crea tu cuenta', personalInfo: 'Tu informaci√≥n personal',
            fullName: 'Nombre completo', proEmail: 'Email profesional', password: 'Contrase√±a', minChars: 'M√≠n. 6 caracteres',
            continue: 'Continuar', yourBusiness: 'Tu negocio', businessInfo: 'Informaci√≥n de tu establecimiento',
            businessName: 'Nombre del negocio', businessType: 'Tipo de negocio', phoneOptional: 'Tel√©fono (opcional)',
            promoOptional: 'C√≥digo promo (opcional)', validate: 'Validar', launchRepward: 'Lanzar Repward',
            back: 'Volver', freeReg: 'Registro gratuito ¬∑ Sin tarjeta de cr√©dito',
            fillAll: 'Por favor complete todos los campos', minPassword: 'La contrase√±a debe tener al menos 6 caracteres',
            invalidEmail: 'Ingrese un email v√°lido', enterBusiness: 'Ingrese el nombre de su negocio',
            invalidCode: 'C√≥digo inv√°lido', demoActivated: '¬°activada!', appliedStripe: 'Aplicado en el pago Stripe',
            qrRewards: 'QR Code y Recompensas', qrSubtitle: 'Configure su sistema de recolecci√≥n de rese√±as',
            businessTypeLabel: 'Tipo de negocio', aiAdapts: 'La IA se adapta autom√°ticamente a su sector',
            rewardClient: 'Recompensa cliente (adaptada a estrellas)', chooseGift: 'Elija el regalo para sus clientes',
            generateQR: 'Generar QR Code', downloadPNG: 'Descargar en PNG', livePreview: 'Vista previa en vivo',
            navQR: 'QR', navReviews: 'Rese√±as', navStats: 'Stats', navPlugs: 'Plugs', navPro: 'Pro',
            inbox: 'Bandeja de entrada', inboxSub: 'Gestione sus rese√±as en un solo lugar',
            all: 'Todos', pending: 'Pendientes', treated: 'Tratados', critical: 'Cr√≠ticos',
            aiDraft: 'Borrador IA', winback: 'Oferta Win-Back', regenerate: 'Regenerar',
            publishResponse: 'Publicar respuesta', autoPilot: 'Auto-Pilot',
            autoPilotDesc: 'Respuestas autom√°ticas para rese√±as 4-5‚òÖ',
            analyticsTitle: 'Anal√≠ticas', analyticsSub: 'Datos y rendimiento de sus rese√±as',
            reviewsCollected: 'Rese√±as recopiladas', timeSaved: 'Tiempo ahorrado', estimatedROI: 'ROI estimado',
            aiInsights: 'Insights IA',
            settingsTitle: 'Configuraci√≥n', settingsSub: 'Configuraci√≥n de su cuenta',
            accountInfo: 'Informaci√≥n de la cuenta', save: 'Guardar',
            aiConnected: 'IA Gemini conectada', aiIncluded: 'Respuestas autom√°ticas incluidas en su suscripci√≥n',
            subscriptions: 'Suscripciones Repward', choosePlan: 'Elija el plan para su negocio',
            currentPlan: 'Plan actual', subscribe: 'Suscribirse', popular: 'Popular',
            noCommit: 'Sin compromiso ¬∑ Cancelable en cualquier momento ¬∑ Pago seguro Stripe',
            thanksVisit: '¬°Gracias por su visita!', instantGift: 'Regalo Inmediato',
            leave5Stars: 'D√©jenos 5 estrellas para<br>desbloquear su regalo',
            reviewHelps: '¬°Su opini√≥n nos ayuda!', tapStars: 'Toque las estrellas para calificarnos',
            selectStars: 'Seleccione sus estrellas', publishGoogle: 'Publicar en Google',
            rate4Min: 'Califique 4‚òÖ m√≠nimo', thanksForFeedback: 'Gracias por su opini√≥n',
            sorry: 'Lo sentimos', helpUnderstand: 'Ay√∫denos a entender para<br>servirle mejor',
            bravo5Star: 'üéâ ¬°Bravo! Su regalo VIP<br>est√° desbloqueado!',
            thanksSmall: '¬°Gracias! Un peque√±o gesto<br>para agradecerle',
            feedbackHelps: 'Su opini√≥n nos ayuda a mejorar', leaveComment: 'D√©jenos un comentario',
            thanksReview: '¬°Gracias!', reviewMatters: 'Su opini√≥n significa mucho para nosotros',
            yourGift: 'Su Regalo', codeToShow: 'C√≥digo a presentar',
            showCode: 'Presente este c√≥digo al equipo en su pr√≥xima visita', returnBack: 'Volver',
            demoMode: 'Modo Demo', minRemaining: 'min restantes', subscribePlan: 'Suscribirse a un plan',
            demoExpired: 'Demo expirada', chooseSubToContinue: 'Elija una suscripci√≥n para continuar',
            welcome: '¬°Bienvenido!', accountCreated: 'Su cuenta Repward est√° creada',
            demoActivatedFull: '¬°Modo Demo activado!', fullAccess: 'Acceso completo durante', min: 'min',
            planChanged: 'Plan cambiado', qrGenerated: 'QR Code generado', readyDownload: 'Listo para descargar',
            error: 'Error', qrError: 'No se puede generar el QR code',
            integrationsTitle: 'Integraciones', integrationsSub: 'Conecte sus plataformas de rese√±as',
            comingSoon: 'Pr√≥ximamente', connected: 'Conectado', connect: 'Conectar',
            merchantView: 'Vista Comerciante', customerView: 'Vista Cliente'
        },
        it: {
            welcomeTitle: 'Benvenuto su Repward', welcomeSubtitle: 'Scegli la tua lingua',
            step1of2: 'Passo 1/2', step2of2: 'Passo 2/2',
            createAccount: 'Crea il tuo account', personalInfo: 'Le tue informazioni personali',
            fullName: 'Nome completo', proEmail: 'Email professionale', password: 'Password', minChars: 'Min. 6 caratteri',
            continue: 'Continua', yourBusiness: 'La tua attivit√†', businessInfo: 'Informazioni sul tuo locale',
            businessName: 'Nome del locale', businessType: 'Tipo di attivit√†', phoneOptional: 'Telefono (opzionale)',
            promoOptional: 'Codice promo (opzionale)', validate: 'Convalida', launchRepward: 'Avvia Repward',
            back: 'Indietro', freeReg: 'Registrazione gratuita ¬∑ Nessuna carta richiesta',
            fillAll: 'Compila tutti i campi', minPassword: 'La password deve avere almeno 6 caratteri',
            invalidEmail: 'Inserisci un email valido', enterBusiness: 'Inserisci il nome del tuo locale',
            invalidCode: 'Codice non valido', demoActivated: 'attivata!', appliedStripe: 'Applicato al pagamento Stripe',
            qrRewards: 'QR Code e Premi', qrSubtitle: 'Configura il tuo sistema di raccolta recensioni',
            businessTypeLabel: 'Tipo di attivit√†', aiAdapts: 'L\'IA si adatta automaticamente al tuo settore',
            rewardClient: 'Premio cliente (adattato alle stelle)', chooseGift: 'Scegli il regalo per i tuoi clienti',
            generateQR: 'Genera QR Code', downloadPNG: 'Scarica in PNG', livePreview: 'Anteprima dal vivo',
            navQR: 'QR', navReviews: 'Recensioni', navStats: 'Stats', navPlugs: 'Plugs', navPro: 'Pro',
            inbox: 'Posta in arrivo', inboxSub: 'Gestisci le recensioni dei clienti in un unico posto',
            all: 'Tutti', pending: 'In attesa', treated: 'Trattati', critical: 'Critici',
            aiDraft: 'Bozza IA', winback: 'Offerta Win-Back', regenerate: 'Rigenera',
            publishResponse: 'Pubblica risposta', autoPilot: 'Auto-Pilot',
            autoPilotDesc: 'Risposte automatiche per recensioni 4-5‚òÖ',
            analyticsTitle: 'Analisi', analyticsSub: 'Dati e performance delle recensioni',
            reviewsCollected: 'Recensioni raccolte', timeSaved: 'Tempo risparmiato', estimatedROI: 'ROI stimato',
            aiInsights: 'Insights IA',
            settingsTitle: 'Impostazioni', settingsSub: 'Configurazione del tuo account',
            accountInfo: 'Informazioni account', save: 'Salva',
            aiConnected: 'IA Gemini connessa', aiIncluded: 'Risposte automatiche incluse nel tuo abbonamento',
            subscriptions: 'Abbonamenti Repward', choosePlan: 'Scegli il piano per la tua attivit√†',
            currentPlan: 'Piano attuale', subscribe: 'Abbonati', popular: 'Popolare',
            noCommit: 'Senza impegno ¬∑ Annullabile in qualsiasi momento ¬∑ Pagamento sicuro Stripe',
            thanksVisit: 'Grazie per la tua visita!', instantGift: 'Regalo Immediato',
            leave5Stars: 'Lasciaci 5 stelle per<br>sbloccare il tuo regalo',
            reviewHelps: 'La tua opinione ci aiuta!', tapStars: 'Tocca le stelle per votarci',
            selectStars: 'Seleziona le tue stelle', publishGoogle: 'Pubblica su Google',
            rate4Min: 'Vota 4‚òÖ minimo', thanksForFeedback: 'Grazie per il tuo feedback',
            sorry: 'Ci dispiace', helpUnderstand: 'Aiutaci a capire per<br>servirti meglio',
            bravo5Star: 'üéâ Bravo! Il tuo regalo VIP<br>√® sbloccato!',
            thanksSmall: 'Grazie! Un piccolo gesto<br>per ringraziarti',
            feedbackHelps: 'Il tuo feedback ci aiuta a migliorare', leaveComment: 'Lasciaci un commento',
            thanksReview: 'Grazie!', reviewMatters: 'La tua opinione conta tantissimo per noi',
            yourGift: 'Il Tuo Regalo', codeToShow: 'Codice da presentare',
            showCode: 'Presenta questo codice al team alla tua prossima visita', returnBack: 'Indietro',
            demoMode: 'Modalit√† Demo', minRemaining: 'min rimanenti', subscribePlan: 'Abbonati a un piano',
            demoExpired: 'Demo scaduta', chooseSubToContinue: 'Scegli un abbonamento per continuare',
            welcome: 'Benvenuto!', accountCreated: 'Il tuo account Repward √® creato',
            demoActivatedFull: 'Modalit√† Demo attivata!', fullAccess: 'Accesso completo per', min: 'min',
            planChanged: 'Piano cambiato', qrGenerated: 'QR Code generato', readyDownload: 'Pronto per il download',
            error: 'Errore', qrError: 'Impossibile generare il QR code',
            integrationsTitle: 'Integrazioni', integrationsSub: 'Connetti le tue piattaforme di recensioni',
            comingSoon: 'Prossimamente', connected: 'Connesso', connect: 'Connetti',
            merchantView: 'Vista Commerciante', customerView: 'Vista Cliente'
        },
        de: {
            welcomeTitle: 'Willkommen bei Repward', welcomeSubtitle: 'W√§hlen Sie Ihre Sprache',
            step1of2: 'Schritt 1/2', step2of2: 'Schritt 2/2',
            createAccount: 'Konto erstellen', personalInfo: 'Ihre pers√∂nlichen Daten',
            fullName: 'Vollst√§ndiger Name', proEmail: 'Gesch√§ftliche E-Mail', password: 'Passwort', minChars: 'Min. 6 Zeichen',
            continue: 'Weiter', yourBusiness: 'Ihr Gesch√§ft', businessInfo: 'Informationen zu Ihrem Betrieb',
            businessName: 'Firmenname', businessType: 'Gesch√§ftstyp', phoneOptional: 'Telefon (optional)',
            promoOptional: 'Promo-Code (optional)', validate: 'Best√§tigen', launchRepward: 'Repward starten',
            back: 'Zur√ºck', freeReg: 'Kostenlose Registrierung ¬∑ Keine Kreditkarte erforderlich',
            fillAll: 'Bitte alle Felder ausf√ºllen', minPassword: 'Passwort muss mindestens 6 Zeichen haben',
            invalidEmail: 'Bitte g√ºltige E-Mail eingeben', enterBusiness: 'Bitte Firmennamen eingeben',
            invalidCode: 'Ung√ºltiger Code', demoActivated: 'aktiviert!', appliedStripe: 'Bei Stripe-Zahlung angewendet',
            qrRewards: 'QR-Code & Belohnungen', qrSubtitle: 'Konfigurieren Sie Ihr Bewertungssystem',
            businessTypeLabel: 'Gesch√§ftstyp', aiAdapts: 'KI passt sich automatisch an Ihre Branche an',
            rewardClient: 'Kundenbelohnung (sternangepasst)', chooseGift: 'W√§hlen Sie das Geschenk f√ºr Ihre Kunden',
            generateQR: 'QR-Code generieren', downloadPNG: 'Als PNG herunterladen', livePreview: 'Live-Vorschau',
            navQR: 'QR', navReviews: 'Bewertungen', navStats: 'Stats', navPlugs: 'Plugs', navPro: 'Pro',
            inbox: 'Posteingang', inboxSub: 'Verwalten Sie Kundenbewertungen an einem Ort',
            all: 'Alle', pending: 'Ausstehend', treated: 'Bearbeitet', critical: 'Kritisch',
            aiDraft: 'KI-Entwurf', winback: 'Win-Back-Angebot', regenerate: 'Regenerieren',
            publishResponse: 'Antwort ver√∂ffentlichen', autoPilot: 'Auto-Pilot',
            autoPilotDesc: 'Automatische Antworten f√ºr 4-5‚òÖ Bewertungen',
            analyticsTitle: 'Analysen', analyticsSub: 'Daten und Leistung Ihrer Bewertungen',
            reviewsCollected: 'Bewertungen gesammelt', timeSaved: 'Zeit gespart', estimatedROI: 'Gesch√§tzter ROI',
            aiInsights: 'KI-Insights',
            settingsTitle: 'Einstellungen', settingsSub: 'Kontokonfiguration',
            accountInfo: 'Kontoinformationen', save: 'Speichern',
            aiConnected: 'Gemini KI verbunden', aiIncluded: 'Automatische Antworten in Ihrem Abo enthalten',
            subscriptions: 'Repward Abonnements', choosePlan: 'W√§hlen Sie den Plan f√ºr Ihr Gesch√§ft',
            currentPlan: 'Aktueller Plan', subscribe: 'Abonnieren', popular: 'Beliebt',
            noCommit: 'Ohne Bindung ¬∑ Jederzeit k√ºndbar ¬∑ Sichere Stripe-Zahlung',
            thanksVisit: 'Danke f√ºr Ihren Besuch!', instantGift: 'Sofort-Geschenk',
            leave5Stars: 'Geben Sie uns 5 Sterne um<br>Ihr Geschenk freizuschalten',
            reviewHelps: 'Ihre Bewertung hilft uns!', tapStars: 'Tippen Sie auf die Sterne',
            selectStars: 'W√§hlen Sie Ihre Sterne', publishGoogle: 'Auf Google ver√∂ffentlichen',
            rate4Min: 'Mindestens 4‚òÖ bewerten', thanksForFeedback: 'Danke f√ºr Ihr Feedback',
            sorry: 'Es tut uns leid', helpUnderstand: 'Helfen Sie uns zu verstehen,<br>um Sie besser zu bedienen',
            bravo5Star: 'üéâ Bravo! Ihr VIP-Geschenk<br>ist freigeschaltet!',
            thanksSmall: 'Danke! Eine kleine Geste<br>um Ihnen zu danken',
            feedbackHelps: 'Ihr Feedback hilft uns, besser zu werden', leaveComment: 'Hinterlassen Sie einen Kommentar',
            thanksReview: 'Danke!', reviewMatters: 'Ihre Bewertung bedeutet uns sehr viel',
            yourGift: 'Ihr Geschenk', codeToShow: 'Code zum Vorzeigen',
            showCode: 'Zeigen Sie diesen Code dem Team bei Ihrem n√§chsten Besuch', returnBack: 'Zur√ºck',
            demoMode: 'Demo-Modus', minRemaining: 'Min. verbleibend', subscribePlan: 'Plan abonnieren',
            demoExpired: 'Demo abgelaufen', chooseSubToContinue: 'W√§hlen Sie ein Abo um fortzufahren',
            welcome: 'Willkommen!', accountCreated: 'Ihr Repward-Konto ist erstellt',
            demoActivatedFull: 'Demo-Modus aktiviert!', fullAccess: 'Voller Zugang f√ºr', min: 'Min.',
            planChanged: 'Plan ge√§ndert', qrGenerated: 'QR-Code generiert', readyDownload: 'Bereit zum Download',
            error: 'Fehler', qrError: 'QR-Code konnte nicht generiert werden',
            integrationsTitle: 'Integrationen', integrationsSub: 'Verbinden Sie Ihre Bewertungsplattformen',
            comingSoon: 'Demn√§chst', connected: 'Verbunden', connect: 'Verbinden',
            merchantView: 'H√§ndleransicht', customerView: 'Kundenansicht'
        },
        pt: {
            welcomeTitle: 'Bem-vindo ao Repward', welcomeSubtitle: 'Escolha o seu idioma',
            step1of2: 'Passo 1/2', step2of2: 'Passo 2/2',
            createAccount: 'Crie a sua conta', personalInfo: 'As suas informa√ß√µes pessoais',
            fullName: 'Nome completo', proEmail: 'Email profissional', password: 'Senha', minChars: 'M√≠n. 6 caracteres',
            continue: 'Continuar', yourBusiness: 'O seu neg√≥cio', businessInfo: 'Informa√ß√µes sobre o seu estabelecimento',
            businessName: 'Nome do estabelecimento', businessType: 'Tipo de neg√≥cio', phoneOptional: 'Telefone (opcional)',
            promoOptional: 'C√≥digo promo (opcional)', validate: 'Validar', launchRepward: 'Iniciar Repward',
            back: 'Voltar', freeReg: 'Registo gratuito ¬∑ Sem cart√£o de cr√©dito',
            fillAll: 'Preencha todos os campos', minPassword: 'A senha deve ter pelo menos 6 caracteres',
            invalidEmail: 'Introduza um email v√°lido', enterBusiness: 'Introduza o nome do seu neg√≥cio',
            invalidCode: 'C√≥digo inv√°lido', demoActivated: 'ativada!', appliedStripe: 'Aplicado no pagamento Stripe',
            qrRewards: 'QR Code e Recompensas', qrSubtitle: 'Configure o seu sistema de recolha de avalia√ß√µes',
            businessTypeLabel: 'Tipo de neg√≥cio', aiAdapts: 'A IA adapta-se automaticamente ao seu setor',
            rewardClient: 'Recompensa cliente (adaptada √†s estrelas)', chooseGift: 'Escolha o presente para os seus clientes',
            generateQR: 'Gerar QR Code', downloadPNG: 'Descarregar em PNG', livePreview: 'Pr√©-visualiza√ß√£o ao vivo',
            navQR: 'QR', navReviews: 'Avalia√ß√µes', navStats: 'Stats', navPlugs: 'Plugs', navPro: 'Pro',
            inbox: 'Caixa de entrada', inboxSub: 'Gerencie as avalia√ß√µes num √∫nico lugar',
            all: 'Todos', pending: 'Pendentes', treated: 'Tratados', critical: 'Cr√≠ticos',
            aiDraft: 'Rascunho IA', winback: 'Oferta Win-Back', regenerate: 'Regenerar',
            publishResponse: 'Publicar resposta', autoPilot: 'Auto-Pilot',
            autoPilotDesc: 'Respostas autom√°ticas para avalia√ß√µes 4-5‚òÖ',
            analyticsTitle: 'An√°lises', analyticsSub: 'Dados e desempenho das suas avalia√ß√µes',
            reviewsCollected: 'Avalia√ß√µes recolhidas', timeSaved: 'Tempo poupado', estimatedROI: 'ROI estimado',
            aiInsights: 'Insights IA',
            settingsTitle: 'Defini√ß√µes', settingsSub: 'Configura√ß√£o da sua conta',
            accountInfo: 'Informa√ß√µes da conta', save: 'Guardar',
            aiConnected: 'IA Gemini conectada', aiIncluded: 'Respostas autom√°ticas inclu√≠das na sua subscri√ß√£o',
            subscriptions: 'Subscri√ß√µes Repward', choosePlan: 'Escolha o plano para o seu neg√≥cio',
            currentPlan: 'Plano atual', subscribe: 'Subscrever', popular: 'Popular',
            noCommit: 'Sem compromisso ¬∑ Cancel√°vel a qualquer momento ¬∑ Pagamento seguro Stripe',
            thanksVisit: 'Obrigado pela sua visita!', instantGift: 'Presente Imediato',
            leave5Stars: 'Deixe-nos 5 estrelas para<br>desbloquear o seu presente',
            reviewHelps: 'A sua opini√£o ajuda-nos!', tapStars: 'Toque nas estrelas para nos avaliar',
            selectStars: 'Selecione as suas estrelas', publishGoogle: 'Publicar no Google',
            rate4Min: 'Avalie 4‚òÖ m√≠nimo', thanksForFeedback: 'Obrigado pelo seu feedback',
            sorry: 'Lamentamos', helpUnderstand: 'Ajude-nos a entender para<br>o servir melhor',
            bravo5Star: 'üéâ Bravo! O seu presente VIP<br>est√° desbloqueado!',
            thanksSmall: 'Obrigado! Um pequeno gesto<br>para lhe agradecer',
            feedbackHelps: 'O seu feedback ajuda-nos a melhorar', leaveComment: 'Deixe-nos um coment√°rio',
            thanksReview: 'Obrigado!', reviewMatters: 'A sua opini√£o significa muito para n√≥s',
            yourGift: 'O Seu Presente', codeToShow: 'C√≥digo a apresentar',
            showCode: 'Apresente este c√≥digo √† equipa na sua pr√≥xima visita', returnBack: 'Voltar',
            demoMode: 'Modo Demo', minRemaining: 'min restantes', subscribePlan: 'Subscrever um plano',
            demoExpired: 'Demo expirada', chooseSubToContinue: 'Escolha uma subscri√ß√£o para continuar',
            welcome: 'Bem-vindo!', accountCreated: 'A sua conta Repward est√° criada',
            demoActivatedFull: 'Modo Demo ativado!', fullAccess: 'Acesso completo durante', min: 'min',
            planChanged: 'Plano alterado', qrGenerated: 'QR Code gerado', readyDownload: 'Pronto para download',
            error: 'Erro', qrError: 'N√£o foi poss√≠vel gerar o QR code',
            integrationsTitle: 'Integra√ß√µes', integrationsSub: 'Conecte as suas plataformas de avalia√ß√µes',
            comingSoon: 'Em breve', connected: 'Conectado', connect: 'Conectar',
            merchantView: 'Vista Comerciante', customerView: 'Vista Cliente'
        },
        nl: {
            welcomeTitle: 'Welkom bij Repward', welcomeSubtitle: 'Kies uw taal',
            step1of2: 'Stap 1/2', step2of2: 'Stap 2/2',
            createAccount: 'Maak uw account aan', personalInfo: 'Uw persoonlijke gegevens',
            fullName: 'Volledige naam', proEmail: 'Zakelijke e-mail', password: 'Wachtwoord', minChars: 'Min. 6 tekens',
            continue: 'Doorgaan', yourBusiness: 'Uw bedrijf', businessInfo: 'Informatie over uw vestiging',
            businessName: 'Bedrijfsnaam', businessType: 'Type bedrijf', phoneOptional: 'Telefoon (optioneel)',
            promoOptional: 'Promotiecode (optioneel)', validate: 'Valideren', launchRepward: 'Repward starten',
            back: 'Terug', freeReg: 'Gratis registratie ¬∑ Geen creditcard nodig',
            fillAll: 'Vul alle velden in', minPassword: 'Wachtwoord moet minstens 6 tekens bevatten',
            invalidEmail: 'Voer een geldig e-mailadres in', enterBusiness: 'Voer uw bedrijfsnaam in',
            invalidCode: 'Ongeldige code', demoActivated: 'geactiveerd!', appliedStripe: 'Toegepast bij Stripe-betaling',
            qrRewards: 'QR-code & Beloningen', qrSubtitle: 'Configureer uw beoordelingssysteem',
            businessTypeLabel: 'Type bedrijf', aiAdapts: 'AI past zich automatisch aan uw sector aan',
            rewardClient: 'Klantbeloning (aangepast aan sterren)', chooseGift: 'Kies het cadeau voor uw klanten',
            generateQR: 'QR-code genereren', downloadPNG: 'Downloaden als PNG', livePreview: 'Live voorbeeld',
            navQR: 'QR', navReviews: 'Reviews', navStats: 'Stats', navPlugs: 'Plugs', navPro: 'Pro',
            inbox: 'Inbox', inboxSub: 'Beheer uw klantbeoordelingen op √©√©n plek',
            all: 'Alle', pending: 'Wachtend', treated: 'Behandeld', critical: 'Kritiek',
            aiDraft: 'AI-concept', winback: 'Win-Back-aanbieding', regenerate: 'Regenereren',
            publishResponse: 'Antwoord publiceren', autoPilot: 'Auto-Pilot',
            autoPilotDesc: 'Automatische antwoorden voor 4-5‚òÖ beoordelingen',
            analyticsTitle: 'Analyses', analyticsSub: 'Gegevens en prestaties van uw beoordelingen',
            reviewsCollected: 'Beoordelingen verzameld', timeSaved: 'Tijd bespaard', estimatedROI: 'Geschatte ROI',
            aiInsights: 'AI Insights',
            settingsTitle: 'Instellingen', settingsSub: 'Accountconfiguratie',
            accountInfo: 'Accountinformatie', save: 'Opslaan',
            aiConnected: 'Gemini AI verbonden', aiIncluded: 'Automatische antwoorden inbegrepen in uw abonnement',
            subscriptions: 'Repward Abonnementen', choosePlan: 'Kies het plan voor uw bedrijf',
            currentPlan: 'Huidig plan', subscribe: 'Abonneren', popular: 'Populair',
            noCommit: 'Zonder verplichtingen ¬∑ Op elk moment opzegbaar ¬∑ Veilige Stripe-betaling',
            thanksVisit: 'Bedankt voor uw bezoek!', instantGift: 'Direct Cadeau',
            leave5Stars: 'Geef ons 5 sterren om<br>uw cadeau te ontgrendelen',
            reviewHelps: 'Uw beoordeling helpt ons!', tapStars: 'Tik op de sterren om ons te beoordelen',
            selectStars: 'Selecteer uw sterren', publishGoogle: 'Publiceren op Google',
            rate4Min: 'Beoordeel minimaal 4‚òÖ', thanksForFeedback: 'Bedankt voor uw feedback',
            sorry: 'Het spijt ons', helpUnderstand: 'Help ons begrijpen om<br>u beter te bedienen',
            bravo5Star: 'üéâ Bravo! Uw VIP-cadeau<br>is ontgrendeld!',
            thanksSmall: 'Bedankt! Een klein gebaar<br>om u te bedanken',
            feedbackHelps: 'Uw feedback helpt ons verbeteren', leaveComment: 'Laat ons een opmerking achter',
            thanksReview: 'Bedankt!', reviewMatters: 'Uw beoordeling betekent veel voor ons',
            yourGift: 'Uw Cadeau', codeToShow: 'Code om te tonen',
            showCode: 'Toon deze code aan het team bij uw volgende bezoek', returnBack: 'Terug',
            demoMode: 'Demo-modus', minRemaining: 'min. resterend', subscribePlan: 'Abonneer op een plan',
            demoExpired: 'Demo verlopen', chooseSubToContinue: 'Kies een abonnement om door te gaan',
            welcome: 'Welkom!', accountCreated: 'Uw Repward-account is aangemaakt',
            demoActivatedFull: 'Demo-modus geactiveerd!', fullAccess: 'Volledige toegang voor', min: 'min.',
            planChanged: 'Plan gewijzigd', qrGenerated: 'QR-code gegenereerd', readyDownload: 'Klaar om te downloaden',
            error: 'Fout', qrError: 'Kan QR-code niet genereren',
            integrationsTitle: 'Integraties', integrationsSub: 'Verbind uw beoordelingsplatformen',
            comingSoon: 'Binnenkort', connected: 'Verbonden', connect: 'Verbinden',
            merchantView: 'Winkelieransicht', customerView: 'Klantweergave'
        },
        ar: {
            welcomeTitle: 'ŸÖÿ±ÿ≠ÿ®ÿßŸã ÿ®ŸÉ ŸÅŸä Repward', welcomeSubtitle: 'ÿßÿÆÿ™ÿ± ŸÑÿ∫ÿ™ŸÉ',
            step1of2: 'ÿßŸÑÿÆÿ∑Ÿàÿ© 1/2', step2of2: 'ÿßŸÑÿÆÿ∑Ÿàÿ© 2/2',
            createAccount: 'ÿ£ŸÜÿ¥ÿ¶ ÿ≠ÿ≥ÿßÿ®ŸÉ', personalInfo: 'ŸÖÿπŸÑŸàŸÖÿßÿ™ŸÉ ÿßŸÑÿ¥ÿÆÿµŸäÿ©',
            fullName: 'ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ', proEmail: 'ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿßŸÑŸÖŸáŸÜŸä', password: 'ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±', minChars: 'ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ÿØŸÜŸâ 6 ÿ£ÿ≠ÿ±ŸÅ',
            continue: 'ŸÖÿ™ÿßÿ®ÿπÿ©', yourBusiness: 'ŸÜÿ¥ÿßÿ∑ŸÉ ÿßŸÑÿ™ÿ¨ÿßÿ±Ÿä', businessInfo: 'ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿπŸÜ ŸÖÿ§ÿ≥ÿ≥ÿ™ŸÉ',
            businessName: 'ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ§ÿ≥ÿ≥ÿ©', businessType: 'ŸÜŸàÿπ ÿßŸÑŸÜÿ¥ÿßÿ∑', phoneOptional: 'ÿßŸÑŸáÿßÿ™ŸÅ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)',
            promoOptional: 'ÿ±ŸÖÿ≤ ÿ™ÿ±ŸàŸäÿ¨Ÿä (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)', validate: 'ÿ™ÿ£ŸÉŸäÿØ', launchRepward: 'ÿ®ÿØÿ° Repward',
            back: 'ÿ±ÿ¨Ÿàÿπ', freeReg: 'ÿ™ÿ≥ÿ¨ŸäŸÑ ŸÖÿ¨ÿßŸÜŸä ¬∑ ŸÑÿß ÿ≠ÿßÿ¨ÿ© ŸÑÿ®ÿ∑ÿßŸÇÿ© ÿßÿ¶ÿ™ŸÖÿßŸÜ',
            fillAll: 'Ÿäÿ±ÿ¨Ÿâ ŸÖŸÑÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ', minPassword: 'ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ 6 ÿ£ÿ≠ÿ±ŸÅ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ',
            invalidEmail: 'Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿ®ÿ±ŸäÿØ ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿµÿ≠Ÿäÿ≠', enterBusiness: 'Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ŸÖÿ§ÿ≥ÿ≥ÿ™ŸÉ',
            invalidCode: 'ÿ±ŸÖÿ≤ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠', demoActivated: 'ŸÖŸÅÿπŸëŸÑ!', appliedStripe: 'ŸäŸèÿ∑ÿ®ŸëŸÇ ÿπŸÜÿØ ÿßŸÑÿØŸÅÿπ ÿπÿ®ÿ± Stripe',
            qrRewards: 'QR Code ŸàÿßŸÑŸÖŸÉÿßŸÅÿ¢ÿ™', qrSubtitle: 'ÿßÿ∂ÿ®ÿ∑ ŸÜÿ∏ÿßŸÖ ÿ¨ŸÖÿπ ÿßŸÑÿ™ŸÇŸäŸäŸÖÿßÿ™',
            businessTypeLabel: 'ŸÜŸàÿπ ÿßŸÑŸÜÿ¥ÿßÿ∑', aiAdapts: 'ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä Ÿäÿ™ŸÉŸäŸÅ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ŸÖÿπ ŸÇÿ∑ÿßÿπŸÉ',
            rewardClient: 'ŸÖŸÉÿßŸÅÿ£ÿ© ÿßŸÑÿπŸÖŸäŸÑ (ÿ≠ÿ≥ÿ® ÿßŸÑŸÜÿ¨ŸàŸÖ)', chooseGift: 'ÿßÿÆÿ™ÿ± ÿßŸÑŸáÿØŸäÿ© ŸÑÿπŸÖŸÑÿßÿ¶ŸÉ',
            generateQR: 'ÿ•ŸÜÿ¥ÿßÿ° QR Code', downloadPNG: 'ÿ™ÿ≠ŸÖŸäŸÑ PNG', livePreview: 'ŸÖÿπÿßŸäŸÜÿ© ŸÖÿ®ÿßÿ¥ÿ±ÿ©',
            navQR: 'QR', navReviews: 'ÿ™ŸÇŸäŸäŸÖÿßÿ™', navStats: 'ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™', navPlugs: 'ÿ±ÿ®ÿ∑', navPro: 'Pro',
            inbox: 'ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑŸàÿßÿ±ÿØ', inboxSub: 'ÿ£ÿØÿ± ÿ™ŸÇŸäŸäŸÖÿßÿ™ ÿßŸÑÿπŸÖŸÑÿßÿ° ŸÅŸä ŸÖŸÉÿßŸÜ Ÿàÿßÿ≠ÿØ',
            all: 'ÿßŸÑŸÉŸÑ', pending: 'ŸÇŸäÿØ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±', treated: 'ŸÖÿπÿßŸÑÿ¨', critical: 'ÿ≠ÿ±ÿ¨',
            aiDraft: 'ŸÖÿ≥ŸàÿØÿ© ÿ∞ŸÉÿßÿ° ÿßÿµÿ∑ŸÜÿßÿπŸä', winback: 'ÿπÿ±ÿ∂ Win-Back', regenerate: 'ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ŸàŸÑŸäÿØ',
            publishResponse: 'ŸÜÿ¥ÿ± ÿßŸÑÿ±ÿØ', autoPilot: 'ÿßŸÑŸàÿ∂ÿπ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä',
            autoPilotDesc: 'ÿ±ÿØŸàÿØ ÿ™ŸÑŸÇÿßÿ¶Ÿäÿ© ŸÑÿ™ŸÇŸäŸäŸÖÿßÿ™ 4-5‚òÖ',
            analyticsTitle: 'ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑÿßÿ™', analyticsSub: 'ÿ®ŸäÿßŸÜÿßÿ™ Ÿàÿ£ÿØÿßÿ° ÿ™ŸÇŸäŸäŸÖÿßÿ™ŸÉ',
            reviewsCollected: 'ÿ™ŸÇŸäŸäŸÖÿßÿ™ ŸÖÿ¨ŸÖÿπÿ©', timeSaved: 'ŸàŸÇÿ™ ŸÖŸàŸÅÿ±', estimatedROI: 'ÿπÿßÿ¶ÿØ ÿßÿ≥ÿ™ÿ´ŸÖÿßÿ± ÿ™ŸÇÿØŸäÿ±Ÿä',
            aiInsights: 'ÿ±ÿ§Ÿâ ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä',
            settingsTitle: 'ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™', settingsSub: 'ÿ•ÿπÿØÿßÿØÿßÿ™ ÿ≠ÿ≥ÿßÿ®ŸÉ',
            accountInfo: 'ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ≠ÿ≥ÿßÿ®', save: 'ÿ≠ŸÅÿ∏',
            aiConnected: 'ÿ∞ŸÉÿßÿ° Gemini ŸÖÿ™ÿµŸÑ', aiIncluded: 'ÿ±ÿØŸàÿØ ÿ™ŸÑŸÇÿßÿ¶Ÿäÿ© ŸÖÿ¥ŸÖŸàŸÑÿ© ŸÅŸä ÿßÿ¥ÿ™ÿ±ÿßŸÉŸÉ',
            subscriptions: 'ÿßÿ¥ÿ™ÿ±ÿßŸÉÿßÿ™ Repward', choosePlan: 'ÿßÿÆÿ™ÿ± ÿßŸÑÿÆÿ∑ÿ© ÿßŸÑŸÖŸÜÿßÿ≥ÿ®ÿ© ŸÑŸÜÿ¥ÿßÿ∑ŸÉ',
            currentPlan: 'ÿßŸÑÿÆÿ∑ÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©', subscribe: 'ÿßÿ¥ÿ™ÿ±ÿßŸÉ', popular: 'ÿ¥ÿßÿ¶ÿπ',
            noCommit: 'ÿ®ÿØŸàŸÜ ÿßŸÑÿ™ÿ≤ÿßŸÖ ¬∑ ÿ•ŸÑÿ∫ÿßÿ° ŸÅŸä ÿ£Ÿä ŸàŸÇÿ™ ¬∑ ÿØŸÅÿπ ÿ¢ŸÖŸÜ ÿπÿ®ÿ± Stripe',
            thanksVisit: 'ÿ¥ŸÉÿ±ÿßŸã ŸÑÿ≤Ÿäÿßÿ±ÿ™ŸÉ!', instantGift: 'ŸáÿØŸäÿ© ŸÅŸàÿ±Ÿäÿ©',
            leave5Stars: 'ÿßŸÖŸÜÿ≠ŸÜÿß 5 ŸÜÿ¨ŸàŸÖ<br>ŸÑŸÅÿ™ÿ≠ ŸáÿØŸäÿ™ŸÉ',
            reviewHelps: 'ÿ™ŸÇŸäŸäŸÖŸÉ Ÿäÿ≥ÿßÿπÿØŸÜÿß!', tapStars: 'ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿßŸÑŸÜÿ¨ŸàŸÖ ŸÑÿ™ŸÇŸäŸäŸÖŸÜÿß',
            selectStars: 'ÿßÿÆÿ™ÿ± ŸÜÿ¨ŸàŸÖŸÉ', publishGoogle: 'ŸÜÿ¥ÿ± ÿπŸÑŸâ Google',
            rate4Min: 'ŸÇŸäŸëŸÖ 4‚òÖ ŸÉÿ≠ÿØ ÿ£ÿØŸÜŸâ', thanksForFeedback: 'ÿ¥ŸÉÿ±ÿßŸã ŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ŸÉ',
            sorry: 'ŸÜÿ£ÿ≥ŸÅ', helpUnderstand: 'ÿ≥ÿßÿπÿØŸÜÿß ÿπŸÑŸâ ÿßŸÑŸÅŸáŸÖ<br>ŸÑŸÜÿÆÿØŸÖŸÉ ÿ®ÿ¥ŸÉŸÑ ÿ£ŸÅÿ∂ŸÑ',
            bravo5Star: 'üéâ ŸÖŸÖÿ™ÿßÿ≤! ŸáÿØŸäÿ™ŸÉ VIP<br>ŸÖŸÅÿ™Ÿàÿ≠ÿ©!',
            thanksSmall: 'ÿ¥ŸÉÿ±ÿßŸã! ŸÑŸÅÿ™ÿ© ÿµÿ∫Ÿäÿ±ÿ©<br>ŸÑÿ¥ŸÉÿ±ŸÉ',
            feedbackHelps: 'ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ŸÉ ÿ™ÿ≥ÿßÿπÿØŸÜÿß ÿπŸÑŸâ ÿßŸÑÿ™ÿ≠ÿ≥ŸÜ', leaveComment: 'ÿßÿ™ÿ±ŸÉ ŸÑŸÜÿß ÿ™ÿπŸÑŸäŸÇÿßŸã',
            thanksReview: 'ÿ¥ŸÉÿ±ÿßŸã!', reviewMatters: 'ÿ™ŸÇŸäŸäŸÖŸÉ ŸäÿπŸÜŸä ŸÑŸÜÿß ÿßŸÑŸÉÿ´Ÿäÿ±',
            yourGift: 'ŸáÿØŸäÿ™ŸÉ', codeToShow: 'ÿßŸÑÿ±ŸÖÿ≤ ŸÑŸÑÿ™ŸÇÿØŸäŸÖ',
            showCode: 'ŸÇÿØŸÖ Ÿáÿ∞ÿß ÿßŸÑÿ±ŸÖÿ≤ ŸÑŸÑŸÅÿ±ŸäŸÇ ŸÅŸä ÿ≤Ÿäÿßÿ±ÿ™ŸÉ ÿßŸÑŸÇÿßÿØŸÖÿ©', returnBack: 'ÿ±ÿ¨Ÿàÿπ',
            demoMode: 'Ÿàÿ∂ÿπ ÿ™ÿ¨ÿ±Ÿäÿ®Ÿä', minRemaining: 'ÿØŸÇŸäŸÇÿ© ŸÖÿ™ÿ®ŸÇŸäÿ©', subscribePlan: 'ÿßÿ¥ÿ™ÿ±ÿßŸÉ ŸÅŸä ÿÆÿ∑ÿ©',
            demoExpired: 'ÿßŸÜÿ™ŸáŸâ ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑÿ™ÿ¨ÿ±Ÿäÿ®Ÿä', chooseSubToContinue: 'ÿßÿÆÿ™ÿ± ÿßÿ¥ÿ™ÿ±ÿßŸÉÿßŸã ŸÑŸÑŸÖÿ™ÿßÿ®ÿπÿ©',
            welcome: 'ÿ£ŸáŸÑÿßŸã!', accountCreated: 'ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ®ŸÉ ŸÅŸä Repward',
            demoActivatedFull: 'ÿßŸÑŸàÿ∂ÿπ ÿßŸÑÿ™ÿ¨ÿ±Ÿäÿ®Ÿä ŸÖŸÅÿπŸëŸÑ!', fullAccess: 'ŸàÿµŸàŸÑ ŸÉÿßŸÖŸÑ ŸÑŸÖÿØÿ©', min: 'ÿØŸÇŸäŸÇÿ©',
            planChanged: 'ÿ™ŸÖ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿÆÿ∑ÿ©', qrGenerated: 'ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° QR Code', readyDownload: 'ÿ¨ÿßŸáÿ≤ ŸÑŸÑÿ™ÿ≠ŸÖŸäŸÑ',
            error: 'ÿÆÿ∑ÿ£', qrError: 'ÿ™ÿπÿ∞ÿ± ÿ•ŸÜÿ¥ÿßÿ° QR Code',
            integrationsTitle: 'ÿßŸÑÿ™ŸÉÿßŸÖŸÑÿßÿ™', integrationsSub: 'ÿßÿ±ÿ®ÿ∑ ŸÖŸÜÿµÿßÿ™ ÿßŸÑÿ™ŸÇŸäŸäŸÖ ÿßŸÑÿÆÿßÿµÿ© ÿ®ŸÉ',
            comingSoon: 'ŸÇÿ±Ÿäÿ®ÿßŸã', connected: 'ŸÖÿ™ÿµŸÑ', connect: 'ÿ±ÿ®ÿ∑',
            merchantView: 'ÿπÿ±ÿ∂ ÿßŸÑÿ™ÿßÿ¨ÿ±', customerView: 'ÿπÿ±ÿ∂ ÿßŸÑÿπŸÖŸäŸÑ'
        }
    };

    function t(key) {
        return (i18n[currentLang] && i18n[currentLang][key]) || (i18n.fr[key]) || key;
    }

    let selectedIndustry = 'restaurant';

    function chooseLang(lang) {
        currentLang = lang;
        try { localStorage.setItem('repward_lang', lang); } catch(e) {}

        // Apply translations to onboarding immediately
        applyTranslations();

        // Move to step 2 (industry selection)
        onboardNext(2);
    }

    function chooseIndustry(industry) {
        selectedIndustry = industry;
        // Highlight selected button
        document.querySelectorAll('.industry-btn').forEach(btn => {
            btn.classList.remove('bg-brand/10', 'border-brand/40', 'ring-2', 'ring-brand/30');
            btn.classList.add('bg-white/[0.03]', 'border-white/10');
        });
        const clickedBtn = event.currentTarget;
        clickedBtn.classList.remove('bg-white/[0.03]', 'border-white/10');
        clickedBtn.classList.add('bg-brand/10', 'border-brand/40', 'ring-2', 'ring-brand/30');

        // Update hidden input + display in step 4
        const industryNames = {
            restaurant: { emoji: 'üçΩÔ∏è', label: 'Restaurant & Bar' },
            coffee: { emoji: '‚òï', label: 'Coffee Shop' },
            streetfood: { emoji: 'üåÆ', label: 'Street Food' },
            hotel: { emoji: 'üè®', label: 'H√¥tel & Spa' },
            airbnb: { emoji: 'üîë', label: 'Airbnb' },
            beauty: { emoji: '‚úÇÔ∏è', label: 'Coiffure & Beaut√©' },
            retail: { emoji: 'üõçÔ∏è', label: 'Boutique & Retail' },
            bakery: { emoji: 'ü•ê', label: 'Boulangerie' },
            gym: { emoji: 'üí™', label: 'Sport & Fitness' },
            garage: { emoji: 'üîß', label: 'Garage & Auto' }
        };
        const info = industryNames[industry] || industryNames.restaurant;
        const emojiEl = document.getElementById('onboard-industry-emoji');
        const labelEl = document.getElementById('onboard-industry-label');
        const hiddenEl = document.getElementById('onboard-industry');
        if (emojiEl) emojiEl.textContent = info.emoji;
        if (labelEl) labelEl.textContent = info.label;
        if (hiddenEl) hiddenEl.value = industry;

        // Auto-advance to step 3 (compte + commerce) after short delay
        setTimeout(() => onboardNext(3), 350);
    }

    function applyTranslations() {
        // RTL for Arabic
        if (currentLang === 'ar') {
            document.documentElement.setAttribute('dir', 'rtl');
        } else {
            document.documentElement.removeAttribute('dir');
        }

        // Generic data-i18n elements
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            const val = t(key);
            if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                el.placeholder = val;
            } else {
                el.innerHTML = val;
            }
        });

        // ID-based translations for specific elements
        const setText = (id, key) => { const el = document.getElementById(id); if (el) el.innerHTML = t(key); };
        const setPlaceholder = (id, key) => { const el = document.getElementById(id); if (el) el.placeholder = t(key); };

        // Welcome screen
        setText('welcome-title', 'welcomeTitle');
        setText('welcome-subtitle', 'welcomeSubtitle');

        // Step 3 (compte + commerce fusionn√©s)
        const step3 = document.getElementById('onboard-step-3');

        if (step3) {
            const labels = step3.querySelectorAll('label');
            const keys3 = ['fullName', 'businessName', 'proEmail', 'password', 'phoneOptional', 'promoOptional'];
            labels.forEach((l, i) => { if (keys3[i]) l.textContent = t(keys3[i]); });
            const h2 = step3.querySelector('h2');
            if (h2) h2.textContent = t('createAccount');
            const p = step3.querySelector('.text-center p.text-sm');
            if (p) p.textContent = t('personalInfo');
            const btnPrimary = step3.querySelector('button.btn-primary');
            if (btnPrimary) btnPrimary.innerHTML = '<i class="fa-solid fa-rocket mr-2"></i> ' + t('launchRepward');
            setPlaceholder('onboard-name', 'fullName');
            setPlaceholder('onboard-email', 'proEmail');
            setPlaceholder('onboard-password', 'minChars');
        }
    }

    // ============================================
    // SUPABASE CLIENT INITIALIZATION
    // ============================================
    // Configure these with your Supabase project credentials:
    const SUPABASE_URL = localStorage.getItem('repward_supabase_url') || 'https://cratowinhtgbcxxcqgfm.supabase.co';
    const SUPABASE_ANON_KEY = localStorage.getItem('repward_supabase_key') || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNyYXRvd2luaHRnYmN4eGNxZ2ZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3NDQ1NzIsImV4cCI6MjA4NzMyMDU3Mn0.hXnhe04i8U6TN2wWW6lSfnNasQt2CcIwpRP1bOHQBHQ';
    let supabaseClient = null;
    let supabaseUser = null;
    let supabaseMerchant = null;
    const USE_SUPABASE = SUPABASE_URL !== 'https://YOUR_PROJECT.supabase.co';

    if (USE_SUPABASE && typeof supabase !== 'undefined') {
        supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }

    // ============================================
    // DATA LAYER ‚Äî Supabase first, localStorage fallback
    // ============================================
    // ============================================
    // RATE LIMITING & QUOTA UI
    // ============================================
    let rateLimitedUntil = null;

    function handleRateLimit(error, context) {
        if (error && (error.status === 429 || error.message?.includes('429') || error.message?.includes('rate limit'))) {
            rateLimitedUntil = Date.now() + 60000; // Block for 1 min
            showToast('Limite atteinte', 'Trop de requ√™tes. R√©essayez dans 1 minute.', 'error');
            disableGenerationButtons(true);
            setTimeout(() => {
                rateLimitedUntil = null;
                disableGenerationButtons(false);
                showToast('Pr√™t', 'Vous pouvez √† nouveau g√©n√©rer des r√©ponses', 'success');
            }, 60000);
            return true;
        }
        return false;
    }

    function handleQuotaExceeded() {
        showToast('Quota d√©pass√©', 'Limite atteinte pour votre plan. Passez Pro ou attendez la r√©initialisation mensuelle.', 'error');
        disableGenerationButtons(true);
    }

    function disableGenerationButtons(disabled) {
        const btns = document.querySelectorAll('[onclick*="regenerateDraft"], [onclick*="publishResponse"]');
        btns.forEach(btn => {
            btn.disabled = disabled;
            if (disabled) {
                btn.classList.add('opacity-50', 'pointer-events-none');
            } else {
                btn.classList.remove('opacity-50', 'pointer-events-none');
            }
        });
    }

    const db = {
        // Save merchant profile to Supabase (+ localStorage fallback)
        async saveMerchant(fields) {
            // Always save to localStorage as fallback
            try {
                const existing = JSON.parse(localStorage.getItem(ACCOUNT_KEY) || '{}');
                Object.assign(existing, fields);
                localStorage.setItem(ACCOUNT_KEY, JSON.stringify(existing));
            } catch(e) {}

            if (!USE_SUPABASE || !supabaseClient || !supabaseUser) return;
            try {
                const { error } = await supabaseClient
                    .from('merchants')
                    .update(fields)
                    .eq('id', supabaseUser.id);
                if (error) console.warn('db.saveMerchant error:', error);
            } catch(e) { console.warn('db.saveMerchant:', e); }
        },

        // Load merchant profile from Supabase (fallback localStorage)
        async loadMerchant() {
            if (USE_SUPABASE && supabaseClient && supabaseUser) {
                try {
                    const { data, error } = await supabaseClient
                        .from('merchants')
                        .select('*')
                        .eq('id', supabaseUser.id)
                        .single();
                    if (!error && data) {
                        supabaseMerchant = data;
                        return data;
                    }
                } catch(e) { console.warn('db.loadMerchant:', e); }
            }
            // Fallback to localStorage
            try { return JSON.parse(localStorage.getItem(ACCOUNT_KEY) || 'null'); } catch(e) { return null; }
        },

        // Save alerts to Supabase alerts table
        async saveAlerts(emailOn, smsOn) {
            try { localStorage.setItem('repward_alerts', JSON.stringify({ email: emailOn, sms: smsOn })); } catch(e) {}
            if (!USE_SUPABASE || !supabaseClient || !supabaseUser) return;
            try {
                await supabaseClient.from('alerts').upsert({
                    merchant_id: supabaseUser.id,
                    email_alerts: emailOn,
                    sms_alerts: smsOn
                }, { onConflict: 'merchant_id' });
            } catch(e) { console.warn('db.saveAlerts:', e); }
        },

        // Save response to history
        async saveResponseHistory(entry) {
            // localStorage fallback
            try {
                const h = JSON.parse(localStorage.getItem('repward_history') || '[]');
                h.unshift(entry);
                if (h.length > 200) h.length = 200;
                localStorage.setItem('repward_history', JSON.stringify(h));
            } catch(e) {}
            if (!USE_SUPABASE || !supabaseClient || !supabaseUser) return;
            try {
                await supabaseClient.from('response_history').insert({
                    merchant_id: supabaseUser.id,
                    review_id: entry.supabase_review_id || null,
                    author_name: entry.author,
                    rating: entry.rating,
                    platform: entry.platform,
                    response_text: entry.response,
                    published: entry.published || false,
                });
            } catch(e) { console.warn('db.saveResponseHistory:', e); }
        },

        // Load response history
        async loadResponseHistory() {
            if (USE_SUPABASE && supabaseClient && supabaseUser) {
                try {
                    const { data } = await supabaseClient
                        .from('response_history')
                        .select('*')
                        .eq('merchant_id', supabaseUser.id)
                        .order('created_at', { ascending: false })
                        .limit(200);
                    if (data && data.length > 0) return data.map(r => ({
                        author: r.author_name, rating: r.rating, platform: r.platform,
                        response: r.response_text, published: r.published, date: r.created_at
                    }));
                } catch(e) { console.warn('db.loadResponseHistory:', e); }
            }
            try { return JSON.parse(localStorage.getItem('repward_history') || '[]'); } catch(e) { return []; }
        },

        // Save collected contact (phone/email from QR)
        async saveContact(phone, email, source) {
            try {
                const phones = JSON.parse(localStorage.getItem('repward_collected_phones') || '[]');
                if (phone) phones.push(phone);
                localStorage.setItem('repward_collected_phones', JSON.stringify(phones));
            } catch(e) {}
            if (!USE_SUPABASE || !supabaseClient || !supabaseUser) return;
            try {
                await supabaseClient.from('collected_contacts').insert({
                    merchant_id: supabaseUser.id, phone, email, source: source || 'qr'
                });
            } catch(e) { console.warn('db.saveContact:', e); }
        },

        // Save manual review to Supabase reviews table
        async saveManualReview(review) {
            try {
                const saved = JSON.parse(localStorage.getItem('repward_manual_reviews') || '[]');
                saved.unshift(review);
                if (saved.length > 100) saved.length = 100;
                localStorage.setItem('repward_manual_reviews', JSON.stringify(saved));
            } catch(e) {}
            if (!USE_SUPABASE || !supabaseClient || !supabaseUser) return;
            try {
                await supabaseClient.from('reviews').insert({
                    merchant_id: supabaseUser.id,
                    platform: review.platform || 'manual',
                    author_name: review.author,
                    rating: review.rating,
                    text: review.text,
                    lang: review.lang || 'fr',
                });
            } catch(e) { console.warn('db.saveManualReview:', e); }
        },

        // Save platform connection status
        async savePlatform(platformName, connectionData) {
            try {
                const platforms = JSON.parse(localStorage.getItem('repward_platforms') || '{}');
                platforms[platformName] = connectionData;
                localStorage.setItem('repward_platforms', JSON.stringify(platforms));
            } catch(e) {}
            if (!USE_SUPABASE || !supabaseClient || !supabaseUser) return;
            try {
                await supabaseClient.from('platforms').upsert({
                    merchant_id: supabaseUser.id,
                    platform: platformName,
                    connected: connectionData.is_active || false,
                    account_name: connectionData.accountName || null,
                    account_id: connectionData.accountId || null,
                    location_id: connectionData.locationId || null,
                    connected_at: connectionData.is_active ? new Date().toISOString() : null,
                }, { onConflict: 'merchant_id,platform' });
            } catch(e) { console.warn('db.savePlatform:', e); }
        }
    };

    // ============================================
    // ONBOARDING / AUTH SYSTEM
    // ============================================
    const ACCOUNT_KEY = 'repward_account';

    function checkOnboarding() {
        // Skip onboarding if client scanned QR (URL params present)
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('biz') || urlParams.get('ind') || urlParams.get('t')) return false;

        try {
            const account = JSON.parse(localStorage.getItem(ACCOUNT_KEY));
            if (account && account.email && account.businessName) return false;
        } catch(e) {}
        return true; // Show onboarding
    }

    function showOnboarding() {
        const el = document.getElementById('view-onboarding');
        if (el) {
            el.style.display = 'flex';
            document.getElementById('view-merchant').style.display = 'none';
        }
    }

    function hideOnboarding() {
        const el = document.getElementById('view-onboarding');
        if (el) el.style.display = 'none';
        document.getElementById('view-merchant').style.display = '';
    }

    // ============================================
    // PROMO CODE SYSTEM
    // ============================================
    // Codes promo configurables : { code: { type: 'demo'|'discount', duration: minutes, discount: %, label: '' } }
    const PROMO_CODES = {
        'DEMO2026':   { type: 'demo', duration: 60, label: 'D√©mo 1h ‚Äî Acc√®s complet' },
        'DEMO1H':     { type: 'demo', duration: 60, label: 'D√©mo 1h ‚Äî Acc√®s complet' },
        'DEMO30':     { type: 'demo', duration: 30, label: 'D√©mo 30min ‚Äî Acc√®s complet' },
        'REPWARD50':  { type: 'discount', discount: 50, label: '-50% sur le 1er mois' },
        'REPWARD30':  { type: 'discount', discount: 30, label: '-30% sur le 1er mois' },
        'LAUNCH':     { type: 'discount', discount: 20, label: '-20% offre de lancement' },
        'VIP':        { type: 'demo', duration: 120, label: 'D√©mo VIP 2h ‚Äî Acc√®s complet' }
    };

    let activePromo = null;

    function validatePromoCode() {
        const input = document.getElementById('onboard-promo');
        const statusEl = document.getElementById('promo-status');
        if (!input || !statusEl) return;

        const code = input.value.trim().toUpperCase();
        statusEl.classList.remove('hidden');

        if (!code) {
            statusEl.className = 'text-[10px] text-slate-500 mt-1.5';
            statusEl.textContent = '';
            statusEl.classList.add('hidden');
            activePromo = null;
            return;
        }

        const promo = PROMO_CODES[code];
        if (promo) {
            activePromo = { code: code, ...promo };
            statusEl.className = 'text-[10px] text-success font-bold mt-1.5';
            if (promo.type === 'demo') {
                statusEl.innerHTML = `<i class="fa-solid fa-check-circle mr-1"></i> ${promo.label} activ√©e !`;
            } else {
                statusEl.innerHTML = `<i class="fa-solid fa-check-circle mr-1"></i> ${promo.label} ‚Äî Appliqu√© au paiement Stripe`;
            }
        } else {
            activePromo = null;
            statusEl.className = 'text-[10px] text-danger font-bold mt-1.5';
            statusEl.innerHTML = `<i class="fa-solid fa-xmark-circle mr-1"></i> Code invalide`;
        }
    }

    function isDemoActive() {
        try {
            const demo = JSON.parse(localStorage.getItem('repward_demo'));
            if (!demo || !demo.expiresAt) return false;
            return new Date(demo.expiresAt) > new Date();
        } catch(e) { return false; }
    }

    function getDemoRemaining() {
        try {
            const demo = JSON.parse(localStorage.getItem('repward_demo'));
            if (!demo || !demo.expiresAt) return 0;
            const remaining = new Date(demo.expiresAt) - new Date();
            return Math.max(0, Math.ceil(remaining / 60000)); // minutes restantes
        } catch(e) { return 0; }
    }

    function onboardNext(step) {
        // Show target step, hide others
        for (let i = 1; i <= 3; i++) {
            const s = document.getElementById('onboard-step-' + i);
            if (s) s.style.display = i === step ? 'block' : 'none';
        }
    }

    function completeOnboarding() {
        const name = document.getElementById('onboard-name')?.value.trim();
        const email = document.getElementById('onboard-email')?.value.trim();
        const password = document.getElementById('onboard-password')?.value;
        const business = document.getElementById('onboard-business')?.value.trim();
        const errEl = document.getElementById('onboard-error-3');

        if (!name || !email || !password || !business) {
            if (errEl) { errEl.textContent = 'Veuillez remplir tous les champs obligatoires'; errEl.classList.remove('hidden'); }
            return;
        }
        if (password.length < 6) {
            if (errEl) { errEl.textContent = 'Le mot de passe doit faire au moins 6 caract√®res'; errEl.classList.remove('hidden'); }
            return;
        }
        if (!email.includes('@')) {
            if (errEl) { errEl.textContent = 'Veuillez entrer un email valide'; errEl.classList.remove('hidden'); }
            return;
        }
        if (errEl) errEl.classList.add('hidden');

        const industry = document.getElementById('onboard-industry')?.value || selectedIndustry;
        const phone = document.getElementById('onboard-phone')?.value.trim();

        // Save account to localStorage (fallback / offline mode)
        const account = {
            name: name,
            email: email,
            passwordHash: btoa(password),
            businessName: business,
            industry: industry,
            phone: phone,
            plan: 'starter',
            promoCode: activePromo ? activePromo.code : null,
            createdAt: new Date().toISOString()
        };

        try {
            localStorage.setItem(ACCOUNT_KEY, JSON.stringify(account));
        } catch(e) {}

        // Supabase Auth ‚Äî signup + create merchant record
        if (USE_SUPABASE && supabaseClient) {
            (async () => {
                try {
                    const { data: authData, error: authErr } = await supabaseClient.auth.signUp({
                        email: email,
                        password: password,
                        options: { data: { name: name, business_name: business } }
                    });
                    if (authErr) { console.error('Supabase auth error:', authErr); return; }
                    supabaseUser = authData.user;

                    // Create merchant record
                    const { data: merchant, error: merchantErr } = await supabaseClient
                        .from('merchants')
                        .insert({
                            email: email,
                            name: name,
                            business_name: business,
                            industry: industry,
                            phone: phone,
                            promo_code: activePromo ? activePromo.code : null,
                            language: currentLang,
                        })
                        .select()
                        .single();
                    if (!merchantErr) supabaseMerchant = merchant;
                } catch(e) { console.error('Supabase onboarding error:', e); }
            })();
        }

        // If demo promo code, activate demo mode with timer
        if (activePromo && activePromo.type === 'demo') {
            const expiresAt = new Date(Date.now() + activePromo.duration * 60000).toISOString();
            try {
                localStorage.setItem('repward_demo', JSON.stringify({
                    code: activePromo.code,
                    activatedAt: new Date().toISOString(),
                    expiresAt: expiresAt,
                    duration: activePromo.duration
                }));
                localStorage.setItem('repward_plan', 'unlimited'); // Full access during demo
            } catch(e) {}
        }

        // If discount promo code, save it for Stripe
        if (activePromo && activePromo.type === 'discount') {
            try {
                localStorage.setItem('repward_discount', JSON.stringify({
                    code: activePromo.code,
                    discount: activePromo.discount,
                    label: activePromo.label
                }));
            } catch(e) {}
        }

        // Pre-fill settings with onboarding data
        const indSelector = document.getElementById('ind-selector');
        if (indSelector) indSelector.value = industry;
        currentInd = industry;
        updatePortalIndustryBadge(industry);

        const nameInput = document.getElementById('input-nom-etab');
        if (nameInput) nameInput.value = business;

        const emailInput = document.getElementById('input-email-etab');
        if (emailInput) emailInput.value = email;

        const telInput = document.getElementById('input-tel-etab');
        if (telInput) telInput.value = phone;

        // Hide onboarding, show dashboard
        hideOnboarding();
        loadGeminiKey();
        loadPrefs();
        loadGoogleMapsUrl();
        renderMessages();
        switchTab('portal');
        updateInd();
        renderSubscriptionPlans();
        updateDemoBanner();
        renderHeatmap();
        animateReputationScore();
        loadEstablishments();
        loadAlertPrefs();
        generateWidgetCode();
        updateShortLink();
        savePrefs();

        if (activePromo && activePromo.type === 'demo') {
            showToast('Mode D√©mo activ√© !', `Acc√®s complet pendant ${activePromo.duration} min`, 'success');
        } else {
            showToast('Bienvenue !', 'Votre compte Repward est cr√©√©', 'success');
        }
        setTimeout(() => {
            if (typeof confetti === 'function') {
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            }
        }, 300);
    }

    // ============================================
    // DEMO TIMER BANNER
    // ============================================
    function updateDemoBanner() {
        // Remove existing banner if any
        const existing = document.getElementById('demo-banner');
        if (existing) existing.remove();

        if (!isDemoActive()) return;

        const remaining = getDemoRemaining();
        const banner = document.createElement('div');
        banner.id = 'demo-banner';
        banner.className = 'fixed top-0 left-0 right-0 z-[90] bg-gradient-to-r from-brand to-brand-dark text-white text-center py-2 px-4 text-xs font-bold shadow-lg';
        banner.innerHTML = `
            <i class="fa-solid fa-clock mr-1.5"></i>
            Mode D√©mo ‚Äî <span id="demo-timer">${remaining}</span> min restantes
            <span class="mx-2 opacity-50">|</span>
            <button onclick="window.location.hash='';switchTab('settings')" class="underline hover:text-brand-50 transition-colors">Souscrire un plan</button>
        `;
        document.body.prepend(banner);

        // Update timer every minute
        if (window._demoInterval) clearInterval(window._demoInterval);
        window._demoInterval = setInterval(() => {
            const mins = getDemoRemaining();
            const timerEl = document.getElementById('demo-timer');
            if (timerEl) timerEl.textContent = mins;

            if (mins <= 0) {
                clearInterval(window._demoInterval);
                const b = document.getElementById('demo-banner');
                if (b) {
                    b.className = 'fixed top-0 left-0 right-0 z-[90] bg-gradient-to-r from-danger to-danger-dark text-white text-center py-2.5 px-4 text-xs font-bold shadow-lg';
                    b.innerHTML = `
                        <i class="fa-solid fa-triangle-exclamation mr-1.5"></i>
                        D√©mo expir√©e ‚Äî
                        <button onclick="switchTab('settings')" class="underline font-black hover:text-white/80 transition-colors">Choisissez un abonnement pour continuer</button>
                    `;
                }
                try { localStorage.setItem('repward_plan', 'starter'); } catch(e) {}
                renderSubscriptionPlans();
            }
        }, 60000);
    }

    function loadAccountData() {
        // Restore language
        try {
            const savedLang = localStorage.getItem('repward_lang');
            if (savedLang && i18n[savedLang]) currentLang = savedLang;
        } catch(e) {}

        try {
            const account = JSON.parse(localStorage.getItem(ACCOUNT_KEY));
            if (!account) return;

            const nameInput = document.getElementById('input-nom-etab');
            if (nameInput && account.businessName) nameInput.value = account.businessName;

            const emailInput = document.getElementById('input-email-etab');
            if (emailInput && account.email) emailInput.value = account.email;

            const telInput = document.getElementById('input-tel-etab');
            if (telInput && account.phone) telInput.value = account.phone;

            if (account.industry) {
                const indSelector = document.getElementById('ind-selector');
                if (indSelector) indSelector.value = account.industry;
                currentInd = account.industry;
                updatePortalIndustryBadge(account.industry);
            }
        } catch(e) {}

        applyTranslations();
    }

    // ============================================
    // AI RESPONSE CONFIG (cl√© Gemini s√©curis√©e c√¥t√© serveur via Edge Function)
    // ============================================

    // Fonction pour g√©n√©rer une r√©ponse IA via l'Edge Function Supabase (s√©curis√©)
    async function generateAIResponse(reviewText, reviewRating, authorName, platform, industryName, winbackOffer, lang) {
        const winbackInstruction = winbackOffer && winbackOffer !== 'none'
            ? `\n\nIMPORTANT: Inclus une offre de compensation win-back dans ta r√©ponse. L'offre est : "${winbackOffer}". G√©n√®re un code promo unique au format RWD-XXXX-WB (remplace XXXX par 4 chiffres al√©atoires). Pr√©sente le code de mani√®re √©l√©gante.`
            : '';

        const toneInstructions = {
            professional: 'Ton professionnel, formel et corporate. Vouvoiement obligatoire.',
            casual: 'Ton d√©contract√© et amical, comme un ami. Tutoiement naturel, langage courant.',
            warm: 'Ton chaleureux et bienveillant, plein d\'empathie. Vouvoiement mais tr√®s humain.',
            humor: 'Ton professionnel avec une touche d\'humour l√©ger et des jeux de mots. Reste respectueux.'
        };
        const toneStyle = toneInstructions[currentAiTone] || toneInstructions.professional;

        // D√©terminer la langue de r√©ponse
        const langMap = {
            'fr': 'fran√ßais', 'en': 'English', 'es': 'espa√±ol',
            'it': 'italiano', 'de': 'Deutsch', 'pt': 'portugu√™s',
            'nl': 'Nederlands', 'ar': 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©'
        };
        const responseLang = langMap[lang] || 'fran√ßais';

        // Contraintes sp√©cifiques par plateforme
        let platformNote = '';
        if (platform === 'booking') {
            platformNote = '\nIMPORTANT: La r√©ponse doit √™tre dans la langue de l\'avis ou en anglais. Booking mod√®re les r√©ponses (24-72h).';
        } else if (platform === 'airbnb') {
            platformNote = '\nIMPORTANT: La r√©ponse sera publi√©e imm√©diatement sur Airbnb (pas de mod√©ration). Sois particuli√®rement professionnel.';
        } else if (platform === 'thefork') {
            platformNote = '\nIMPORTANT: Le droit de r√©ponse sur TheFork est limit√© √† 3 mois apr√®s l\'avis.';
        }

        // Consigne vocale du g√©rant
        const voiceDirective = voiceInstruction ? `\nCONSIGNE SP√âCIFIQUE DU G√âRANT : "${voiceInstruction}" (Tu dois IMP√âRATIVEMENT int√©grer cette consigne dans ta r√©ponse).` : '';

        const fullPrompt = `Tu es l'assistant IA de Repward OS, sp√©cialis√© dans la gestion de r√©putation en ligne pour les commerces.
Tu r√©diges des r√©ponses professionnelles, empathiques et personnalis√©es aux avis clients.

STYLE DE TON : ${toneStyle}${voiceDirective}

R√®gles :
- √âcris en ${responseLang}, adapte le ton selon le style demand√© ci-dessus
- Personnalise avec le pr√©nom du client si disponible
- Adresse chaque point soulev√© dans l'avis
- Montre de l'empathie pour les avis n√©gatifs, propose des solutions concr√®tes
- Pour les avis positifs, remercie sinc√®rement et mentionne des d√©tails sp√©cifiques
- Termine toujours par "√Ä tr√®s vite,\\nLa Direction." (traduit dans la langue de r√©ponse)
- Garde la r√©ponse concise (max 150 mots)
- N'utilise PAS de markdown, √©cris en texte brut${winbackInstruction}${platformNote}

Contexte :
- Type de commerce : ${industryName}
- Plateforme : ${platform}
- Note : ${reviewRating}/5 √©toiles
- Auteur : ${authorName}
- Langue de l'avis : ${responseLang}
- Avis du client : "${reviewText}"

R√©dige une r√©ponse professionnelle √† cet avis en ${responseLang}.`;

        // Appel s√©curis√© via Edge Function Supabase
        if (USE_SUPABASE && supabaseClient) {
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (session) {
                    const edgeRes = await fetch(`${SUPABASE_URL}/functions/v1/generate-response`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${session.access_token}`,
                        },
                        body: JSON.stringify({ prompt: fullPrompt, maxTokens: 500 }),
                    });
                    if (edgeRes.ok) {
                        const edgeData = await edgeRes.json();
                        if (edgeData.response) return edgeData.response;
                    } else {
                        const errData = await edgeRes.json().catch(() => ({}));
                        console.error('Edge Function error:', edgeRes.status, errData);
                    }
                }
            } catch (edgeErr) {
                console.error('Edge Function call failed:', edgeErr);
            }
        }

        // Si pas de Supabase, retourner null (plus d'appel direct Gemini c√¥t√© client)
        console.warn("Repward OS: Impossible de contacter l'IA. V√©rifiez votre connexion.");
        return null;
    }

    // ============================================
    // TOAST NOTIFICATIONS
    // ============================================
    function showToast(title, message, type = 'success') {
        const toast = document.getElementById('toast-notification');
        if (!toast) return;
        const icon = toast.querySelector('.toast-icon');
        const titleEl = toast.querySelector('.toast-title');
        const msgEl = toast.querySelector('.toast-msg');

        if (type === 'error') {
            toast.className = toast.className.replace(/from-success to-success-dark/g, 'from-danger to-danger-dark').replace(/shadow-success/g, 'shadow-danger');
        } else {
            toast.className = toast.className.replace(/from-danger to-danger-dark/g, 'from-success to-success-dark').replace(/shadow-danger/g, 'shadow-success');
        }
        if (titleEl) titleEl.textContent = title;
        if (msgEl) msgEl.textContent = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 4000);
    }

    // ============================================
    // PREFERENCES PERSISTENCE
    // ============================================
    const PREFS_KEY = 'repward_prefs';

    function savePrefs() {
        const prefs = {
            industry: currentInd,
            reward: currentRew,
            autoPilot: document.getElementById('auto-pilot-toggle')?.checked || false,
            filter: currentFilter,
            fortuneEnabled: fortuneEnabled,
            fomoEnabled: fomoEnabled,
            voiceInstruction: voiceInstruction,
            wheelSegments: wheelSegments,
            account: {
                name: document.getElementById('input-nom-etab')?.value || '',
                email: document.getElementById('input-email-etab')?.value || '',
                tel: document.getElementById('input-tel-etab')?.value || ''
            }
        };
        try { localStorage.setItem(PREFS_KEY, JSON.stringify(prefs)); } catch(e) {}

        // Sync to Supabase merchants table
        db.saveMerchant({
            industry: currentInd,
            auto_pilot: prefs.autoPilot,
            fortune_enabled: fortuneEnabled,
            fomo_enabled: fomoEnabled,
            voice_instruction: voiceInstruction,
            wheel_segments: wheelSegments,
            ai_tone: currentAiTone,
            business_name: prefs.account.name || undefined,
            email: prefs.account.email || undefined,
            phone: prefs.account.tel || undefined,
        });
    }

    function loadPrefs() {
        try {
            const raw = localStorage.getItem(PREFS_KEY);
            if (!raw) return;
            const prefs = JSON.parse(raw);
            if (prefs.industry) {
                const sel = document.getElementById('ind-selector');
                if (sel) { sel.value = prefs.industry; currentInd = prefs.industry; }
                updatePortalIndustryBadge(prefs.industry);
            }
            if (prefs.reward) currentRew = prefs.reward;
            if (prefs.autoPilot) {
                const toggle = document.getElementById('auto-pilot-toggle');
                if (toggle) { toggle.checked = true; toggleAutoPilot(); }
            }
            if (prefs.filter) { currentFilter = prefs.filter; }
            if (typeof prefs.fortuneEnabled !== 'undefined') {
                fortuneEnabled = prefs.fortuneEnabled;
                const ft = document.getElementById('fortune-toggle');
                if (ft) ft.checked = fortuneEnabled;
            }
            if (typeof prefs.fomoEnabled !== 'undefined') {
                fomoEnabled = prefs.fomoEnabled;
                const fmt = document.getElementById('fomo-toggle');
                if (fmt) fmt.checked = fomoEnabled;
            }
            if (prefs.voiceInstruction) {
                voiceInstruction = prefs.voiceInstruction;
                const vText = document.getElementById('voice-instruction-text');
                if (vText) vText.value = voiceInstruction;
            }
            if (prefs.wheelSegments && Array.isArray(prefs.wheelSegments) && prefs.wheelSegments.length >= 2) {
                wheelSegments.length = 0;
                prefs.wheelSegments.forEach(s => wheelSegments.push(s));
                drawWheel();
                renderSegmentsList();
            }
            if (prefs.account) {
                if (prefs.account.name) { const el = document.getElementById('input-nom-etab'); if(el) el.value = prefs.account.name; }
                if (prefs.account.email) { const el = document.getElementById('input-email-etab'); if(el) el.value = prefs.account.email; }
                if (prefs.account.tel) { const el = document.getElementById('input-tel-etab'); if(el) el.value = prefs.account.tel; }
            }
        } catch(e) {}
    }

    function saveAccountSettings() {
        const name = document.getElementById('input-nom-etab')?.value?.trim();
        const email = document.getElementById('input-email-etab')?.value?.trim();
        const btn = document.getElementById('btn-save-account');

        if (!name) { showToast('Erreur', 'Le nom est obligatoire', 'error'); return; }
        if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { showToast('Erreur', 'Email invalide', 'error'); return; }

        savePrefs();

        const sidebarName = document.getElementById('sidebar-biz-name');
        if (sidebarName) sidebarName.textContent = name || 'Mon Commerce';

        if (btn) {
            const orig = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-check mr-2 text-success"></i> Sauvegard√© !';
            btn.classList.add('opacity-70', 'pointer-events-none');
            setTimeout(() => { btn.innerHTML = orig; btn.classList.remove('opacity-70', 'pointer-events-none'); }, 2000);
        }
        showToast('Sauvegard√©', 'Vos informations ont √©t√© mises √† jour', 'success');
    }

    // ============================================
    // QR CODE GENERATION
    // ============================================
    // G√©n√®re un token al√©atoire s√©curis√©
    function generateSecureToken() {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789';
        let token = 'RW-';
        for (let i = 0; i < 16; i++) token += chars.charAt(Math.floor(Math.random() * chars.length));
        return token;
    }

    async function generateQRCode() {
        const container = document.getElementById('qr-code-container');
        const canvas = document.getElementById('qr-canvas');
        const dlBtn = document.getElementById('btn-download-qr');
        if (!canvas || !container) return;

        const businessName = document.getElementById('input-nom-etab')?.value || 'Mon Commerce';
        const token = generateSecureToken();

        // Expiration dans 6 mois
        const expiresAt = new Date(Date.now() + 180 * 24 * 60 * 60 * 1000).toISOString();

        // Sauvegarder le token dans Supabase
        if (USE_SUPABASE && supabaseClient && supabaseMerchant) {
            try {
                const { error } = await supabaseClient.from('qr_tokens').insert({
                    merchant_id: supabaseMerchant.id,
                    token: token,
                    business_name: businessName,
                    industry: currentInd,
                    reward: currentRew,
                    expires_at: expiresAt
                });
                if (error) { console.error('QR token save error:', error); }
            } catch(e) { console.error('QR token insert failed:', e); }
        }

        // URL avec token unique
        const qrUrl = `${window.location.origin}?t=${token}`;

        // Fallback: charger la librairie dynamiquement si absente
        if (typeof QRCode === 'undefined') {
            showToast('Chargement', 'Chargement de la librairie QR...', 'info');
            try {
                await new Promise((resolve, reject) => {
                    const s = document.createElement('script');
                    s.src = 'https://cdn.jsdelivr.net/npm/qrcode@1.5.4/build/qrcode.min.js';
                    s.onerror = () => {
                        const s2 = document.createElement('script');
                        s2.src = 'https://unpkg.com/qrcode@1.5.4/build/qrcode.min.js';
                        s2.onload = resolve;
                        s2.onerror = reject;
                        document.head.appendChild(s2);
                    };
                    s.onload = resolve;
                    s.onerror = reject;
                    document.head.appendChild(s);
                });
            } catch(e) {
                showToast('Erreur', 'Impossible de charger la librairie QR. V√©rifiez votre connexion.', 'error');
                return;
            }
        }

        if (typeof QRCode !== 'undefined') {
            QRCode.toCanvas(canvas, qrUrl, {
                width: 250,
                margin: 2,
                color: { dark: '#0f172a', light: '#ffffff' }
            }, function(error) {
                if (error) { showToast('Erreur', 'Impossible de g√©n√©rer le QR code', 'error'); return; }
                container.classList.remove('hidden');
                if (dlBtn) dlBtn.classList.remove('hidden');
                showToast('QR Code g√©n√©r√©', 'Valable 6 mois ¬∑ Usage unique', 'success');
            });
        } else {
            showToast('Erreur', 'Librairie QR indisponible. Rechargez la page.', 'error');
        }
    }

    function downloadQR() {
        const canvas = document.getElementById('qr-canvas');
        if (!canvas) return;
        const link = document.createElement('a');
        link.download = 'repward-qrcode.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
    }

    // Affiche une erreur plein √©cran quand le token QR est invalide/expir√©/utilis√©
    function showTokenError(message) {
        document.getElementById('view-merchant')?.classList.add('view-hidden');
        document.getElementById('view-customer')?.classList.add('view-hidden');
        const overlay = document.createElement('div');
        overlay.style.cssText = 'position:fixed;inset:0;background:#0a0e1a;display:flex;align-items:center;justify-content:center;z-index:99999;padding:2rem;';
        overlay.innerHTML = `
            <div style="text-align:center;max-width:400px;">
                <div style="width:80px;height:80px;margin:0 auto 1.5rem;background:rgba(239,68,68,0.1);border-radius:50%;display:flex;align-items:center;justify-content:center;">
                    <svg width="40" height="40" fill="none" stroke="#ef4444" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M15 9l-6 6M9 9l6 6"/></svg>
                </div>
                <h2 style="color:#fff;font-size:1.5rem;font-weight:800;margin-bottom:0.75rem;">Lien invalide</h2>
                <p style="color:#94a3b8;font-size:0.95rem;line-height:1.6;margin-bottom:2rem;">${escapeHtml(message)}</p>
                <p style="color:#475569;font-size:0.75rem;">Demandez un nouveau QR code au commerce.</p>
            </div>`;
        document.body.appendChild(overlay);
    }

    // Marque le token QR comme utilis√© apr√®s que le client a laiss√© un avis
    async function markQrTokenUsed() {
        const token = window._activeQrToken;
        if (!token || !USE_SUPABASE || !supabaseClient) return;
        try {
            await supabaseClient.from('qr_tokens').update({
                used: true,
                used_at: new Date().toISOString()
            }).eq('token', token);
            window._activeQrToken = null; // Emp√™che double-marquage
        } catch(e) { console.error('Mark token used error:', e); }
    }

    // ============================================
    // DATA
    // ============================================
    // ============================================
    // THEME COLORS PER INDUSTRY (Client view)
    // ============================================
    const industryThemes = {
        restaurant: { primary: '#6366f1', gradient: 'from-indigo-500 to-indigo-700', bg: 'bg-indigo-500', text: 'text-indigo-600', light: 'bg-indigo-50', accent: '#818cf8' },
        coffee:     { primary: '#8b5cf6', gradient: 'from-violet-500 to-violet-700', bg: 'bg-violet-500', text: 'text-violet-600', light: 'bg-violet-50', accent: '#a78bfa' },
        streetfood: { primary: '#f97316', gradient: 'from-orange-500 to-orange-700', bg: 'bg-orange-500', text: 'text-orange-600', light: 'bg-orange-50', accent: '#fb923c' },
        hotel:      { primary: '#8b5cf6', gradient: 'from-violet-600 to-purple-800', bg: 'bg-violet-600', text: 'text-violet-700', light: 'bg-violet-50', accent: '#a78bfa' },
        airbnb:     { primary: '#ec4899', gradient: 'from-pink-500 to-rose-600', bg: 'bg-pink-500', text: 'text-pink-600', light: 'bg-pink-50', accent: '#f472b6' },
        beauty:     { primary: '#10b981', gradient: 'from-emerald-500 to-emerald-700', bg: 'bg-emerald-500', text: 'text-emerald-600', light: 'bg-emerald-50', accent: '#34d399' },
        retail:     { primary: '#3b82f6', gradient: 'from-blue-500 to-blue-700', bg: 'bg-blue-500', text: 'text-blue-600', light: 'bg-blue-50', accent: '#60a5fa' },
        bakery:     { primary: '#d97706', gradient: 'from-amber-500 to-amber-700', bg: 'bg-amber-500', text: 'text-amber-600', light: 'bg-amber-50', accent: '#fbbf24' },
        gym:        { primary: '#ef4444', gradient: 'from-red-500 to-red-700', bg: 'bg-red-500', text: 'text-red-600', light: 'bg-red-50', accent: '#f87171' },
        garage:     { primary: '#64748b', gradient: 'from-slate-600 to-slate-800', bg: 'bg-slate-600', text: 'text-slate-600', light: 'bg-slate-50', accent: '#94a3b8' }
    };

    // ============================================
    // SUBSCRIPTION PLANS
    // ============================================
    const subscriptionPlans = [
        { id: 'starter', name: 'Starter', price: '9,90', originalPrice: '29,90', priceNum: 9.90, limit: 10, label: '10 r√©ponses IA/mois', features: ['10 r√©ponses IA/mois', '1 plateforme', 'QR Code basique', 'R√©compenses simples'], promo: 'Offre 1√®re ann√©e', stripeUrl: 'https://buy.stripe.com/eVq8wP4VA3g76QH5O21VK0C' },
        { id: 'pro', name: 'Pro', price: '49,90', originalPrice: '89,90', priceNum: 49.90, limit: 100, label: '100 r√©ponses IA/mois', features: ['100 r√©ponses IA/mois', '10 plateformes', 'QR Code personnalis√©', 'Win-Back codes promos', 'Pilote automatique', 'Analytics complets', 'Support prioritaire'], popular: true, promo: 'Offre 1√®re ann√©e', stripeUrl: 'https://buy.stripe.com/28EcN5co23g78YPdgu1VK0D' },
        { id: 'unlimited', name: 'Illimit√©', price: '99,90', originalPrice: '149,90', priceNum: 99.90, limit: Infinity, label: 'R√©ponses illimit√©es', features: ['R√©ponses IA illimit√©es', '18 plateformes', 'Pilote automatique', 'Win-Back illimit√©', 'Radar IA op√©rationnel', 'Support d√©di√© 24/7', 'API personnalis√©e'], promo: 'Offre 1√®re ann√©e', stripeUrl: 'https://buy.stripe.com/8x29AT4VA03V2Ar50e1VK0E' }
    ];

    // ============================================
    // REWARDS BY STAR RATING (adapted per industry)
    // ============================================
    function getRewardsByStars(industry, stars) {
        const rewardMap = {
            restaurant: {
                5: ["Dessert Offert", "Caf√© Gourmand Offert", "Ap√©ritif Maison", "Digestif Offert", "-10% sur l'addition", "Entr√©e Offerte"],
                4: ["Un Caf√© Offert", "Amuse-bouche Offert"],
                3: ["Un Sourire et Merci"],
                2: [],
                1: []
            },
            coffee: {
                5: ["Cookie Artisanal Offert", "Shot de Vanille Gratuit", "2√®me Caf√© Offert", "Lait V√©g√©tal Offert", "Muffin du Jour", "Smoothie Offert"],
                4: ["Shot de Sirop Offert", "Cookie Offert"],
                3: ["Un Merci Chaleureux"],
                2: [],
                1: []
            },
            streetfood: {
                5: ["Boisson Offerte", "Frites Cheddar XL", "Menu Upgrader Gratuit", "Sauce Sp√©ciale Maison", "Dessert du Jour", "Extra Garniture"],
                4: ["Boisson Small Offerte", "Sauce Premium"],
                3: ["Merci pour votre visite"],
                2: [],
                1: []
            },
            hotel: {
                5: ["Late Check-out 14h", "Acc√®s Spa Gratuit", "Surclassement Chambre", "Petit-D√©jeuner Offert", "Bouteille de Vin en Chambre", "Transfert A√©roport", "Minibar Offert", "Massage 30min"],
                4: ["Late Check-out 12h", "Caf√© de Bienvenue"],
                3: ["Remerciement personnalis√©"],
                2: [],
                1: []
            },
            airbnb: {
                5: ["Late Check-out 13h", "-15% Prochain S√©jour", "Panier de Bienvenue Local", "Bouteille de Vin R√©gional", "Guide Touristique Perso", "M√©nage Offert", "Early Check-in"],
                4: ["Caf√© & Croissants", "-5% Prochain S√©jour"],
                3: ["Guide local offert"],
                2: [],
                1: []
            },
            beauty: {
                5: ["Soin Profond Offert", "Massage Cr√¢nien 15min", "-15% Produits Boutique", "√âchantillons Premium", "Brushing Express Offert", "Masque Capillaire"],
                4: ["√âchantillon Soin", "-5% Boutique"],
                3: ["Conseil personnalis√©"],
                2: [],
                1: []
            },
            retail: {
                5: ["-10% Imm√©diat", "Tote Bag Exclusif", "Statut VIP Fid√©lit√©", "Cadeau Surprise", "Livraison Offerte", "Emballage Cadeau Premium"],
                4: ["-5% Prochain Achat", "Petit Cadeau"],
                3: ["Merci de votre fid√©lit√©"],
                2: [],
                1: []
            },
            bakery: {
                5: ["Viennoiserie Offerte", "Caf√© Offert", "Pain Sp√©cial du Jour", "P√¢tisserie au Choix", "Macaron Offert", "Carte Fid√©lit√© x2"],
                4: ["Mini Viennoiserie", "Caf√© Offert"],
                3: ["Sourire du boulanger"],
                2: [],
                1: []
            },
            gym: {
                5: ["S√©ance Coaching Offerte", "1 Semaine Offerte", "Boisson Prot√©in√©e", "Serviette Branded", "Cours Collectif VIP", "Assessment Gratuit"],
                4: ["Boisson Offerte", "1 Jour Invit√©"],
                3: ["Merci sportif"],
                2: [],
                1: []
            },
            garage: {
                5: ["Diagnostic Gratuit", "Lavage Int√©rieur Offert", "-10% Prochaine R√©vision", "Contr√¥le Pression Pneus", "Liquide Lave-Glace Offert", "D√©sodorisant Offert"],
                4: ["Contr√¥le Niveaux Gratuit", "Caf√© Offert"],
                3: ["Remerciement"],
                2: [],
                1: []
            }
        };
        const map = rewardMap[industry] || rewardMap['restaurant'];
        return map[stars] || [];
    }

    const industries = {
        restaurant: {
            name: "Restaurant & Bar",
            emoji: "üçΩÔ∏è",
            img: "https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=600&q=80&auto=format",
            rewards: ["Dessert Offert", "Caf√© Gourmand Offert", "Ap√©ritif Maison", "Digestif Offert", "-10% sur l'addition", "Entr√©e Offerte"],
            insights: [
                { label: "Plat froid", count: 12, severity: "high" },
                { label: "Service lent", count: 8, severity: "medium" },
                { label: "Bruit ambiant", count: 4, severity: "low" }
            ],
            kpis: { reviews: '+112', timeSaved: '24h', roi: '1 850 ‚Ç¨' },
            winbackOptions: [
                { val: 'none', label: 'Ne rien offrir (Excuses simples)' },
                { val: 'dessert', label: 'üç∞ Dessert offert' },
                { val: 'drink', label: 'üçπ Boisson ou Ap√©ritif offert' },
                { val: 'discount', label: 'üìâ -10% sur l\'addition' },
                { val: 'entree', label: 'ü•ó Entr√©e offerte prochaine visite' }
            ]
        },
        coffee: {
            name: "Coffee Shop & Salon de Th√©",
            emoji: "‚òï",
            img: "https://images.unsplash.com/photo-1497935586351-b67a49e012bf?w=600&q=80&auto=format",
            rewards: ["Cookie Artisanal Offert", "Shot de Vanille Gratuit", "2√®me Caf√© Offert", "Lait V√©g√©tal Offert", "Muffin du Jour", "Smoothie Offert"],
            insights: [
                { label: "Musique trop forte", count: 5, severity: "medium" },
                { label: "WiFi capricieux", count: 4, severity: "medium" },
                { label: "Manque prises √©lec.", count: 2, severity: "low" }
            ],
            kpis: { reviews: '+84', timeSaved: '16h', roi: '1 240 ‚Ç¨' },
            winbackOptions: [
                { val: 'none', label: 'Ne rien offrir (Excuses simples)' },
                { val: 'coffee', label: '‚òï Caf√© de sp√©cialit√© offert' },
                { val: 'cookie', label: 'üç™ P√¢tisserie offerte' },
                { val: 'smoothie', label: 'ü•§ Smoothie offert' }
            ]
        },
        streetfood: {
            name: "Street Food & Fast Food",
            emoji: "üåÆ",
            img: "https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?w=600&q=80&auto=format",
            rewards: ["Boisson Offerte", "Frites Cheddar XL", "Menu Upgrader Gratuit", "Sauce Sp√©ciale Maison", "Dessert du Jour", "Extra Garniture"],
            insights: [
                { label: "Frites froides", count: 11, severity: "high" },
                { label: "Commande incompl√®te", count: 6, severity: "medium" },
                { label: "Temps d'attente", count: 3, severity: "low" }
            ],
            kpis: { reviews: '+156', timeSaved: '12h', roi: '890 ‚Ç¨' },
            winbackOptions: [
                { val: 'none', label: 'Ne rien offrir' },
                { val: 'drink', label: 'ü•§ Boisson offerte' },
                { val: 'fries', label: 'üçü Frites offertes' },
                { val: 'upgrade', label: '‚¨ÜÔ∏è Menu Upgrader gratuit' }
            ]
        },
        hotel: {
            name: "H√¥tel & Spa",
            emoji: "üè®",
            img: "https://images.unsplash.com/photo-1566073771259-6a8506099945?w=600&q=80&auto=format",
            rewards: ["Late Check-out 14h", "Acc√®s Spa Gratuit", "Surclassement Chambre", "Petit-D√©jeuner Offert", "Bouteille de Vin en Chambre", "Transfert A√©roport", "Minibar Offert", "Massage 30min"],
            insights: [
                { label: "Bruit couloirs", count: 22, severity: "high" },
                { label: "Petit-d√©j incomplet", count: 15, severity: "high" },
                { label: "Climatisation bruyante", count: 6, severity: "medium" }
            ],
            kpis: { reviews: '+45', timeSaved: '32h', roi: '4 500 ‚Ç¨' },
            winbackOptions: [
                { val: 'none', label: 'Ne rien offrir' },
                { val: 'upgrade', label: 'üóùÔ∏è Surclassement prochaine visite' },
                { val: 'breakfast', label: 'ü•ê Petit-d√©jeuner offert' },
                { val: 'wine', label: 'üç∑ Bouteille de vin en chambre' },
                { val: 'spa', label: 'üßñ Acc√®s Spa 1h offert' }
            ]
        },
        airbnb: {
            name: "Airbnb & Conciergerie",
            emoji: "üîë",
            img: "https://images.unsplash.com/photo-1512918728675-ed5a9ecdebfd?w=600&q=80&auto=format",
            rewards: ["Late Check-out 13h", "-15% Prochain S√©jour", "Panier de Bienvenue Local", "Bouteille de Vin R√©gional", "Guide Touristique Perso", "M√©nage Offert", "Early Check-in"],
            insights: [
                { label: "Poussi√®re SdB", count: 10, severity: "high" },
                { label: "Bruit rue", count: 3, severity: "low" },
                { label: "WiFi lent", count: 2, severity: "low" }
            ],
            kpis: { reviews: '+28', timeSaved: '18h', roi: '2 100 ‚Ç¨' },
            winbackOptions: [
                { val: 'none', label: 'Ne rien offrir' },
                { val: 'discount', label: 'üìâ -15% Prochain S√©jour' },
                { val: 'latecheckout', label: '‚è∞ Late Check-out offert' },
                { val: 'wine', label: 'üç∑ Bouteille de vin r√©gional' },
                { val: 'basket', label: 'üß∫ Panier local de bienvenue' }
            ]
        },
        beauty: {
            name: "Coiffure & Beaut√©",
            emoji: "‚úÇÔ∏è",
            img: "https://images.unsplash.com/photo-1560066984-138dadb4c035?w=600&q=80&auto=format",
            rewards: ["Soin Profond Offert", "Massage Cr√¢nien 15min", "-15% Produits Boutique", "√âchantillons Premium", "Brushing Express Offert", "Masque Capillaire"],
            insights: [
                { label: "Retard sur rdv", count: 8, severity: "high" },
                { label: "Coupe trop courte", count: 3, severity: "medium" },
                { label: "Produits manquants", count: 2, severity: "low" }
            ],
            kpis: { reviews: '+62', timeSaved: '8h', roi: '950 ‚Ç¨' },
            winbackOptions: [
                { val: 'none', label: 'Ne rien offrir' },
                { val: 'care', label: 'üíÜ‚Äç‚ôÄÔ∏è Soin profond offert' },
                { val: 'discount', label: 'üõçÔ∏è -15% sur boutique' },
                { val: 'brushing', label: 'üíá‚Äç‚ôÄÔ∏è Brushing offert' }
            ]
        },
        retail: {
            name: "Boutique & Retail",
            emoji: "üõçÔ∏è",
            img: "https://images.unsplash.com/photo-1441986300917-64674bd600d8?w=600&q=80&auto=format",
            rewards: ["-10% Imm√©diat", "Tote Bag Exclusif", "Statut VIP Fid√©lit√©", "Cadeau Surprise", "Livraison Offerte", "Emballage Cadeau Premium"],
            insights: [
                { label: "Manque de tailles", count: 14, severity: "high" },
                { label: "Attente en caisse", count: 9, severity: "medium" },
                { label: "√âclairage cabines", count: 3, severity: "low" }
            ],
            kpis: { reviews: '+95', timeSaved: '10h', roi: '1 600 ‚Ç¨' },
            winbackOptions: [
                { val: 'none', label: 'Ne rien offrir' },
                { val: 'discount', label: 'üìâ -10% prochaine visite' },
                { val: 'gift', label: 'üéÅ Cadeau surprise offert' },
                { val: 'shipping', label: 'üì¶ Livraison offerte' }
            ]
        },
        bakery: {
            name: "Boulangerie & P√¢tisserie",
            emoji: "ü•ê",
            img: "https://images.unsplash.com/photo-1509440159596-0249088772ff?w=600&q=80&auto=format",
            rewards: ["Viennoiserie Offerte", "Caf√© Offert", "Pain Sp√©cial du Jour", "P√¢tisserie au Choix", "Macaron Offert", "Carte Fid√©lit√© x2"],
            insights: [
                { label: "File d'attente", count: 9, severity: "high" },
                { label: "Rupture produits", count: 5, severity: "medium" },
                { label: "Prix √©lev√©s", count: 3, severity: "low" }
            ],
            kpis: { reviews: '+130', timeSaved: '10h', roi: '980 ‚Ç¨' },
            winbackOptions: [
                { val: 'none', label: 'Ne rien offrir' },
                { val: 'pastry', label: 'ü•ê Viennoiserie offerte' },
                { val: 'coffee', label: '‚òï Caf√© offert' }
            ]
        },
        gym: {
            name: "Salle de Sport & Fitness",
            emoji: "üí™",
            img: "https://images.unsplash.com/photo-1534438327276-14e5300c3a48?w=600&q=80&auto=format",
            rewards: ["S√©ance Coaching Offerte", "1 Semaine Offerte", "Boisson Prot√©in√©e", "Serviette Branded", "Cours Collectif VIP", "Assessment Gratuit"],
            insights: [
                { label: "Machines occup√©es", count: 15, severity: "high" },
                { label: "Propret√© vestiaires", count: 7, severity: "medium" },
                { label: "Musique trop forte", count: 3, severity: "low" }
            ],
            kpis: { reviews: '+72', timeSaved: '14h', roi: '1 100 ‚Ç¨' },
            winbackOptions: [
                { val: 'none', label: 'Ne rien offrir' },
                { val: 'session', label: 'üèãÔ∏è S√©ance coaching offerte' },
                { val: 'week', label: 'üìÖ 1 semaine offerte' }
            ]
        },
        garage: {
            name: "Garage & Auto",
            emoji: "üîß",
            img: "https://images.unsplash.com/photo-1486262715619-67b85e0b08d3?w=600&q=80&auto=format",
            rewards: ["Diagnostic Gratuit", "Lavage Int√©rieur Offert", "-10% Prochaine R√©vision", "Contr√¥le Pression Pneus", "Liquide Lave-Glace Offert", "D√©sodorisant Offert"],
            insights: [
                { label: "D√©lais trop longs", count: 18, severity: "high" },
                { label: "Devis impr√©cis", count: 8, severity: "medium" },
                { label: "Communication", count: 4, severity: "low" }
            ],
            kpis: { reviews: '+38', timeSaved: '20h', roi: '2 200 ‚Ç¨' },
            winbackOptions: [
                { val: 'none', label: 'Ne rien offrir' },
                { val: 'diag', label: 'üîç Diagnostic gratuit' },
                { val: 'wash', label: 'üßΩ Lavage int√©rieur offert' },
                { val: 'discount', label: 'üìâ -10% prochaine r√©vision' }
            ]
        }
    };

    // Reviews array ‚Äî populated from Supabase or manual input (no more fake mock data)
    const mockMessages = [];

    // ============================================
    // STATE
    // ============================================
    let currentInd = 'restaurant';
    let currentRew = "Dessert Offert";
    let currentFilter = 'all';
    let currentMessageId = 1;
    let currentAiTone = 'professional'; // professional, casual, warm, humor
    let googleMapsUrl = ''; // Deep-link Google Maps
    let reputationScore = 87; // Score de r√©putation /100

    // ============================================
    // VIEW SWITCHING
    // ============================================
    function switchMasterView(view) {
        const vM = document.getElementById('view-merchant');
        const vC = document.getElementById('view-customer');
        const bM = document.getElementById('btn-merchant');
        const bC = document.getElementById('btn-customer');
        if (!vM || !vC || !bM || !bC) return;

        vM.className = `app-view flex h-[100dvh] w-full flex-col md:flex-row pb-20 md:pb-0 ${view === 'merchant' ? 'view-active' : 'view-hidden'}`;
        vC.className = `app-view h-[100dvh] w-full flex items-center justify-center px-4 ${view === 'customer' ? 'view-active' : 'view-hidden'}`;

        bM.className = `px-5 md:px-8 py-2.5 rounded-xl text-xs md:text-sm font-bold transition-all duration-300 whitespace-nowrap ${view === 'merchant' ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-400 hover:text-white'}`;
        bC.className = `px-5 md:px-8 py-2.5 rounded-xl text-xs md:text-sm font-bold transition-all duration-300 whitespace-nowrap ${view === 'customer' ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-400 hover:text-white'}`;

        if (view === 'customer') updateCustomerApp();
    }

    // ============================================
    // TAB NAVIGATION
    // ============================================
    function switchTab(tab) {
        const tabs = ['analytics', 'triage', 'portal', 'history', 'integrations', 'fortune', 'team', 'settings'];

        tabs.forEach(t => {
            const content = document.getElementById('tab-' + t);
            const dBtn = document.getElementById('nav-' + t + '-desk');
            const mBtn = document.getElementById('nav-' + t + '-mob');

            if (content) content.classList.add('hidden');
            if (dBtn) {
                dBtn.classList.remove('bg-brand/10', 'text-brand-light', 'active');
                dBtn.classList.add('text-slate-400');
            }
            if (mBtn) {
                mBtn.classList.remove('text-brand', 'active');
                mBtn.classList.add('text-slate-500');
            }
        });

        const activeContent = document.getElementById('tab-' + tab);
        const dBtnActive = document.getElementById('nav-' + tab + '-desk');
        const mBtnActive = document.getElementById('nav-' + tab + '-mob');

        if (activeContent) activeContent.classList.remove('hidden');
        if (dBtnActive) {
            dBtnActive.classList.remove('text-slate-400');
            dBtnActive.classList.add('bg-brand/10', 'text-brand-light', 'active');
        }
        if (mBtnActive) {
            mBtnActive.classList.remove('text-slate-500');
            mBtnActive.classList.add('text-brand', 'active');
        }

        if (tab === 'portal') { updateInd(); updateShortLink(); }
        if (tab === 'triage') { renderMessages(); regenerateDraft(); }
        if (tab === 'history') renderHistory();
        if (tab === 'settings') { renderSubscriptionPlans(); generateWidgetCode(); }
    }

    // ============================================
    // MESSAGE FILTERING & RENDERING
    // ============================================
    function setFilter(platform) {
        currentFilter = platform;
        const filters = ['all', 'google', 'airbnb', 'thefork', 'booking', 'tripadvisor', 'trustpilot', 'facebook', 'instagram', 'expedia'];
        filters.forEach(b => {
            const el = document.getElementById('filter-' + b);
            if (!el) return;
            const isActive = platform === b;
            el.className = `px-3 py-1.5 text-xs font-bold rounded-lg cursor-pointer transition-all whitespace-nowrap ${isActive ? 'bg-white/10 text-white' : 'text-slate-400 hover:text-white hover:bg-white/5'}`;
            el.setAttribute('aria-selected', isActive);
        });
        renderMessages();
        savePrefs();
    }

    // Load real reviews from Supabase (replaces mockMessages when available)
    let realReviews = null;
    async function loadSupabaseReviews() {
        if (!USE_SUPABASE || !supabaseClient) return;
        try {
            const { data, error } = await supabaseClient
                .from('reviews')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(50);
            if (!error && data && data.length > 0) {
                realReviews = data.map((r, i) => ({
                    id: r.id || i + 100,
                    platform: r.platform || 'google',
                    icon: platformIcon(r.platform),
                    color: platformColor(r.platform),
                    author: r.author_name || 'Client',
                    time: timeAgo(r.published_at || r.created_at),
                    rating: r.rating,
                    text: r.text || '',
                    baseDraft: '',
                    supabase_id: r.id,
                }));
                renderMessages();
            }
        } catch (e) { console.warn('Supabase reviews load error:', e); }
    }
    // platformIcon() et platformColor() d√©finis plus bas (section ajout manuel d'avis)
    function timeAgo(dateStr) {
        if (!dateStr) return '';
        const diff = Date.now() - new Date(dateStr).getTime();
        const mins = Math.floor(diff / 60000);
        if (mins < 60) return `Il y a ${mins}min`;
        const hours = Math.floor(mins / 60);
        if (hours < 24) return `Il y a ${hours}h`;
        const days = Math.floor(hours / 24);
        return days === 1 ? 'Hier' : `Il y a ${days}j`;
    }

    function renderMessages() {
        const container = document.getElementById('message-list-container');
        if (!container) return;

        const messages = realReviews || (mockMessages.length > 0 ? mockMessages : null);
        const filtered = messages ? messages.filter(m => currentFilter === 'all' || m.platform === currentFilter) : [];

        if (filtered.length === 0) {
            const isFilterActive = currentFilter !== 'all';
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-slate-500 py-16">
                    <div class="w-16 h-16 rounded-2xl bg-white/5 flex items-center justify-center mb-4">
                        <i class="fa-solid ${isFilterActive ? 'fa-filter' : 'fa-comments'} text-2xl"></i>
                    </div>
                    <p class="text-sm font-bold text-center">${isFilterActive ? 'Aucun avis sur cette plateforme' : 'Aucun avis pour le moment'}</p>
                    <p class="text-xs text-slate-600 mt-1 text-center max-w-[260px]">${isFilterActive ? 'Essayez un autre filtre' : 'Connectez Google ou ajoutez un avis manuellement pour commencer'}</p>
                    ${!isFilterActive ? '<button onclick="openManualReviewModal()" class="mt-4 px-4 py-2 bg-brand/20 text-brand-light rounded-lg text-xs font-bold hover:bg-brand/30 transition-all"><i class="fa-solid fa-plus mr-1.5"></i>Ajouter un avis</button>' : ''}
                </div>`;
            return;
        }

        container.innerHTML = filtered.map(m => {
            const platformName = m.platform.charAt(0).toUpperCase() + m.platform.slice(1);
            const isActive = m.id === currentMessageId;
            return `
                <div onclick="selectMessage(${m.id})" class="message-item p-4 rounded-xl cursor-pointer border ${isActive ? 'active border-brand/30' : 'border-transparent'}" role="button" tabindex="0" aria-label="Avis de ${escapeHtml(m.author)}">
                    <div class="flex justify-between items-center mb-2">
                        <span class="platform-badge"><i class="${m.icon} ${m.color} mr-1"></i> ${platformName}</span>
                        <span class="text-[10px] text-slate-500 font-medium">${m.time}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <p class="text-sm font-bold text-white">${escapeHtml(m.author)}</p>
                        <div class="flex gap-0.5">
                            ${[1,2,3,4,5].map(i => `<i class="fa-solid fa-star text-[10px] ${i <= m.rating ? 'text-yellow-400' : 'text-slate-700'}"></i>`).join('')}
                        </div>
                    </div>
                    <p class="text-xs text-slate-400 line-clamp-2 mt-1.5 leading-relaxed">"${escapeHtml(m.text)}"</p>
                </div>`;
        }).join('');
    }

    function selectMessage(id) {
        currentMessageId = id;
        renderMessages();
        regenerateDraft();
    }

    // ============================================
    // AI DRAFT & WIN-BACK
    // ============================================
    let isGenerating = false;

    async function regenerateDraft() {
        const winback = document.getElementById('winback-selector');
        const textarea = document.getElementById('ai-draft-textarea');
        if (!textarea) return;

        const msg = (realReviews || mockMessages).find(m => m.id === currentMessageId);
        if (!msg) return;

        const data = industries[currentInd];
        const winbackVal = winback ? winback.value : 'none';
        const winbackLabel = (winback && winbackVal !== 'none')
            ? winback.options[winback.selectedIndex].text.replace(/^[^\w]*/, '').trim()
            : null;

        const regenBtn = document.querySelector('[onclick="regenerateDraft()"]');
        if (regenBtn) {
            regenBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> G√©n√©ration...';
            regenBtn.classList.add('opacity-50', 'pointer-events-none');
        }

        if (getActiveApiKey() && !isGenerating) {
            isGenerating = true;
            textarea.value = "ü§ñ L'IA g√©n√®re votre r√©ponse personnalis√©e...";
            textarea.style.opacity = '0.5';
            textarea.classList.add('shimmer');

            const aiResponse = await generateAIResponse(
                msg.text,
                msg.rating,
                msg.author,
                msg.platform,
                data ? data.name : 'Commerce',
                winbackLabel,
                msg.lang || 'fr'
            );

            textarea.classList.remove('shimmer');
            isGenerating = false;

            if (aiResponse) {
                textarea.value = aiResponse;
                textarea.style.opacity = '1';
                if (regenBtn) {
                    regenBtn.innerHTML = '<i class="fa-solid fa-rotate-right"></i> R√©g√©n√©rer';
                    regenBtn.classList.remove('opacity-50', 'pointer-events-none');
                }
                return;
            }

            showToast('Erreur IA', 'Impossible de g√©n√©rer la r√©ponse. V√©rifiez votre cl√© API.', 'error');
            textarea.style.opacity = '1';
        }

        let draft = msg.baseDraft;

        if (winbackVal !== 'none' && winbackLabel) {
            const code = "RWD-" + Math.floor(Math.random() * 9000 + 1000) + "-WB";
            draft += `\n\nüéÅ Pour vous remercier de votre retour et vous t√©moigner notre bonne foi, nous serions ravis de vous offrir : ${winbackLabel} lors de votre prochaine visite.\n\nPr√©sentez simplement ce code √† notre √©quipe : ${code}`;
        }

        if (!draft.endsWith("La Direction.")) {
            draft += "\n\n√Ä tr√®s vite,\nLa Direction.";
        }

        textarea.style.opacity = '0.3';
        textarea.value = draft;
        requestAnimationFrame(() => {
            textarea.style.opacity = '1';
        });

        if (regenBtn) {
            regenBtn.innerHTML = '<i class="fa-solid fa-rotate-right"></i> R√©g√©n√©rer';
            regenBtn.classList.remove('opacity-50', 'pointer-events-none');
        }
    }

    // ============================================
    // PUBLISH RESPONSE
    // ============================================
    async function publishAIResponse() {
        const btn = document.getElementById('publish-action-btn');
        const toast = document.getElementById('toast-notification');
        const toggle = document.getElementById('auto-pilot-toggle');
        if (!btn || !toast) return;
        if (toggle && toggle.checked) return;

        const originalHTML = btn.innerHTML;
        btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-2"></i> Publication en cours...`;
        btn.classList.add('opacity-70', 'pointer-events-none');

        const msg = (realReviews || mockMessages).find(m => m.id === currentMessageId);
        const draft = document.getElementById('ai-draft-textarea')?.value || '';

        // Try publishing via Supabase Edge Function (real publish to platform)
        let published = false;
        if (USE_SUPABASE && supabaseClient && msg && draft) {
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (session) {
                    // If this is a Google review with a googleReviewId, publish to Google as well
                    if (msg.platform === 'google' && msg.googleReviewId) {
                        await replyToGoogleReview(msg.googleReviewId, draft);
                    }

                    const pubRes = await fetch(`${SUPABASE_URL}/functions/v1/publish-response`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${session.access_token}`,
                        },
                        body: JSON.stringify({
                            review_id: msg.id,
                            response_text: draft,
                            platform: msg.platform,
                        }),
                    });
                    if (pubRes.ok) published = true;
                }
            } catch (pubErr) {
                console.warn('Publish via Edge Function failed, saving locally:', pubErr);
            }
        }

        // Always save to local history
        setTimeout(() => {
            btn.innerHTML = `<i class="fa-solid fa-check mr-2 text-success"></i> ${published ? 'Publi√© !' : 'Sauvegard√© !'}`;
            toast.classList.add('show');

            if (msg && draft) {
                saveToHistory(msg.author, msg.rating, msg.platform, draft);
                reputationScore = Math.min(100, reputationScore + 2);
                animateReputationScore();
                // Remove from triage list
                if (realReviews) {
                    realReviews = realReviews.filter(m => m.id !== currentMessageId);
                }
            }

            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.classList.remove('opacity-70', 'pointer-events-none');
                toast.classList.remove('show');
            }, 3000);
        }, 1500);
    }

    // ============================================
    // GOOGLE BUSINESS PROFILE OAUTH
    // ============================================
    async function initGoogleOAuth() {
        try {
            const user = supabaseClient && supabaseClient.auth.getUser ? (await supabaseClient.auth.getUser()).data.user : null;
            const merchantId = user ? user.id : null;

            if (!merchantId) {
                showToast('Erreur', 'Veuillez vous connecter d\'abord', 'error');
                return;
            }

            const response = await fetch(`${SUPABASE_URL}/functions/v1/google-oauth`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${(await supabaseClient.auth.getSession()).data.session?.access_token}`
                },
                body: JSON.stringify({ action: 'init', merchant_id: merchantId })
            });

            const data = await response.json();
            if (data.url) {
                window.location.href = data.url;
            } else {
                showToast('Erreur', 'Erreur de connexion Google', 'error');
            }
        } catch (error) {
            console.error('Google OAuth error:', error);
            showToast('Erreur', 'Erreur de connexion Google', 'error');
        }
    }

    async function checkGoogleConnection() {
        try {
            if (!USE_SUPABASE || !supabaseClient) return;

            const user = supabaseClient.auth.getUser ? (await supabaseClient.auth.getUser()).data.user : null;
            if (!user) return;

            const { data, error } = await supabaseClient
                .from('google_tokens')
                .select('*')
                .eq('merchant_id', user.id)
                .single();

            if (data && !error) {
                document.getElementById('google-not-connected').classList.add('hidden');
                document.getElementById('google-connected').classList.remove('hidden');
                document.getElementById('google-no-gbp').classList.add('hidden');
                if (data.business_name) {
                    document.getElementById('google-business-name').textContent = data.business_name;
                }
            }
        } catch (e) {
            console.log('Google connection check:', e);
        }
    }

    async function fetchGoogleReviews() {
        try {
            if (!USE_SUPABASE || !supabaseClient) return;

            showToast('Synchronisation', 'Synchronisation des avis Google...', 'success');
            const session = (await supabaseClient.auth.getSession()).data.session;
            const user = (await supabaseClient.auth.getUser()).data.user;

            if (!session || !user) {
                showToast('Erreur', 'Session expir√©e', 'error');
                return;
            }

            const response = await fetch(`${SUPABASE_URL}/functions/v1/fetch-google-reviews`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${session.access_token}`
                },
                body: JSON.stringify({ merchant_id: user.id })
            });

            const data = await response.json();

            if (data.error === 'NO_LOCATIONS') {
                document.getElementById('google-connected').classList.add('hidden');
                document.getElementById('google-no-gbp').classList.remove('hidden');
                showToast('Info', 'Aucune fiche Google Business trouv√©e. Cr√©ez-en une gratuitement !', 'info');
                return;
            }

            if (data.reviews && data.reviews.length > 0) {
                displayGoogleReviews(data.reviews);
                showToast('Succ√®s', `${data.reviews.length} avis Google synchronis√©s !`, 'success');
            } else {
                showToast('Info', 'Aucun nouvel avis Google', 'info');
            }
        } catch (error) {
            console.error('Fetch reviews error:', error);
            showToast('Erreur', 'Erreur de synchronisation', 'error');
        }
    }

    function displayGoogleReviews(reviews) {
        reviews.forEach(review => {
            const starMap = {
                'FIVE': 5,
                'FOUR': 4,
                'THREE': 3,
                'TWO': 2,
                'ONE': 1
            };
            const reviewData = {
                id: review.reviewId,
                author: review.reviewer?.displayName || 'Client Google',
                rating: starMap[review.starRating] || 3,
                text: review.comment || '',
                platform: 'google',
                date: review.createTime,
                googleReviewId: review.name
            };

            const existingIndex = mockMessages.findIndex(r => r.googleReviewId === reviewData.googleReviewId);
            if (existingIndex === -1) {
                mockMessages.unshift(reviewData);
            }
        });

        renderMessages();
    }

    async function replyToGoogleReview(reviewName, comment) {
        try {
            if (!USE_SUPABASE || !supabaseClient) {
                console.error('Supabase not available');
                return { success: false };
            }

            const session = (await supabaseClient.auth.getSession()).data.session;
            const user = (await supabaseClient.auth.getUser()).data.user;

            if (!session || !user) {
                console.error('No session or user');
                return { success: false };
            }

            const response = await fetch(`${SUPABASE_URL}/functions/v1/reply-google-review`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${session.access_token}`
                },
                body: JSON.stringify({
                    merchant_id: user.id,
                    review_id: reviewName,
                    comment: comment
                })
            });

            const data = await response.json();
            if (data.success) {
                showToast('Succ√®s', 'R√©ponse publi√©e sur Google !', 'success');
            } else {
                showToast('Erreur', 'Erreur: ' + (data.error || 'Publication √©chou√©e'), 'error');
            }
            return data;
        } catch (error) {
            console.error('Reply error:', error);
            showToast('Erreur', 'Erreur de publication', 'error');
            return { success: false };
        }
    }

    async function disconnectGoogle() {
        if (!confirm('D√©connecter votre Google Business Profile ?')) return;
        try {
            if (!USE_SUPABASE || !supabaseClient) return;

            const user = (await supabaseClient.auth.getUser()).data.user;
            if (!user) return;

            await supabaseClient.from('google_tokens').delete().eq('merchant_id', user.id);

            document.getElementById('google-not-connected').classList.remove('hidden');
            document.getElementById('google-connected').classList.add('hidden');
            document.getElementById('google-no-gbp').classList.add('hidden');

            showToast('Info', 'Google d√©connect√©', 'info');
        } catch (e) {
            console.error('Disconnect error:', e);
            showToast('Erreur', 'Erreur de d√©connexion', 'error');
        }
    }

    async function handleGoogleCallback() {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('google_connected') === 'true') {
            showToast('Succ√®s', 'Google Business Profile connect√© avec succ√®s !', 'success');
            window.history.replaceState({}, '', window.location.pathname);
            setTimeout(checkGoogleConnection, 1000);
        }
        if (urlParams.get('google_error')) {
            showToast('Erreur', 'Erreur de connexion Google: ' + urlParams.get('google_error'), 'error');
            window.history.replaceState({}, '', window.location.pathname);
        }
    }

    // ============================================
    // AUTO-PILOT
    // ============================================
    function toggleAutoPilot() {
        const toggle = document.getElementById('auto-pilot-toggle');
        const btn = document.getElementById('publish-action-btn');
        const textarea = document.getElementById('ai-draft-textarea');
        const winbackContainer = document.getElementById('winback-container');
        if (!toggle || !btn || !textarea || !winbackContainer) return;

        toggle.setAttribute('aria-checked', toggle.checked);

        if (toggle.checked) {
            btn.innerHTML = `<i class="fa-solid fa-bolt text-yellow-400 mr-2"></i> Mode Auto-Pilot activ√©`;
            btn.className = "mt-4 bg-success/20 text-success border border-success/40 font-bold py-3.5 rounded-xl w-full flex justify-center items-center cursor-default transition-all";
            textarea.setAttribute('readonly', 'true');
            textarea.classList.add('opacity-50', 'cursor-not-allowed');
            winbackContainer.classList.add('opacity-50', 'pointer-events-none');
        } else {
            btn.innerHTML = `<span>Publier la r√©ponse <i class="fa-solid fa-paper-plane ml-2"></i></span>`;
            btn.className = "btn-primary mt-4 w-full flex justify-center items-center relative overflow-hidden";
            textarea.removeAttribute('readonly');
            textarea.classList.remove('opacity-50', 'cursor-not-allowed');
            winbackContainer.classList.remove('opacity-50', 'pointer-events-none');
        }
        // Persist auto-pilot state
        try { localStorage.setItem('repward_auto_pilot', toggle.checked ? '1' : '0'); } catch(e) {}
        // Sync to Supabase if connected
        if (USE_SUPABASE && supabaseClient && supabaseMerchant) {
            supabaseClient.from('merchants').update({ auto_pilot: toggle.checked }).eq('id', supabaseMerchant.id).then(() => {});
        }
        savePrefs();
    }

    // ============================================
    // STRIPE REDIRECT
    // ============================================
    function redirectToStripe(planId) {
        const plan = subscriptionPlans.find(p => p.id === (planId || 'pro'));
        if (plan && plan.stripeUrl) {
            window.open(plan.stripeUrl, '_blank', 'noopener,noreferrer');
        }
    }

    // ============================================
    // INDUSTRY UPDATE
    // ============================================
    function updatePortalIndustryBadge(industryKey) {
        const industryInfo = {
            restaurant: { emoji: 'üçΩÔ∏è', label: 'Restaurant & Bar' },
            coffee: { emoji: '‚òï', label: 'Coffee Shop' },
            streetfood: { emoji: 'üåÆ', label: 'Street Food' },
            hotel: { emoji: 'üè®', label: 'H√¥tel & Spa' },
            airbnb: { emoji: 'üîë', label: 'Airbnb' },
            beauty: { emoji: '‚úÇÔ∏è', label: 'Coiffure & Beaut√©' },
            retail: { emoji: 'üõçÔ∏è', label: 'Boutique & Retail' },
            bakery: { emoji: 'ü•ê', label: 'Boulangerie & P√¢tisserie' },
            gym: { emoji: 'üí™', label: 'Sport & Fitness' },
            garage: { emoji: 'üîß', label: 'Garage & Auto' }
        };
        const info = industryInfo[industryKey] || industryInfo.restaurant;
        const emojiEl = document.getElementById('portal-industry-emoji');
        const nameEl = document.getElementById('portal-industry-name');
        if (emojiEl) emojiEl.textContent = info.emoji;
        if (nameEl) nameEl.textContent = info.label;
    }

    function updateInd() {
        const indSelector = document.getElementById('ind-selector');
        if (!indSelector) return;

        currentInd = indSelector.value;
        const data = industries[currentInd];
        if (!data) return;

        const kpiMap = { 'kpi-reviews': data.kpis.reviews, 'kpi-time': data.kpis.timeSaved, 'kpi-roi': data.kpis.roi };
        Object.entries(kpiMap).forEach(([id, val]) => {
            const el = document.getElementById(id);
            if (el) el.textContent = val;
        });

        const insDiv = document.getElementById('ai-insights');
        if (insDiv) {
            const maxCount = Math.max(...data.insights.map(i => i.count));
            insDiv.innerHTML = data.insights.map(i => {
                const pct = Math.round((i.count / maxCount) * 100);
                const severityColor = i.severity === 'high' ? 'bg-danger' : i.severity === 'medium' ? 'bg-warning' : 'bg-slate-500';
                const badgeColor = i.severity === 'high' ? 'bg-danger/20 text-danger' : i.severity === 'medium' ? 'bg-warning/20 text-warning' : 'bg-slate-700 text-slate-400';
                return `
                    <div class="p-3.5 bg-white/[0.03] border border-white/5 rounded-xl">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm text-white font-medium flex items-center gap-2">
                                <i class="fa-solid fa-triangle-exclamation text-xs ${i.severity === 'high' ? 'text-danger' : i.severity === 'medium' ? 'text-warning' : 'text-slate-500'}"></i>
                                ${i.label}
                            </span>
                            <span class="text-[10px] ${badgeColor} px-2 py-1 rounded-md font-bold">${i.count} mentions</span>
                        </div>
                        <div class="w-full bg-slate-800 rounded-full h-1.5 overflow-hidden">
                            <div class="insight-bar ${severityColor} h-1.5 rounded-full" style="width: ${pct}%">
                    </div>`;
            }).join('');
        }

        const grid = document.getElementById('rew-grid');
        if (grid) {
            if (!data.rewards.includes(currentRew) && !currentRew.startsWith('‚úèÔ∏è')) currentRew = data.rewards[0];
            const isCustomActive = !data.rewards.includes(currentRew);
            grid.innerHTML = data.rewards.map(r => `
                <div onclick="setRew('${r.replace(/'/g, "\\'")}', this)" class="reward-card p-2 border rounded-lg text-[11px] font-bold text-center cursor-pointer flex items-center justify-center min-h-[48px] transition-all leading-tight tabindex='0' role='button' ${r === currentRew ? 'selected border-brand bg-brand/10 text-white' : 'border-white/10 text-slate-300 hover:bg-white/5 hover:border-white/20'}">
                    ${r}
                </div>`).join('') + `
                <div onclick="showCustomRewardInput()" class="reward-card p-2 border rounded-lg text-[11px] font-bold text-center cursor-pointer flex items-center justify-center min-h-[48px] transition-all leading-tight ${isCustomActive ? 'selected border-brand bg-brand/10 text-white' : 'border-dashed border-white/20 text-slate-400 hover:bg-white/5 hover:border-white/30'}">
                    ‚úèÔ∏è Autre
                </div>`;
        }

        const winbackSelect = document.getElementById('winback-selector');
        if (winbackSelect) {
            winbackSelect.innerHTML = data.winbackOptions.map(opt => `<option value="${opt.val}" style="background:#0f172a;color:#f8fafc">${opt.label}</option>`).join('');
            regenerateDraft();
        }

        updateCustomerApp();
        savePrefs();
    }

    function setRew(r, el) {
        currentRew = r;
        document.querySelectorAll('.reward-card').forEach(c => {
            c.classList.remove('selected', 'border-brand', 'bg-brand/10', 'text-white');
            c.classList.add('border-white/10', 'text-slate-300', 'hover:bg-white/5', 'hover:border-white/20');
        });
        if (el) {
            el.classList.remove('border-white/10', 'text-slate-300', 'hover:bg-white/5', 'hover:border-white/20');
            el.classList.add('selected', 'border-brand', 'bg-brand/10', 'text-white');
        }
        updateCustomerApp();
        savePrefs();
    }

    function showCustomRewardInput() {
        const grid = document.getElementById('rew-grid');
        if (!grid) return;
        // Check if already showing input
        if (document.getElementById('custom-reward-input')) {
            document.getElementById('custom-reward-input').focus();
            return;
        }
        const inputDiv = document.createElement('div');
        inputDiv.className = 'col-span-3 flex gap-2 mt-1';
        inputDiv.innerHTML = `
            <input id="custom-reward-input" type="text" maxlength="40" placeholder="Ex: Cocktail offert" class="flex-1 bg-slate-900/50 border border-brand/30 rounded-lg px-3 py-2 text-xs text-white placeholder-slate-500 focus:outline-none focus:border-brand focus:ring-1 focus:ring-brand/30" autofocus />
            <button onclick="applyCustomReward()" class="px-3 py-2 bg-brand/20 text-brand-light border border-brand/30 rounded-lg text-xs font-bold hover:bg-brand/30 transition-all">OK</button>
        `;
        grid.appendChild(inputDiv);
        document.getElementById('custom-reward-input').focus();
        document.getElementById('custom-reward-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') applyCustomReward();
        });
    }

    async function applyCustomReward() {
        const input = document.getElementById('custom-reward-input');
        if (!input) return;
        const val = input.value.trim();
        if (!val) { showToast('Erreur', 'Entrez une r√©compense', 'error'); return; }
        // Save to localStorage
        try { localStorage.setItem('repward_custom_reward', val); } catch(e) {}
        // Save to Supabase merchants table
        if (USE_SUPABASE && supabaseClient && supabaseMerchant) {
            try {
                await supabaseClient.from('merchants').update({ custom_reward: val }).eq('id', supabaseMerchant.id);
            } catch(e) { console.error('Custom reward save error:', e); }
        }
        setRew(val, null);
        updateInd(); // Refresh grid to show selected state
        showToast('R√©compense personnalis√©e', val, 'success');
    }

    // ============================================
    // CUSTOMER APP (MOBILE PREVIEW)
    // ============================================
    function updateCustomerApp() {
        const data = industries[currentInd];
        if (!data) return;

        const theme = industryThemes[currentInd] || industryThemes.restaurant;
        const app = document.getElementById('app-customer-container');
        const preview = document.getElementById('preview-screen');

        const getHtml = (isInteractive) => {
            const starsId = isInteractive ? 'id="mobile-stars"' : '';
            const btnId = isInteractive ? 'id="btn-publish-review"' : '';
            const rewardDisplayId = isInteractive ? 'id="reward-display"' : '';
            const rewardMsgId = isInteractive ? 'id="reward-message"' : '';
            const onStarClick = isInteractive ? (i) => `onclick="selectStar(${i})"` : () => '';
            const onBtnClick = isInteractive ? `onclick="claim()"` : '';
            const pointerCls = isInteractive ? 'cursor-pointer' : '';

            return `
                <div class="flex flex-col h-full bg-slate-50 overflow-y-auto">
                    <div class="h-48 md:h-52 bg-cover bg-center shrink-0 relative" style="background-image: url('${escapeHtml(data.img)}')">
                        <div class="absolute inset-0 bg-gradient-to-t from-slate-50 via-transparent to-transparent"></div>
                    </div>
                    <div class="px-5 -mt-8 flex-1 flex flex-col items-center pb-8 relative z-10">
                        <div class="bg-white w-full rounded-2xl shadow-sm border border-slate-100 p-5 text-center mb-5">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br ${theme.gradient} flex items-center justify-center mx-auto mb-3 shadow-lg" style="box-shadow: 0 10px 25px -5px ${theme.primary}40">
                                <span class="text-xl">${data.emoji || '‚≠ê'}</span>
                            </div>
                            <h2 class="text-xl font-black text-slate-800">${escapeHtml(data.name)}</h2>
                            <p class="text-xs text-slate-500 font-medium mt-1">Merci pour votre visite !</p>
                        </div>

                        <div class="w-full bg-gradient-to-br ${theme.gradient} text-white rounded-[20px] p-6 shadow-xl text-center mb-6 relative overflow-hidden" style="box-shadow: 0 20px 40px -10px ${theme.primary}40">
                            <div class="absolute -right-8 -top-8 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                            <div class="absolute -left-4 -bottom-4 w-24 h-24 bg-white/5 rounded-full blur-xl"></div>
                            <div class="bg-white text-slate-900 text-[10px] font-black uppercase tracking-widest px-3 py-1.5 rounded-full inline-block mb-3 shadow-sm relative z-10">Cadeau Imm√©diat</div>
                            <h3 class="text-2xl font-black mb-2 relative z-10" ${rewardDisplayId}>${escapeHtml(currentRew)}</h3>
                            <p class="text-xs text-white/90 font-medium relative z-10 leading-relaxed" ${rewardMsgId}>Laissez-nous 5 √©toiles pour<br>d√©bloquer votre cadeau</p>
                        </div>

                        <div class="bg-white w-full rounded-2xl p-6 text-center shadow-sm border border-slate-100">
                            <h4 class="font-bold text-slate-800 mb-1">Votre avis nous aide !</h4>
                            <p class="text-[11px] text-slate-400 mb-4">Touchez les √©toiles pour nous noter</p>
                            <div class="flex justify-center gap-2 mb-4" ${starsId}>
                                ${[1,2,3,4,5].map(i => `<i class="fa-solid fa-star text-3xl sm:text-4xl text-slate-200 transition-all duration-200 ${pointerCls} hover:scale-110" ${onStarClick(i)}></i>`).join('')}
                            </div>
                            ${isInteractive ? '<div id="vocal-review-section" class="mb-3 hidden"><textarea id="vocal-text" class="w-full p-3 rounded-xl border border-slate-200 text-xs text-slate-700 resize-none h-20 mb-2 focus:border-purple-400 focus:outline-none" placeholder="√âcrivez votre avis ici ou dictez-le..."></textarea><button onclick="startVocalReview()" id="btn-vocal" class="w-full py-2.5 rounded-xl text-xs font-bold bg-purple-50 text-purple-600 border border-purple-200 flex items-center justify-center gap-2 hover:bg-purple-100 transition-all"><i class="fa-solid fa-microphone"></i> Ou dicter mon avis (30s)</button></div>' : ''}
                            ${isInteractive ? '<div id="phone-collect-section" class="mb-3 hidden"><div class="flex items-center gap-2"><span class="text-lg">üéÅ</span><input id="client-phone" type="tel" placeholder="+33 6 12 34 56 78" class="flex-1 border border-slate-200 rounded-lg px-3 py-2 text-xs text-slate-700 focus:border-purple-400 outline-none"></div><p class="text-[9px] text-slate-400 mt-1">Optionnel ¬∑ Recevez votre code par SMS ¬∑ <a href="#" class="underline">RGPD</a></p></div>' : ''}
                            <button ${btnId} ${onBtnClick} class="w-full bg-slate-200 text-slate-400 py-3.5 rounded-xl font-bold flex items-center justify-center pointer-events-none transition-all text-sm">
                                S√©lectionnez vos √©toiles
                            </button>
                            ${isInteractive ? '<div id="loyalty-badge" class="hidden mt-3 p-2.5 bg-gradient-to-r from-yellow-50 to-amber-50 rounded-xl border border-yellow-200 text-center"><p class="text-[10px] font-bold text-amber-700"><i class="fa-solid fa-crown mr-1"></i> Programme VIP : <span id="loyalty-count">0</span>/5 avis ‚Äî Cadeau premium au 5√®me !</p></div>' : ''}
                </div>`;
        };

        if (app) app.innerHTML = getHtml(true);
        if (preview) {
            preview.innerHTML = getHtml(false);
            preview.style.pointerEvents = 'none';
        }
    }

    // ============================================
    // STAR RATING (Customer view)
    // ============================================
    let customerSelectedStars = 0;

    function selectStar(rating) {
        const customerView = document.getElementById('view-customer');
        if (!customerView) return;
        const starsContainer = customerView.querySelector('#mobile-stars');
        const btn = customerView.querySelector('#btn-publish-review');
        const rewardDisplay = customerView.querySelector('#reward-display');
        const rewardMsg = customerView.querySelector('#reward-message');
        if (!starsContainer || !btn) return;

        customerSelectedStars = rating;

        const stars = starsContainer.children;
        for (let i = 0; i < 5; i++) {
            const isActive = i < rating;
            stars[i].className = `fa-solid fa-star text-3xl sm:text-4xl cursor-pointer transition-all duration-200 hover:scale-110 ${isActive ? 'text-yellow-400 scale-110' : 'text-slate-200'}`;
        }

        // Adaptive rewards based on star rating
        const adaptedRewards = getRewardsByStars(currentInd, rating);

        if (rewardDisplay && rewardMsg) {
            if (rating === 5) {
                const rew = adaptedRewards.length > 0 ? adaptedRewards[0] : currentRew;
                rewardDisplay.textContent = rew;
                rewardMsg.innerHTML = 'üéâ Bravo ! Votre cadeau VIP<br>est d√©bloqu√© !';
            } else if (rating === 4) {
                const rew = adaptedRewards.length > 0 ? adaptedRewards[0] : 'Petit cadeau';
                rewardDisplay.textContent = rew;
                rewardMsg.innerHTML = 'Merci ! Un petit geste<br>pour vous remercier';
            } else if (rating === 3) {
                rewardDisplay.textContent = 'üí¨ Merci pour votre retour';
                rewardMsg.innerHTML = 'Votre avis nous aide √† nous am√©liorer';
            } else {
                rewardDisplay.textContent = 'üí¨ Nous sommes d√©sol√©s';
                rewardMsg.innerHTML = 'Aidez-nous √† comprendre pour<br>mieux vous servir';
            }
        }

        // Show/hide vocal, phone, loyalty sections
        const vocalSection = customerView.querySelector('#vocal-review-section');
        const phoneSection = customerView.querySelector('#phone-collect-section');
        const loyaltyBadge = customerView.querySelector('#loyalty-badge');
        if (vocalSection) vocalSection.classList.toggle('hidden', rating < 1);
        if (phoneSection) phoneSection.classList.toggle('hidden', rating < 4);
        if (loyaltyBadge) {
            loyaltyBadge.classList.remove('hidden');
            const cnt = getLoyaltyCount();
            const cntEl = loyaltyBadge.querySelector('#loyalty-count');
            if (cntEl) cntEl.textContent = cnt;
        }

        if (rating >= 4) {
            btn.classList.remove('pointer-events-none', 'bg-slate-200', 'text-slate-400');
            btn.classList.add('bg-google', 'text-white', 'shadow-lg', 'shadow-google/30', 'pointer-events-auto');
            btn.innerHTML = `<i class="fa-brands fa-google mr-2 text-lg"></i> Laisser un avis Google`;
        } else if (rating === 3) {
            btn.classList.remove('pointer-events-none', 'bg-google', 'text-white', 'shadow-lg', 'shadow-google/30');
            btn.classList.add('bg-slate-200', 'text-slate-500', 'pointer-events-auto');
            btn.innerHTML = `<i class="fa-solid fa-comment mr-2"></i> Valider mon avis`;
        } else if (rating >= 1) {
            btn.classList.remove('pointer-events-none', 'bg-google', 'text-white', 'shadow-lg', 'shadow-google/30');
            btn.classList.add('bg-slate-200', 'text-slate-500', 'pointer-events-auto');
            btn.innerHTML = `<i class="fa-solid fa-comment-dots mr-2"></i> Envoyer mon retour`;
        }
    }

    // ============================================
    // CLAIM REWARD (Customer view)
    // ============================================
    function claim() {
        const customerView = document.getElementById('view-customer');
        if (!customerView) return;
        const app = customerView.querySelector('#app-customer-container');
        if (!app) return;

        const theme = industryThemes[currentInd] || industryThemes.restaurant;
        const code = "RWD-" + Math.floor(Math.random() * 9000 + 1000);

        // Increment loyalty
        const loyalty = incrementLoyalty();

        // Track code generation for marketplace stats
        try {
            let stats = JSON.parse(localStorage.getItem('repward_code_stats') || '{"generated":0,"used":0}');
            stats.generated++;
            localStorage.setItem('repward_code_stats', JSON.stringify(stats));
        } catch(e) {}

        // Get the adapted reward for the selected stars
        const adaptedRewards = getRewardsByStars(currentInd, customerSelectedStars);
        let finalReward = adaptedRewards.length > 0 ? adaptedRewards[0] : currentRew;
        if (loyalty.vip && loyalty.count === 5) finalReward = 'üèÜ CADEAU VIP PREMIUM';

        // Store reward data for gift box
        app.dataset.code = code;
        app.dataset.reward = finalReward;
        app.dataset.theme = currentInd;

        // Pour 4-5‚òÖ avec Google Maps URL ‚Üí ouvrir Google Maps d'abord
        if (customerSelectedStars >= 4 && googleMapsUrl) {
            // Ouvrir Google Maps dans un nouvel onglet pour laisser un avis
            window.open(googleMapsUrl, '_blank', 'noopener');
            showToast('Google Maps', 'Laissez votre avis Google puis revenez ici pour votre cadeau !', 'success');
        }

        // Passer directement au cadeau/roue
        claimWithPhone(false);
    }

    function claimWithPhone(collectPhone) {
        const customerView = document.getElementById('view-customer');
        if (!customerView) return;
        const app = customerView.querySelector('#app-customer-container');
        if (!app) return;

        const theme = industryThemes[app.dataset.theme] || industryThemes.restaurant;

        // Collect phone if provided
        if (collectPhone) {
            const phoneInput = document.getElementById('claim-phone-input');
            const phone = phoneInput ? phoneInput.value.trim() : '';
            if (phone) {
                app.dataset.phone = phone;
                db.saveContact(phone, null, 'qr');
            }
        }

        // SI LA ROUE EST ACTIV√âE ET QU'IL A MIS 5 √âTOILES
        if (typeof fortuneEnabled !== 'undefined' && fortuneEnabled && customerSelectedStars === 5) {
            app.innerHTML = `
            <div class="flex flex-col h-full bg-gradient-to-b ${theme.gradient} items-center justify-center p-6 text-white text-center">
                <h2 class="text-2xl font-extrabold mb-6">Faites tourner la roue !</h2>
                <div class="wheel-wrapper" style="margin-bottom:2rem;">
                    <div class="wheel-pointer"></div>
                    <div class="wheel-container">
                        <canvas id="client-wheel-canvas" class="wheel-canvas"></canvas>
                    </div>
                </div>
                <button id="client-spin-btn" onclick="spinClientWheel()" class="wheel-btn w-full max-w-xs py-4 rounded-xl text-white font-extrabold shadow-2xl transition-all text-lg animate-pulse">
                    <i class="fa-solid fa-play mr-2"></i> Tenter ma chance !
                </button>
            </div>`;

            // Dessiner la roue pour le client
            setTimeout(() => {
                wheelCanvas = document.getElementById('client-wheel-canvas');
                if (wheelCanvas) {
                    wheelCtx = wheelCanvas.getContext('2d');
                    wheelCanvas.width = 300; wheelCanvas.height = 300;
                    drawWheel();
                }
            }, 100);
        } else {
            // CADEAU CLASSIQUE (Boite cadeau)
            app.innerHTML = `
            <div class="flex flex-col h-full bg-gradient-to-b ${theme.gradient} items-center justify-center p-6 text-white text-center">
                <div id="gift-box" class="cursor-pointer" onclick="revealReward()">
                    <div class="w-32 h-32 mx-auto relative" style="animation: float 2s ease-in-out infinite">
                        <div class="absolute inset-0 bg-white/10 rounded-2xl backdrop-blur-sm border-2 border-white/20 flex items-center justify-center">
                            <i class="fa-solid fa-gift text-6xl text-white drop-shadow-lg"></i>
                        </div>
                        <div class="absolute -top-2 -right-2 w-8 h-8 bg-yellow-400 rounded-full flex items-center justify-center text-xs font-black text-slate-900 animate-bounce shadow-lg">!</div>
                    </div>
                    <p class="text-xl font-extrabold mt-6 animate-pulse">Touchez pour ouvrir !</p>
                    <p class="text-sm text-white/60 mt-2">Votre cadeau vous attend...</p>
                </div>
            </div>`;
        }
    }

    // Animation de la roue pour le client
    function spinClientWheel() {
        const btn = document.getElementById('client-spin-btn');
        if (!btn || btn.disabled) return;
        btn.disabled = true;
        btn.classList.remove('animate-pulse');
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

        let currentRotation = 0;
        const spins = 1800 + Math.random() * 360;
        const duration = 3000;
        const startTime = Date.now();
        const canvas = document.getElementById('client-wheel-canvas');

        function animate() {
            const elapsed = Date.now() - startTime;
            const progress = Math.min(elapsed / duration, 1);
            const easeOut = 1 - Math.pow(1 - progress, 3);
            currentRotation = spins * easeOut;

            if (canvas) canvas.style.transform = `rotate(${currentRotation}deg)`;

            if (progress < 1) {
                requestAnimationFrame(animate);
            } else {
                const normalizedRotation = currentRotation % 360;
                const winningAngle = (360 - normalizedRotation + 270) % 360;
                const segmentIndex = Math.floor(winningAngle / (360 / wheelSegments.length));

                const app = document.querySelector('#app-customer-container');
                if (app && wheelSegments[segmentIndex]) {
                    app.dataset.reward = wheelSegments[segmentIndex].text;
                }

                setTimeout(() => {
                    revealReward();
                }, 800);
            }
        }
        animate();
    }

    function revealReward() {
        // Marquer le token QR comme utilis√© (anti-triche)
        markQrTokenUsed();

        const customerView = document.getElementById('view-customer');
        if (!customerView) return;
        const app = customerView.querySelector('#app-customer-container');
        if (!app) return;

        const theme = industryThemes[app.dataset.theme] || industryThemes.restaurant;
        const code = app.dataset.code;
        const finalReward = app.dataset.reward;

        // 48h expiry timer
        const expiry = new Date(Date.now() + 48 * 60 * 60 * 1000);
        const expiryStr = expiry.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });

        // Google Maps redirect for 5‚òÖ
        const gmapsRedirect = customerSelectedStars === 5 && googleMapsUrl
            ? `<div id="gmaps-redirect" class="mt-3 p-3 bg-google/10 border border-google/20 rounded-xl text-center">
                    <p class="text-xs text-google font-bold"><i class="fa-brands fa-google mr-1"></i> Redirection Google Maps dans <span id="gmaps-countdown">3</span>s...</p>
               </div>` : '';

        app.innerHTML = `
            <div class="flex flex-col h-full bg-gradient-to-b ${theme.gradient} items-center justify-center p-6 text-white text-center overflow-y-auto">
                <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center mb-4 shadow-2xl" style="box-shadow: 0 25px 50px -12px ${theme.primary}50; animation: bounceIn 0.6s ease">
                    <i class="fa-solid fa-check text-4xl" style="color: ${theme.primary}"></i>
                </div>
                <h2 class="text-2xl font-extrabold mb-1">Merci !</h2>
                <p class="text-sm text-white/80 mb-5">Votre avis compte √©norm√©ment</p>
                <div class="bg-white w-full rounded-3xl p-5 text-slate-900 shadow-2xl relative">
                    <div class="absolute -top-3 left-1/2 -translate-x-1/2 text-white text-[10px] font-black uppercase tracking-wider px-4 py-1.5 rounded-full whitespace-nowrap" style="background: ${theme.primary}">Votre Cadeau</div>
                    <h3 class="text-lg font-black mt-3 mb-3">${escapeHtml(finalReward)}</h3>
                    <div class="border-2 border-dashed border-slate-200 bg-slate-50 rounded-2xl py-4">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Code √† pr√©senter</p>
                        <p class="text-2xl font-mono font-black tracking-wider" style="color: ${theme.primary}">${escapeHtml(code)}</p>
                        <div id="reward-qr-container" class="mt-3 flex justify-center"><canvas id="reward-qr-canvas"></canvas></div>
                    </div>
                    <!-- 48h Timer -->
                    <div class="flex items-center justify-center gap-2 mt-3 text-[10px] text-slate-400">
                        <i class="fa-solid fa-clock text-warning"></i>
                        <span>Valable jusqu'au <strong class="text-slate-600">${expiryStr}</strong></span>
                    </div>
                    <!-- Share buttons -->
                    <div class="flex gap-2 mt-4">
                        <button onclick="shareReward('whatsapp','${escapeHtml(code)}','${escapeHtml(finalReward)}')" class="flex-1 py-2.5 rounded-xl text-xs font-bold bg-[#25D366]/10 text-[#25D366] border border-[#25D366]/20 hover:bg-[#25D366]/20 transition-all flex items-center justify-center gap-1.5">
                            <i class="fa-brands fa-whatsapp text-sm"></i> WhatsApp
                        </button>
                        <button onclick="shareReward('instagram','${escapeHtml(code)}','${escapeHtml(finalReward)}')" class="flex-1 py-2.5 rounded-xl text-xs font-bold bg-[#E1306C]/10 text-[#E1306C] border border-[#E1306C]/20 hover:bg-[#E1306C]/20 transition-all flex items-center justify-center gap-1.5">
                            <i class="fa-brands fa-instagram text-sm"></i> Instagram
                        </button>
                    </div>
                    <!-- Wallet buttons -->
                    <div class="flex gap-2 mt-2">
                        <button onclick="addToWallet('apple')" class="flex-1 py-2.5 rounded-xl text-xs font-bold bg-slate-900 text-white hover:bg-slate-800 transition-all flex items-center justify-center gap-1.5">
                            <i class="fa-brands fa-apple text-sm"></i> Apple Wallet
                        </button>
                        <button onclick="addToWallet('google')" class="flex-1 py-2.5 rounded-xl text-xs font-bold bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 transition-all flex items-center justify-center gap-1.5">
                            <i class="fa-brands fa-google text-sm"></i> Google Wallet
                        </button>
                    </div>
                    ${gmapsRedirect}
                </div>
                <button onclick="resetCustomerApp()" class="mt-5 text-sm font-bold text-white/60 hover:text-white transition-colors flex items-center gap-2">
                    <i class="fa-solid fa-arrow-left text-xs"></i> Retour
                </button>
            </div>`;

        // Confetti
        setTimeout(() => {
            if (typeof confetti === 'function') {
                confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 }, colors: ['#ffffff', theme.primary, theme.accent, '#10b981'] });
            }
        }, 300);

        // Generate QR code with the reward code for presentation
        setTimeout(() => {
            const qrCanvas = document.getElementById('reward-qr-canvas');
            if (qrCanvas && typeof QRCode !== 'undefined') {
                QRCode.toCanvas(qrCanvas, code, {
                    width: 140,
                    margin: 1,
                    color: { dark: '#0f172a', light: '#f8fafc' }
                }, function(err) {
                    if (err) console.error('Reward QR error:', err);
                });
            }
        }, 200);

        // Google Maps redirect countdown for 5‚òÖ
        if (customerSelectedStars === 5 && googleMapsUrl) {
            let countdown = 3;
            const timer = setInterval(() => {
                countdown--;
                const el = document.getElementById('gmaps-countdown');
                if (el) el.textContent = countdown;
                if (countdown <= 0) {
                    clearInterval(timer);
                    window.open(googleMapsUrl, '_blank', 'noopener');
                }
            }, 1000);
        }
    }

    // ============================================
    // SHARE REWARD (WhatsApp / Instagram)
    // ============================================
    function shareReward(platform, code, reward) {
        const text = encodeURIComponent('J\'ai re√ßu un cadeau : ' + reward + ' ! Mon code : ' + code + ' ‚Äî Merci Repward !');
        if (platform === 'whatsapp') {
            window.open('https://wa.me/?text=' + text, '_blank');
        } else if (platform === 'instagram') {
            // Instagram doesn't support direct text sharing ‚Äî copy to clipboard
            navigator.clipboard.writeText(decodeURIComponent(text)).then(() => {
                alert('Texte copi√© ! Collez-le dans votre story Instagram.');
            }).catch(() => {
                alert('Code : ' + code);
            });
        }
    }

    // ============================================
    // ADD TO WALLET (placeholder)
    // ============================================
    function addToWallet(type) {
        const msg = type === 'apple' ? 'Apple Wallet' : 'Google Wallet';
        alert('Fonctionnalit√© ' + msg + ' bient√¥t disponible ! Votre code a √©t√© copi√©.');
        try {
            const app = document.querySelector('#app-customer-container');
            if (app && app.dataset.code) navigator.clipboard.writeText(app.dataset.code);
        } catch(e) {}
    }

    function resetCustomerApp() {
        updateCustomerApp();
    }

    // ============================================
    // AI KEY MANAGEMENT (cl√© s√©curis√©e c√¥t√© serveur ‚Äî Edge Function)
    // ============================================
    function loadGeminiKey() { /* Cl√© g√©r√©e c√¥t√© serveur via Edge Function */ }
    function saveGeminiKey() { /* Obsol√®te ‚Äî cl√© c√¥t√© serveur */ }
    function getActiveApiKey() { return 'edge-function'; /* Plus de cl√© c√¥t√© client */ }
    function updateApiKeyStatus() {}
    function clearGeminiKey() {}

    // ============================================
    // RENDER SUBSCRIPTION PLANS (Settings tab)
    // ============================================
    function renderSubscriptionPlans() {
        const grid = document.getElementById('subscription-plans-grid');
        if (!grid) return;

        let currentPlan = 'starter';
        try { currentPlan = localStorage.getItem('repward_plan') || 'starter'; } catch(e) {}

        grid.innerHTML = subscriptionPlans.map(plan => {
            const isActive = plan.id === currentPlan;
            const isPopular = plan.popular;
            return `
                <div class="relative p-4 rounded-xl border transition-all ${isActive ? 'border-brand bg-brand/10 ring-2 ring-brand/30' : isPopular ? 'border-brand/40 bg-brand/5' : 'border-white/10 bg-white/[0.02] hover:border-white/20'}">
                    ${isPopular ? '<span class="absolute -top-2 right-3 bg-brand text-white text-[9px] font-black uppercase tracking-widest px-2.5 py-0.5 rounded-full">Populaire</span>' : ''}
                    ${plan.promo ? '<span class="absolute -top-2 left-3 bg-danger text-white text-[9px] font-black uppercase tracking-widest px-2.5 py-0.5 rounded-full animate-pulse-slow">' + plan.promo + '</span>' : ''}
                    ${isActive ? '<span class="absolute top-3 left-3 bg-success text-white text-[9px] font-black uppercase tracking-widest px-2.5 py-0.5 rounded-full">Actif</span>' : ''}
                    <div class="flex items-center justify-between mb-2 mt-2">
                        <div>
                            <h4 class="font-extrabold text-white text-sm">${plan.name}</h4>
                            <p class="text-[10px] text-slate-400">${plan.label}</p>
                        </div>
                        <div class="text-right">
                            ${plan.originalPrice ? '<span class="text-sm line-through text-slate-500 mr-1">' + plan.originalPrice + '‚Ç¨</span>' : ''}
                            <span class="text-2xl font-black ${isActive ? 'text-brand-light' : 'text-success'}">${plan.price}‚Ç¨</span>
                            <span class="text-[10px] text-slate-500">/mois</span>
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-1.5 mb-3">
                        ${plan.features.map(f => `<span class="text-[10px] px-2 py-0.5 rounded-md ${isActive ? 'bg-brand/20 text-brand-light' : 'bg-white/5 text-slate-400'} font-medium">${f}</span>`).join('')}
                    </div>
                    <button onclick="selectPlan('${plan.id}')" class="w-full py-2 rounded-lg font-bold text-xs transition-all ${isActive ? 'bg-success/20 text-success border border-success/30 cursor-default' : 'bg-brand/20 text-brand-light border border-brand/30 hover:bg-brand/30'}">
                        ${isActive ? '<i class="fa-solid fa-check mr-1"></i> Plan actuel' : '<i class="fa-brands fa-stripe mr-1"></i> Souscrire'}
                    </button>
                </div>`;
        }).join('');
    }

    function selectPlan(planId) {
        const plan = subscriptionPlans.find(p => p.id === planId);
        if (!plan) return;

        if (plan.stripeUrl) {
            window.open(plan.stripeUrl, '_blank', 'noopener,noreferrer');
        }
    }

    // ============================================
    // AI TONE SELECTOR
    // ============================================
    function setAiTone(tone) {
        currentAiTone = tone;
        const tones = ['professional', 'casual', 'warm', 'humor'];
        tones.forEach(t => {
            const btn = document.getElementById('tone-' + t);
            if (!btn) return;
            if (t === tone) {
                btn.className = 'tone-btn px-2.5 py-1 rounded-lg text-[10px] font-bold transition-all bg-brand/20 text-brand-light border border-brand/30';
            } else {
                btn.className = 'tone-btn px-2.5 py-1 rounded-lg text-[10px] font-bold transition-all bg-white/5 text-slate-400 border border-white/10 hover:bg-white/10';
            }
        });
        try { localStorage.setItem('repward_ai_tone', tone); } catch(e) {}
        db.saveMerchant({ ai_tone: tone });
        showToast('Ton IA', 'Style de r√©ponse : ' + {professional:'Professionnel',casual:'D√©contract√©',warm:'Chaleureux',humor:'Humour'}[tone], 'success');
    }

    // ============================================
    // QUICK TEMPLATES
    // ============================================
    function applyTemplate(style) {
        const textarea = document.getElementById('ai-draft-textarea');
        if (!textarea) return;
        const msg = (realReviews || mockMessages).find(m => m.id === currentMessageId);
        if (!msg) return;
        const name = msg.author.split(' ')[0];
        const templates = {
            short: {
                positive: `Merci ${name} pour votre avis ! Votre satisfaction est notre priorit√©. √Ä bient√¥t !`,
                negative: `${name}, nous sommes d√©sol√©s pour cette exp√©rience. Nous allons corriger cela rapidement. Contactez-nous directement.`
            },
            formal: {
                positive: `Cher(e) ${name},\n\nNous vous remercions sinc√®rement pour votre retour √©logieux. Votre satisfaction t√©moigne de l'engagement quotidien de notre √©quipe.\n\nNous esp√©rons avoir le plaisir de vous accueillir √† nouveau tr√®s prochainement.\n\nCordialement,\nLa Direction`,
                negative: `Cher(e) ${name},\n\nNous prenons acte de votre retour avec la plus grande attention. Cette situation ne refl√®te pas nos standards habituels de qualit√©.\n\nNous souhaiterions √©changer avec vous afin de comprendre les circonstances et y rem√©dier.\n\nVeuillez nous contacter directement.\n\nCordialement,\nLa Direction`
            },
            emoji: {
                positive: `${name} merci beaucoup ! üôè‚ú® On est trop contents que √ßa vous ait plu üòç H√¢te de vous revoir bient√¥t ! üéâüí™`,
                negative: `Oh non ${name} üòî On est vraiment d√©sol√©s ! üôè Ce n'est pas du tout ce qu'on veut offrir... On va tout faire pour corriger √ßa üí™ Contactez-nous, on veut se rattraper ! ‚ù§Ô∏è`
            }
        };
        const tpl = templates[style];
        if (!tpl) return;
        textarea.value = msg.rating >= 3 ? tpl.positive : tpl.negative;
        showToast('Template appliqu√©', style === 'short' ? 'Version courte' : style === 'formal' ? 'Version formelle' : 'Version emojis', 'success');
    }

    // ============================================
    // HEATMAP RENDERING (GitHub-style)
    // ============================================
    async function updateMarketplaceStats() {
        const el1 = document.getElementById('stat-codes-gen');
        const el2 = document.getElementById('stat-codes-used');
        const el3 = document.getElementById('stat-conversion');
        const el4 = document.getElementById('stat-revenue');

        // Tenter de lire depuis Supabase (donn√©es r√©elles)
        if (USE_SUPABASE && supabaseClient) {
            try {
                const user = (await supabaseClient.auth.getUser()).data.user;
                if (user) {
                    const { count: totalGen } = await supabaseClient
                        .from('qr_tokens')
                        .select('*', { count: 'exact', head: true })
                        .eq('merchant_id', user.id);

                    const { count: totalUsed } = await supabaseClient
                        .from('qr_tokens')
                        .select('*', { count: 'exact', head: true })
                        .eq('merchant_id', user.id)
                        .eq('used', true);

                    const codesGen = totalGen || 0;
                    const codesUsed = totalUsed || 0;
                    const conversion = codesGen > 0 ? Math.round((codesUsed / codesGen) * 100) : 0;
                    const revenue = codesUsed * 20; // ~20‚Ç¨ moyenne par conversion

                    if (el1) el1.textContent = codesGen;
                    if (el2) el2.textContent = codesUsed;
                    if (el3) el3.textContent = conversion + '%';
                    if (el4) el4.textContent = revenue.toLocaleString('fr-FR') + '‚Ç¨';
                    return;
                }
            } catch (e) {
                console.warn('Stats Supabase error, fallback local:', e);
            }
        }

        // Fallback: afficher 0 si pas de Supabase
        if (el1) el1.textContent = '0';
        if (el2) el2.textContent = '0';
        if (el3) el3.textContent = '0%';
        if (el4) el4.textContent = '0‚Ç¨';
    }

    async function renderHeatmap() {
        const container = document.getElementById('heatmap-container');
        if (!container) return;
        const today = new Date();

        // Charger les vrais avis des 30 derniers jours depuis Supabase
        let reviewCounts = {}; // { 'YYYY-MM-DD': count }

        if (USE_SUPABASE && supabaseClient) {
            try {
                const user = (await supabaseClient.auth.getUser()).data.user;
                if (user) {
                    const thirtyDaysAgo = new Date(today);
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

                    const { data } = await supabaseClient
                        .from('reviews')
                        .select('created_at')
                        .eq('merchant_id', user.id)
                        .gte('created_at', thirtyDaysAgo.toISOString());

                    if (data) {
                        data.forEach(r => {
                            const day = r.created_at.substring(0, 10); // YYYY-MM-DD
                            reviewCounts[day] = (reviewCounts[day] || 0) + 1;
                        });
                    }
                }
            } catch(e) { console.warn('Heatmap load error:', e); }
        }

        let html = '';
        for (let i = 29; i >= 0; i--) {
            const d = new Date(today);
            d.setDate(d.getDate() - i);
            const dayKey = d.toISOString().substring(0, 10);
            const dayNum = d.getDate();
            const count = reviewCounts[dayKey] || 0;

            let color = 'bg-slate-800';
            if (count >= 8) color = 'bg-brand';
            else if (count >= 5) color = 'bg-brand/80';
            else if (count >= 3) color = 'bg-brand/50';
            else if (count >= 1) color = 'bg-brand/20';

            const label = dayNum + '/' + (d.getMonth()+1) + ': ' + count + ' avis';
            html += `<div class="aspect-square ${color} rounded-sm cursor-pointer hover:ring-1 hover:ring-white/30 transition-all" title="${label}"></div>`;
        }
        container.innerHTML = html;
    }

    // ============================================
    // REPUTATION SCORE ANIMATION
    // ============================================
    function animateReputationScore() {
        const circle = document.getElementById('rep-score-circle');
        const num = document.getElementById('rep-score-num');
        if (!circle || !num) return;
        let current = 0;
        const target = reputationScore;
        const interval = setInterval(() => {
            current += 2;
            if (current >= target) { current = target; clearInterval(interval); }
            circle.setAttribute('stroke-dasharray', current + ', 100');
            num.textContent = current;
            if (current >= 80) {
                circle.setAttribute('stroke', '#10b981');
                num.className = 'absolute inset-0 flex items-center justify-center text-lg font-black text-success';
            } else if (current >= 50) {
                circle.setAttribute('stroke', '#f59e0b');
                num.className = 'absolute inset-0 flex items-center justify-center text-lg font-black text-warning';
            } else {
                circle.setAttribute('stroke', '#f43f5e');
                num.className = 'absolute inset-0 flex items-center justify-center text-lg font-black text-danger';
            }
        }, 20);
        updateReputationRank();
    }

    // ============================================
    // EMERGENCY MODE (1‚òÖ viral detection)
    // ============================================
    function checkEmergencyMode() {
        const allReviews = realReviews || mockMessages;
        const oneStarCount = allReviews.filter(m => m.rating === 1).length;
        const badge = document.getElementById('emergency-badge');
        if (oneStarCount >= 1) {
            if (!badge) {
                const nav = document.getElementById('nav-triage-desk');
                if (nav) {
                    const b = document.createElement('span');
                    b.id = 'emergency-badge';
                    b.className = 'absolute -top-1 -right-1 w-3 h-3 bg-danger rounded-full animate-ping';
                    nav.style.position = 'relative';
                    nav.appendChild(b);
                }
            }
        }
    }

    // ============================================
    // NFC PLATES UPSELL MODAL
    // ============================================
    function showNFCModal() {
        let modal = document.getElementById('nfc-modal');
        if (modal) { modal.style.display = 'flex'; return; }
        modal = document.createElement('div');
        modal.id = 'nfc-modal';
        modal.className = 'fixed inset-0 z-[200] bg-black/70 backdrop-blur-sm flex items-center justify-center p-4';
        modal.onclick = (e) => { if (e.target === modal) modal.style.display = 'none'; };
        modal.innerHTML = `
            <div class="bg-slate-900 border border-white/10 rounded-3xl max-w-md w-full p-8 text-center animate-slide-up">
                <div class="w-20 h-20 mx-auto mb-6 bg-gradient-to-br from-yellow-400 to-yellow-600 rounded-2xl flex items-center justify-center shadow-2xl shadow-yellow-500/30">
                    <i class="fa-solid fa-nfc-symbol text-4xl text-white" style="font-size:2.5rem">üì°</i>
                </div>
                <h2 class="text-2xl font-black text-white mb-2">Plaques NFC Repward</h2>
                <p class="text-sm text-slate-400 mb-6">Vos clients scannent, notent et re√ßoivent leur cadeau en <strong class="text-white">3 secondes</strong> ‚Äî sans QR code !</p>
                <div class="space-y-3 text-left mb-6">
                    <div class="flex items-center gap-3 text-sm text-slate-300"><i class="fa-solid fa-check text-success w-5"></i> Compatible tous smartphones (NFC)</div>
                    <div class="flex items-center gap-3 text-sm text-slate-300"><i class="fa-solid fa-check text-success w-5"></i> Design premium personnalis√©</div>
                    <div class="flex items-center gap-3 text-sm text-slate-300"><i class="fa-solid fa-check text-success w-5"></i> Lien direct vers votre fiche Google</div>
                    <div class="flex items-center gap-3 text-sm text-slate-300"><i class="fa-solid fa-check text-success w-5"></i> R√©sistant eau & UV ‚Äî Garantie 3 ans</div>
                </div>
                <div class="bg-gradient-to-r from-yellow-500/10 to-yellow-600/10 border border-yellow-500/20 rounded-xl p-4 mb-6">
                    <p class="text-xs text-yellow-400 font-bold mb-1">OFFRE LANCEMENT</p>
                    <p class="text-3xl font-black text-white">49‚Ç¨ <span class="text-sm font-medium text-slate-400 line-through">79‚Ç¨</span></p>
                    <p class="text-[10px] text-slate-400 mt-1">Pack de 2 plaques ¬∑ Livraison offerte</p>
                </div>
                <button onclick="window.open('https://repward.com/nfc','_blank')" class="w-full py-4 rounded-xl font-black text-lg bg-gradient-to-r from-yellow-400 to-yellow-600 text-slate-900 hover:from-yellow-300 hover:to-yellow-500 transition-all shadow-lg shadow-yellow-500/20">
                    <i class="fa-solid fa-cart-shopping mr-2"></i> Commander mes plaques
                </button>
                <button onclick="document.getElementById('nfc-modal').style.display='none'" class="mt-4 text-sm text-slate-500 hover:text-white transition-colors">Peut-√™tre plus tard</button>
            </div>`;
        document.body.appendChild(modal);
    }

    // ============================================
    // GOOGLE MAPS DEEP-LINK
    // ============================================
    function saveGoogleMapsUrl() {
        const input = document.getElementById('input-gmaps-url');
        if (!input) return;
        googleMapsUrl = input.value.trim();
        try { localStorage.setItem('repward_gmaps_url', googleMapsUrl); } catch(e) {}
        db.saveMerchant({ google_maps_url: googleMapsUrl });
        showToast('Google Maps', googleMapsUrl ? 'Lien enregistr√© !' : 'Lien supprim√©', 'success');
    }

    function loadGoogleMapsUrl() {
        // Try from supabaseMerchant first
        if (supabaseMerchant && supabaseMerchant.google_maps_url) {
            googleMapsUrl = supabaseMerchant.google_maps_url;
        } else {
            try { googleMapsUrl = localStorage.getItem('repward_gmaps_url') || ''; } catch(e) {}
        }
        const input = document.getElementById('input-gmaps-url');
        if (input && googleMapsUrl) input.value = googleMapsUrl;
    }

    // ============================================
    // REPUTATION SCORE WITH RANKS
    // ============================================
    function updateReputationRank() {
        const label = document.getElementById('rep-score-label');
        const rank = document.getElementById('rep-score-rank');
        if (!label || !rank) return;
        let rankText, rankIcon, labelText, labelColor;
        if (reputationScore >= 90) { rankText = 'L√©gende'; rankIcon = 'fa-crown'; labelText = 'R√©putation exceptionnelle'; labelColor = 'text-yellow-400'; }
        else if (reputationScore >= 75) { rankText = 'Expert'; rankIcon = 'fa-trophy'; labelText = 'Excellente r√©putation'; labelColor = 'text-success'; }
        else if (reputationScore >= 50) { rankText = 'Actif'; rankIcon = 'fa-bolt'; labelText = 'Bonne r√©putation'; labelColor = 'text-warning'; }
        else { rankText = 'D√©butant'; rankIcon = 'fa-seedling'; labelText = 'En progression'; labelColor = 'text-slate-400'; }
        label.className = 'text-[10px] font-bold ' + labelColor;
        label.textContent = labelText;
        rank.innerHTML = '<i class="fa-solid ' + rankIcon + ' mr-0.5"></i> ' + rankText;
    }

    // ============================================
    // MULTI-√âTABLISSEMENTS
    // ============================================
    let establishments = [];

    function updateMultiSites() {
        const slider = document.getElementById('multi-sites-slider');
        const count = document.getElementById('multi-sites-count');
        const price = document.getElementById('multi-sites-price');
        if (!slider) return;
        const n = parseInt(slider.value);
        if (count) count.textContent = n;
        const total = 99.90 + Math.max(0, n - 1) * 50;
        if (price) price.textContent = total.toFixed(2).replace('.', ',') + '‚Ç¨';
    }

    function addEstablishment() {
        const currentPlan = localStorage.getItem('repward_plan') || 'starter';
        if (currentPlan !== 'unlimited') {
            showToast('Plan Illimit√© requis', 'Passez au plan Illimit√© pour g√©rer plusieurs sites', 'error');
            return;
        }
        const name = prompt('Nom du nouvel √©tablissement :');
        if (!name) return;
        establishments.push({ id: Date.now(), name: name, industry: currentInd, qrGenerated: false, reviewCount: 0 });
        try { localStorage.setItem('repward_establishments', JSON.stringify(establishments)); } catch(e) {}
        renderEstablishments();
        showToast('√âtablissement ajout√©', name, 'success');
    }

    function renderEstablishments() {
        const list = document.getElementById('multi-sites-list');
        if (!list) return;
        if (establishments.length === 0) { list.innerHTML = '<p class="text-xs text-slate-500 text-center py-4">Aucun √©tablissement ajout√©</p>'; return; }
        list.innerHTML = establishments.map(e => `
            <div class="flex items-center justify-between p-3 bg-slate-900/50 rounded-xl">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-yellow-500/10 flex items-center justify-center"><i class="fa-solid fa-store text-yellow-400 text-xs"></i></div>
                    <div>
                        <p class="text-sm font-bold text-white">${escapeHtml(e.name)}</p>
                        <p class="text-[10px] text-slate-400">${e.reviewCount} avis ¬∑ ${e.qrGenerated ? 'QR actif' : 'QR non g√©n√©r√©'}</p>
                    </div>
                </div>
                <button onclick="removeEstablishment(${e.id})" class="text-slate-500 hover:text-danger transition-colors"><i class="fa-solid fa-trash text-xs"></i></button>
            </div>`).join('');
    }

    function removeEstablishment(id) {
        establishments = establishments.filter(e => e.id !== id);
        try { localStorage.setItem('repward_establishments', JSON.stringify(establishments)); } catch(e) {}
        renderEstablishments();
    }

    function loadEstablishments() {
        try { establishments = JSON.parse(localStorage.getItem('repward_establishments')) || []; } catch(e) { establishments = []; }
        renderEstablishments();
    }

    // ============================================
    // CONNECT PLATFORM (OAuth)
    // ============================================
    async function connectPlatformOAuth(platform) {
        const configs = {
            google: { name: 'Google Business', color: 'google' },
            trustpilot: { name: 'Trustpilot', color: 'trustpilot' },
            facebook: { name: 'Facebook', color: 'facebook' }
        };
        const config = configs[platform];
        if (!config) return;

        // En mode Supabase ‚Üí d√©clencher le vrai OAuth
        if (typeof USE_SUPABASE !== 'undefined' && USE_SUPABASE && typeof SUPABASE_URL !== 'undefined') {
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (session) {
                    window.location.href = `${SUPABASE_URL}/functions/v1/${platform}-oauth-init?state=${session.access_token}`;
                    return;
                }
            } catch (e) {
                console.warn(`OAuth ${config.name} init failed:`, e);
            }
        }

        // Fallback d√©mo : simuler la connexion
        const statusEl = document.getElementById(`${platform}-status`);
        if (statusEl) {
            statusEl.className = 'bg-success/20 text-success text-[10px] font-bold px-2.5 py-1 rounded-lg flex items-center gap-1';
            statusEl.innerHTML = '<i class="fa-solid fa-check-circle"></i> Connect√©';
        }

        // Si c'est Facebook, activer aussi Instagram
        if (platform === 'facebook') {
            const igStatus = document.getElementById('instagram-status');
            if (igStatus) {
                igStatus.className = 'bg-success/20 text-success text-[10px] font-bold px-2.5 py-1 rounded-lg flex items-center gap-1';
                igStatus.innerHTML = '<i class="fa-solid fa-check-circle"></i> Connect√©';
            }
        }

        // Sauvegarder
        const connectionData = { connected_at: new Date().toISOString(), is_active: true, method: 'oauth' };
        db.savePlatform(platform, connectionData);
        if (platform === 'facebook') {
            db.savePlatform('instagram', { connected_at: new Date().toISOString(), is_active: true, method: 'oauth_via_facebook' });
        }

        showToast(`${config.name} connect√© !`, 'Vos avis seront synchronis√©s automatiquement', 'success');
    }

    function loadPlatformStatuses() {
        const platforms = JSON.parse(localStorage.getItem('repward_platforms') || '{}');
        for (const [platform, data] of Object.entries(platforms)) {
            if (data.is_active) {
                const statusEl = document.getElementById(`${platform}-status`);
                if (statusEl) {
                    statusEl.className = 'bg-success/20 text-success text-[10px] font-bold px-2.5 py-1 rounded-lg flex items-center gap-1';
                    statusEl.innerHTML = '<i class="fa-solid fa-check-circle"></i> Connect√©';
                }
            }
        }
    }

    // CONNECT PLATFORM (legacy)
    // ============================================
    async function connectPlatform(platform) {
        const platformNames = {
            google: 'Google My Business', airbnb: 'Airbnb', thefork: 'TheFork',
            tripadvisor: 'TripAdvisor', trustpilot: 'Trustpilot', booking: 'Booking.com',
            facebook: 'Facebook', instagram: 'Instagram', expedia: 'Expedia'
        };
        const name = platformNames[platform] || platform;

        // Google uses OAuth flow
        if (platform === 'google' && USE_SUPABASE && supabaseClient) {
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (session) {
                    // Redirect to Google OAuth init Edge Function
                    window.location.href = `${SUPABASE_URL}/functions/v1/google-oauth-init?state=${session.access_token}`;
                    return;
                }
            } catch (e) {
                console.warn('Google OAuth init failed:', e);
            }
        }

        // For other platforms: show connection modal with URL input
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/60 backdrop-blur-sm z-[9999] flex items-center justify-center p-4';
        modal.id = 'connect-modal';
        modal.innerHTML = `
            <div class="glass-card rounded-2xl p-6 max-w-md w-full border border-white/10 shadow-2xl">
                <h3 class="text-lg font-bold text-white mb-2">Connecter ${name}</h3>
                <p class="text-xs text-slate-400 mb-4">Entrez l'URL de votre page ${name} pour synchroniser vos avis</p>
                <input id="platform-url-input" type="url" placeholder="https://www.${platform}.com/votre-page"
                    class="w-full bg-slate-900/50 border border-white/10 rounded-xl p-3 text-sm text-white focus:border-brand outline-none mb-4">
                <div class="flex gap-3">
                    <button onclick="document.getElementById('connect-modal').remove()"
                        class="flex-1 py-2.5 border border-white/10 rounded-xl text-sm text-slate-400 hover:bg-white/5 transition-all">Annuler</button>
                    <button onclick="savePlatformConnection('${platform}')"
                        class="flex-1 py-2.5 bg-brand text-white rounded-xl text-sm font-bold hover:bg-brand-dark transition-all">Connecter</button>
                </div>
            </div>`;
        document.body.appendChild(modal);
    }

    async function savePlatformConnection(platform) {
        const url = document.getElementById('platform-url-input')?.value.trim();
        if (!url) { showToast('Erreur', 'Entrez une URL valide', 'error'); return; }

        db.savePlatform(platform, { url, connected_at: new Date().toISOString(), is_active: true });

        document.getElementById('connect-modal')?.remove();
        showToast('Connect√© !', `${platform} a √©t√© ajout√© avec succ√®s`, 'success');
        updateIntegrationsBadge();
    }

    function updateIntegrationsBadge() {
        const platforms = JSON.parse(localStorage.getItem('repward_platforms') || '{}');
        const connectedCount = Object.keys(platforms).filter(k => platforms[k].is_active).length + 1; // +1 for Google default
        const badge = document.querySelector('#nav-integrations-desk .badge, [data-badge="integrations"]');
        if (badge) badge.textContent = connectedCount;
    }

    // ============================================
    // CONCURRENTS RADAR
    // ============================================
    // analyzeCompetitors() ‚Äî Bient√¥t disponible (V2)
    function analyzeCompetitors() {
        showToast('Bient√¥t', 'Le radar concurrents arrive dans une prochaine mise √† jour', 'info');
    }

    // ============================================
    // ALERTES SMS/EMAIL
    // ============================================
    function saveAlertPrefs() {
        const emailOn = document.getElementById('alert-email-toggle')?.checked || false;
        const smsOn = document.getElementById('alert-sms-toggle')?.checked || false;
        db.saveAlerts(emailOn, smsOn);
        showToast('Alertes', (emailOn ? 'Email ' : '') + (smsOn ? 'SMS ' : '') + 'activ√©(s)', 'success');
    }

    function loadAlertPrefs() {
        try {
            const a = JSON.parse(localStorage.getItem('repward_alerts'));
            if (a) {
                const e = document.getElementById('alert-email-toggle'); if (e) e.checked = a.email;
                const s = document.getElementById('alert-sms-toggle'); if (s) s.checked = a.sms;
            }
        } catch(e) {}
    }

    // ============================================
    // RAPPORT PDF MENSUEL
    // ============================================
    function exportHistoryPDF() {
        const w = window.open('', '_blank');
        const data = industries[currentInd];
        const kpis = data ? data.kpis : { reviews: '0', timeSaved: '0', roi: '0' };
        w.document.write(`<!DOCTYPE html><html><head><title>Rapport Repward</title><style>body{font-family:Outfit,sans-serif;padding:40px;color:#1e293b}h1{color:#6366f1;font-size:24px}table{width:100%;border-collapse:collapse;margin-top:20px}th,td{padding:12px;text-align:left;border-bottom:1px solid #e2e8f0}th{background:#f1f5f9;font-size:12px;text-transform:uppercase;letter-spacing:1px}td{font-size:13px}.kpi{display:inline-block;background:#f1f5f9;padding:16px 24px;border-radius:12px;margin:8px;text-align:center}.kpi-num{font-size:28px;font-weight:900;color:#6366f1}.kpi-label{font-size:10px;color:#64748b;text-transform:uppercase;margin-top:4px}</style></head><body>`);
        w.document.write(`<h1>üìä Rapport Mensuel Repward</h1><p style="color:#64748b">G√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')}</p><hr style="border:none;border-top:2px solid #6366f1;margin:20px 0">`);
        w.document.write(`<div><div class="kpi"><div class="kpi-num">${kpis.reviews}</div><div class="kpi-label">Avis 5‚òÖ</div></div><div class="kpi"><div class="kpi-num">${kpis.timeSaved}</div><div class="kpi-label">Temps gagn√©</div></div><div class="kpi"><div class="kpi-num">${kpis.roi}</div><div class="kpi-label">ROI Win-Back</div></div></div>`);
        w.document.write(`<h2 style="margin-top:30px">Derni√®res r√©ponses publi√©es</h2><table><tr><th>Date</th><th>Client</th><th>Note</th><th>Plateforme</th><th>R√©ponse</th></tr>`);
        const history = getResponseHistory();
        history.slice(0, 20).forEach(h => {
            w.document.write(`<tr><td>${h.date}</td><td>${escapeHtml(h.author)}</td><td>${'‚òÖ'.repeat(h.rating)}</td><td>${h.platform}</td><td style="max-width:300px;font-size:11px">${escapeHtml(h.response).substring(0, 100)}...</td></tr>`);
        });
        w.document.write(`</table><p style="text-align:center;margin-top:40px;color:#94a3b8;font-size:10px">Repward OS ‚Äî Plateforme de R√©putation Intelligente</p></body></html>`);
        w.document.close();
        w.print();
    }

    // ============================================
    // HISTORIQUE DES R√âPONSES
    // ============================================
    function getResponseHistory() {
        try { return JSON.parse(localStorage.getItem('repward_history')) || []; } catch(e) { return []; }
    }

    function saveToHistory(author, rating, platform, response) {
        const entry = {
            id: Date.now(),
            date: new Date().toLocaleDateString('fr-FR'),
            author: author,
            rating: rating,
            platform: platform,
            response: response,
            published: false
        };
        // localStorage fallback
        const history = getResponseHistory();
        history.unshift(entry);
        if (history.length > 50) history.length = 50;
        try { localStorage.setItem('repward_history', JSON.stringify(history)); } catch(e) {}
        // Supabase sync
        db.saveResponseHistory(entry);
    }

    function renderHistory() {
        const container = document.getElementById('history-list');
        if (!container) return;
        const search = (document.getElementById('history-search')?.value || '').toLowerCase();
        let history = getResponseHistory();
        if (search) history = history.filter(h => h.author.toLowerCase().includes(search) || h.response.toLowerCase().includes(search) || h.platform.toLowerCase().includes(search));

        if (history.length === 0) {
            container.innerHTML = '<div class="text-center py-16"><div class="w-16 h-16 rounded-2xl bg-white/5 flex items-center justify-center mx-auto mb-4"><i class="fa-solid fa-clock-rotate-left text-2xl text-slate-500"></i></div><p class="text-sm font-bold text-slate-400">Aucune r√©ponse publi√©e</p><p class="text-xs text-slate-600 mt-1">Vos r√©ponses IA appara√Ætront ici</p></div>';
            return;
        }
        container.innerHTML = history.map(h => `
            <div class="glass-card p-4 rounded-xl">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-bold text-white">${escapeHtml(h.author)}</span>
                        <span class="text-[10px] text-slate-500">${h.platform}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="flex gap-0.5">${[1,2,3,4,5].map(i => '<i class="fa-solid fa-star text-[8px] ' + (i <= h.rating ? 'text-yellow-400' : 'text-slate-700') + '"></i>').join('')}</div>
                        <span class="text-[10px] text-slate-500">${h.date}</span>
                    </div>
                </div>
                <p class="text-xs text-slate-300 line-clamp-2 leading-relaxed">${escapeHtml(h.response).substring(0, 200)}${h.response.length > 200 ? '...' : ''}</p>
            </div>`).join('');
    }

    // ============================================
    // WIDGET INT√âGRABLE
    // ============================================
    function generateWidgetCode() {
        const textarea = document.getElementById('widget-code');
        if (!textarea) return;
        const biz = document.getElementById('input-nom-etab')?.value || 'Mon Commerce';
        textarea.value = `<!-- Repward Widget -->\n<div id="repward-widget" style="display:inline-flex;align-items:center;gap:8px;background:#fff;padding:8px 16px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);font-family:Outfit,sans-serif">\n  <span style="color:#f59e0b;font-size:20px">‚òÖ</span>\n  <span style="font-weight:900;font-size:18px;color:#0f172a">4.8</span>\n  <span style="color:#94a3b8;font-size:12px">¬∑ 84 avis Google</span>\n</div>\n<script src="${window.location.origin}/widget.js" data-biz="${escapeHtml(biz)}"><\/script>`;
    }

    function copyWidgetCode() {
        const textarea = document.getElementById('widget-code');
        if (!textarea) return;
        textarea.select();
        navigator.clipboard.writeText(textarea.value).then(() => {
            showToast('Widget copi√© !', 'Collez le code sur votre site web', 'success');
        }).catch(() => { document.execCommand('copy'); showToast('Widget copi√© !', '', 'success'); });
    }

    // ============================================
    // SHORT LINK (lien de partage)
    // ============================================
    function updateShortLink() {
        const display = document.getElementById('short-link-display');
        if (!display) return;
        const biz = document.getElementById('input-nom-etab')?.value || 'MonCommerce';
        const slug = biz.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^a-z0-9]+/g, '-').replace(/-+$/,'');
        display.value = `${window.location.origin}?biz=${encodeURIComponent(biz)}&ind=${currentInd}&rew=${encodeURIComponent(currentRew)}`;
    }

    function copyShortLink() {
        const display = document.getElementById('short-link-display');
        if (!display || !display.value) return;
        navigator.clipboard.writeText(display.value).then(() => {
            showToast('Lien copi√© !', 'Partagez-le par SMS ou WhatsApp', 'success');
        }).catch(() => { document.execCommand('copy'); });
    }

    // ============================================
    // PROGRAMME FID√âLIT√â CROSS-VISITES
    // ============================================
    function getLoyaltyCount() {
        try { return parseInt(localStorage.getItem('repward_loyalty') || '0'); } catch(e) { return 0; }
    }

    function incrementLoyalty() {
        let count = getLoyaltyCount() + 1;
        try { localStorage.setItem('repward_loyalty', count.toString()); } catch(e) {}
        if (count >= 5) {
            // VIP unlock!
            return { vip: true, count: count };
        }
        return { vip: false, count: count };
    }

    // ============================================
    // AVIS VOCAL (Web Speech API)
    // ============================================
    let isRecording = false;
    let speechRecognition = null;

    function startVocalReview() {
        const btn = document.getElementById('btn-vocal');
        const textarea = document.getElementById('vocal-text');
        if (!btn || !textarea) return;

        if (isRecording) {
            stopVocalReview();
            return;
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            alert('Votre navigateur ne supporte pas la reconnaissance vocale. Essayez Chrome.');
            return;
        }

        speechRecognition = new SpeechRecognition();
        speechRecognition.lang = 'fr-FR';
        speechRecognition.continuous = false;
        speechRecognition.interimResults = true;
        speechRecognition.maxAlternatives = 1;

        const existingText = textarea.value.trim();
        let finalTranscript = existingText ? existingText + ' ' : '';
        speechRecognition.onresult = (event) => {
            let interim = '';
            for (let i = event.resultIndex; i < event.results.length; i++) {
                if (event.results[i].isFinal) finalTranscript += event.results[i][0].transcript + ' ';
                else interim += event.results[i][0].transcript;
            }
            textarea.value = finalTranscript + interim;
        };

        speechRecognition.onerror = () => { stopVocalReview(); };
        speechRecognition.onend = () => { stopVocalReview(); };

        speechRecognition.start();
        isRecording = true;
        btn.innerHTML = '<i class="fa-solid fa-stop text-danger"></i> Arr√™ter l\'enregistrement';
        btn.className = 'w-full py-2.5 rounded-xl text-xs font-bold bg-red-50 text-red-600 border border-red-200 flex items-center justify-center gap-2 animate-pulse';

        // Auto-stop after 30s
        setTimeout(() => { if (isRecording) stopVocalReview(); }, 30000);
    }

    function stopVocalReview() {
        if (speechRecognition) { try { speechRecognition.stop(); } catch(e) {} }
        isRecording = false;
        const btn = document.getElementById('btn-vocal');
        if (btn) {
            btn.innerHTML = '<i class="fa-solid fa-microphone"></i> Dicter mon avis (30s)';
            btn.className = 'w-full py-2.5 rounded-xl text-xs font-bold bg-purple-50 text-purple-600 border border-purple-200 flex items-center justify-center gap-2 hover:bg-purple-100 transition-all';
        }
    }

    // ============================================
    // INITIALIZATION
    // ============================================
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            // === CRITICAL: Read URL params from QR code scan ===
            const urlParams = new URLSearchParams(window.location.search);
            const qrBiz = urlParams.get('biz');
            const qrInd = urlParams.get('ind');
            const qrRew = urlParams.get('rew');
            const qrToken = urlParams.get('t');

            // === Nouveau syst√®me anti-triche par token ===
            if (qrToken) {
                (async () => {
                    try {
                        if (!USE_SUPABASE || !supabaseClient) {
                            showTokenError('Syst√®me indisponible');
                            return;
                        }
                        // V√©rifier le token dans Supabase
                        const { data: tokenData, error } = await supabaseClient
                            .from('qr_tokens')
                            .select('*')
                            .eq('token', qrToken)
                            .single();

                        if (error || !tokenData) {
                            showTokenError('Ce lien est invalide ou n\'existe pas.');
                            return;
                        }
                        if (tokenData.used) {
                            showTokenError('Ce QR code a d√©j√† √©t√© utilis√©. Un seul avis par visite.');
                            return;
                        }
                        if (new Date(tokenData.expires_at) < new Date()) {
                            showTokenError('Ce QR code a expir√© (validit√© 6 mois).');
                            return;
                        }

                        // Token valide ! Charger les infos du commerce
                        if (tokenData.industry && industries[tokenData.industry]) {
                            currentInd = tokenData.industry;
                            const indSelector = document.getElementById('ind-selector');
                            if (indSelector) indSelector.value = tokenData.industry;
                        }
                        if (tokenData.reward) currentRew = tokenData.reward;
                        if (tokenData.business_name) {
                            const data = industries[currentInd];
                            if (data) data.name = tokenData.business_name;
                        }

                        // Stocker le token pour le marquer comme utilis√© apr√®s l'avis
                        window._activeQrToken = qrToken;

                        document.getElementById('view-merchant')?.classList.add('view-hidden');
                        document.getElementById('view-customer')?.classList.remove('view-hidden');
                        try { updateCustomerApp(); } catch(e) { console.error('updateCustomerApp error:', e); }
                    } catch(e) {
                        console.error('Token verification error:', e);
                        showTokenError('Erreur de v√©rification. R√©essayez.');
                    }
                })();
                return;
            }

            // === Ancien syst√®me (r√©tro-compatibilit√©) ===
            if (qrBiz || qrInd || qrRew) {
                if (qrInd && industries[qrInd]) {
                    currentInd = qrInd;
                    const indSelector = document.getElementById('ind-selector');
                    if (indSelector) indSelector.value = qrInd;
                }
                if (qrRew) currentRew = qrRew;
                if (qrBiz) { const data = industries[currentInd]; if (data) data.name = qrBiz; }
                document.getElementById('view-merchant')?.classList.add('view-hidden');
                document.getElementById('view-customer')?.classList.remove('view-hidden');
                try { updateCustomerApp(); } catch(e) { console.error('updateCustomerApp error:', e); }
                return;
            }

            // === Check if onboarding needed ===
            if (checkOnboarding()) {
                showOnboarding();
                return;
            }

            // === AUTH GUARD: Block dashboard if not authenticated ===
            if (USE_SUPABASE && supabaseClient) {
                try {
                    const { data: { user } } = await supabaseClient.auth.getUser();
                    if (!user) {
                        // No authenticated user ‚Äî force onboarding
                        showOnboarding();
                        return;
                    }
                    supabaseUser = user;

                    // Listen for auth state changes (session expiry)
                    supabaseClient.auth.onAuthStateChange((event, session) => {
                        if (event === 'SIGNED_OUT' || event === 'TOKEN_REFRESHED' && !session) {
                            supabaseUser = null;
                            supabaseMerchant = null;
                            showOnboarding();
                            showToast('Session expir√©e', 'Veuillez vous reconnecter', 'error');
                        }
                    });
                } catch(e) {
                    console.warn('Auth guard check failed:', e);
                    // Fallback to localStorage check (offline mode)
                }
            }

            // === Normal merchant dashboard load ===
            try { loadGeminiKey(); } catch(e) { console.error('loadGeminiKey:', e); }
            try { loadAccountData(); } catch(e) { console.error('loadAccountData:', e); }
            try { loadPrefs(); } catch(e) { console.error('loadPrefs:', e); }
            // Restore auto-pilot state
            try {
                const ap = localStorage.getItem('repward_auto_pilot');
                if (ap === '1') {
                    const toggle = document.getElementById('auto-pilot-toggle');
                    if (toggle) { toggle.checked = true; toggleAutoPilot(); }
                }
            } catch(e) { console.error('auto-pilot restore:', e); }
            try { loadGoogleMapsUrl(); } catch(e) { console.error('loadGoogleMapsUrl:', e); }
            try { loadManualReviews(); } catch(e) { console.error('loadManualReviews:', e); }
            try { renderMessages(); } catch(e) { console.error('renderMessages:', e); }

            // CRITICAL: Show tab content
            try { switchTab('portal'); } catch(e) { console.error('switchTab:', e); }

            try { updateInd(); } catch(e) { console.error('updateInd:', e); }
            try { renderSubscriptionPlans(); } catch(e) { console.error('renderSubscriptionPlans:', e); }
            try { updateDemoBanner(); } catch(e) { console.error('updateDemoBanner:', e); }
            try { renderHeatmap(); } catch(e) { console.error('renderHeatmap:', e); }
            try { updateMarketplaceStats(); } catch(e) { console.error('updateMarketplaceStats:', e); }
            try { animateReputationScore(); } catch(e) { console.error('animateReputationScore:', e); }
            try { checkEmergencyMode(); } catch(e) { console.error('checkEmergencyMode:', e); }
            try { loadEstablishments(); } catch(e) { console.error('loadEstablishments:', e); }
            try { loadAlertPrefs(); } catch(e) { console.error('loadAlertPrefs:', e); }
            try { generateWidgetCode(); } catch(e) { console.error('generateWidgetCode:', e); }
            try { updateShortLink(); } catch(e) { console.error('updateShortLink:', e); }
            try { const savedTone = localStorage.getItem('repward_ai_tone'); if (savedTone) setAiTone(savedTone); } catch(e) {}
            // Supabase session restore (critical for data sync)
            if (USE_SUPABASE && supabaseClient) {
                try {
                    const { data: sessionData } = await supabaseClient.auth.getSession();
                    if (sessionData?.session) {
                        supabaseUser = sessionData.session.user;
                        const { data: m } = await supabaseClient
                            .from('merchants')
                            .select('*')
                            .eq('id', supabaseUser.id)
                            .single();
                        if (m) {
                            supabaseMerchant = m;
                            // Hydrate UI from Supabase data
                            if (m.ai_tone) setAiTone(m.ai_tone);
                            if (m.google_maps_url) { googleMapsUrl = m.google_maps_url; const gi = document.getElementById('input-gmaps-url'); if (gi) gi.value = googleMapsUrl; }
                            if (m.auto_pilot) { const ap = document.getElementById('auto-pilot-toggle'); if (ap) { ap.checked = true; toggleAutoPilot(); } }
                            if (m.industry) { currentInd = m.industry; updatePortalIndustryBadge(m.industry); }
                            if (m.wheel_segments && Array.isArray(m.wheel_segments) && m.wheel_segments.length >= 2) {
                                wheelSegments.length = 0;
                                m.wheel_segments.forEach(s => wheelSegments.push(s));
                                drawWheel(); renderSegmentsList();
                            }
                        }
                        // Load reviews from Supabase
                        loadSupabaseReviews();
                    }
                } catch(e) { console.warn('Supabase session restore:', e); }
            }

            // Google Business Profile Integration
            try { handleGoogleCallback(); } catch(e) { console.error('handleGoogleCallback:', e); }
            try { checkGoogleConnection(); } catch(e) { console.error('checkGoogleConnection:', e); }

            // 5 Killer Features Init
            try { loadPlatformStatuses(); } catch(e) { console.error('loadPlatformStatuses:', e); }
            try { initWheel(); } catch(e) { console.error('initWheel:', e); }
            try { initFomoBubble(); } catch(e) { console.error('initFomoBubble:', e); }
            try { initLeaderboard(); } catch(e) { console.error('initLeaderboard:', e); }
            try { initVoiceFeature(); } catch(e) { console.error('initVoiceFeature:', e); }
        } catch(fatalErr) {
            console.error('REPWARD FATAL ERROR in DOMContentLoaded:', fatalErr);
            // Emergency fallback: at least show a tab
            try { document.getElementById('tab-portal').classList.remove('hidden'); } catch(e) {}
        }
    });

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && e.target.classList.contains('message-item')) {
            e.target.click();
        }
    });

    // ============================================
    // AJOUT MANUEL D'AVIS (Option 1)
    // ============================================
    let manualStarRating = 0;

    function openManualReviewModal() {
        document.getElementById('manual-review-modal').classList.remove('hidden');
        manualStarRating = 0;
        document.getElementById('manual-author').value = '';
        document.getElementById('manual-review-text').value = '';
        document.getElementById('manual-review-error').classList.add('hidden');
        const stars = document.getElementById('manual-stars').children;
        for (let i = 0; i < 5; i++) stars[i].className = 'fa-solid fa-star text-2xl text-slate-600 cursor-pointer hover:text-yellow-400 transition-colors';
    }

    function closeManualReviewModal() {
        document.getElementById('manual-review-modal').classList.add('hidden');
    }

    function setManualStar(n) {
        manualStarRating = n;
        const stars = document.getElementById('manual-stars').children;
        for (let i = 0; i < 5; i++) {
            stars[i].className = `fa-solid fa-star text-2xl cursor-pointer transition-colors ${i < n ? 'text-yellow-400 scale-110' : 'text-slate-600 hover:text-yellow-400'}`;
        }
    }

    function platformIcon(p) {
        const icons = { google: 'fa-brands fa-google', airbnb: 'fa-brands fa-airbnb', booking: 'fa-solid fa-hotel', thefork: 'fa-solid fa-utensils', tripadvisor: 'fa-solid fa-map-location-dot', trustpilot: 'fa-solid fa-star', facebook: 'fa-brands fa-facebook', instagram: 'fa-brands fa-instagram', expedia: 'fa-solid fa-plane', other: 'fa-solid fa-comment' };
        return icons[p] || icons.other;
    }

    function platformColor(p) {
        const colors = { google: 'text-google', airbnb: 'text-airbnb', booking: 'text-blue-400', thefork: 'text-green-400', tripadvisor: 'text-emerald-400', trustpilot: 'text-trustpilot', facebook: 'text-blue-500', instagram: 'text-pink-400', expedia: 'text-yellow-400', other: 'text-slate-400' };
        return colors[p] || colors.other;
    }

    async function submitManualReview() {
        const platform = document.getElementById('manual-platform').value;
        const lang = document.getElementById('manual-lang') ? document.getElementById('manual-lang').value : 'fr';
        const author = document.getElementById('manual-author').value.trim();
        const text = document.getElementById('manual-review-text').value.trim();
        const errEl = document.getElementById('manual-review-error');

        if (!author || !text || manualStarRating === 0) {
            errEl.textContent = 'Remplissez tous les champs et s√©lectionnez une note';
            errEl.classList.remove('hidden');
            return;
        }
        errEl.classList.add('hidden');

        const review = {
            id: Date.now(),
            platform: platform,
            icon: platformIcon(platform),
            color: platformColor(platform),
            author: author,
            time: "√Ä l'instant",
            rating: manualStarRating,
            lang: lang,
            text: text,
            baseDraft: '',
            manual: true
        };

        mockMessages.unshift(review);
        saveManualReview(review);
        currentMessageId = review.id;
        closeManualReviewModal();
        switchTab('triage');
        renderMessages();
        await regenerateDraft();
        showToast('Avis ajout√©', `R√©ponse IA g√©n√©r√©e pour ${author}`, 'success');
    }

    function saveManualReview(review) {
        db.saveManualReview(review);
    }

    function loadManualReviews() {
        try {
            const saved = JSON.parse(localStorage.getItem('repward_manual_reviews') || '[]');
            if (saved.length > 0) {
                const existingIds = new Set(mockMessages.map(m => m.id));
                saved.forEach(r => { if (!existingIds.has(r.id)) mockMessages.unshift(r); });
            }
        } catch(e) {}
    }

    function copyAIResponse() {
        const textarea = document.getElementById('ai-draft-textarea');
        if (!textarea || !textarea.value.trim()) {
            showToast('Rien √† copier', "G√©n√©rez d'abord une r√©ponse IA", 'error');
            return;
        }
        navigator.clipboard.writeText(textarea.value).then(() => {
            const msg = (realReviews || mockMessages).find(m => m.id === currentMessageId);
            const platform = msg ? msg.platform.charAt(0).toUpperCase() + msg.platform.slice(1) : 'la plateforme';
            showToast('R√©ponse copi√©e !', `Allez la coller sur ${platform}`, 'success');
        }).catch(() => {
            textarea.select();
            document.execCommand('copy');
            showToast('R√©ponse copi√©e !', '', 'success');
        });
    }

    // ============================================
    // FEATURE 1: ROUE DE LA FORTUNE (FORTUNE WHEEL)
    // ============================================
    let wheelCanvas = null;
    let wheelCtx = null;
    let fortuneEnabled = true;
    const wheelSegments = [
        { text: "Dessert offert", color: "#f43f5e" },
        { text: "10% de r√©duction", color: "#f59e0b" },
        { text: "-5‚Ç¨", color: "#ec4899" },
        { text: "Caf√© offert", color: "#06b6d4" },
        { text: "Rien", color: "#64748b" },
        { text: "Boisson offerte", color: "#10b981" },
        { text: "Ap√©ritif offert", color: "#8b5cf6" },
        { text: "Menu du jour -20%", color: "#14b8a6" }
    ];

    function initWheel() {
        wheelCanvas = document.getElementById('wheel-canvas');
        if (!wheelCanvas) return;
        wheelCtx = wheelCanvas.getContext('2d');
        wheelCanvas.width = 300;
        wheelCanvas.height = 300;
        drawWheel();
        renderSegmentsList();
    }

    function drawWheel() {
        if (!wheelCtx) return;
        const cx = wheelCanvas.width / 2;
        const cy = wheelCanvas.height / 2;
        const radius = 135;

        wheelCtx.clearRect(0, 0, wheelCanvas.width, wheelCanvas.height);

        // Outer decorative ring
        wheelCtx.beginPath();
        wheelCtx.arc(cx, cy, radius + 6, 0, Math.PI * 2);
        wheelCtx.strokeStyle = 'rgba(251,191,36,0.3)';
        wheelCtx.lineWidth = 4;
        wheelCtx.stroke();

        // Draw segments with gradient fills
        const segCount = wheelSegments.length;
        const segmentAngle = (Math.PI * 2) / segCount;

        wheelSegments.forEach((seg, i) => {
            const startAngle = i * segmentAngle - Math.PI / 2;
            const endAngle = (i + 1) * segmentAngle - Math.PI / 2;

            // Gradient from center to edge
            const midAngle = (startAngle + endAngle) / 2;
            const gx = cx + Math.cos(midAngle) * radius;
            const gy = cy + Math.sin(midAngle) * radius;
            const grad = wheelCtx.createLinearGradient(cx, cy, gx, gy);
            grad.addColorStop(0, seg.color + 'cc');
            grad.addColorStop(0.5, seg.color);
            grad.addColorStop(1, seg.color + 'aa');

            wheelCtx.beginPath();
            wheelCtx.moveTo(cx, cy);
            wheelCtx.arc(cx, cy, radius, startAngle, endAngle);
            wheelCtx.closePath();
            wheelCtx.fillStyle = grad;
            wheelCtx.fill();

            // Thin separator lines
            wheelCtx.strokeStyle = 'rgba(255,255,255,0.25)';
            wheelCtx.lineWidth = 1.5;
            wheelCtx.stroke();

            // Draw text ‚Äî white with shadow
            const textAngle = startAngle + segmentAngle / 2;
            const textR = radius * 0.62;
            const textX = cx + Math.cos(textAngle) * textR;
            const textY = cy + Math.sin(textAngle) * textR;
            wheelCtx.save();
            wheelCtx.translate(textX, textY);
            wheelCtx.rotate(textAngle + Math.PI / 2);
            wheelCtx.shadowColor = 'rgba(0,0,0,0.6)';
            wheelCtx.shadowBlur = 4;
            wheelCtx.shadowOffsetX = 1;
            wheelCtx.shadowOffsetY = 1;
            wheelCtx.fillStyle = '#ffffff';
            wheelCtx.font = 'bold 11px Outfit';
            wheelCtx.textAlign = 'center';
            wheelCtx.textBaseline = 'middle';
            wheelCtx.fillText(seg.text, 0, 0);
            wheelCtx.restore();
        });

        // Decorative inner ring
        wheelCtx.beginPath();
        wheelCtx.arc(cx, cy, 28, 0, Math.PI * 2);
        wheelCtx.fillStyle = 'rgba(0,0,0,0.3)';
        wheelCtx.fill();

        // Center hub ‚Äî premium gradient
        const centerGrad = wheelCtx.createRadialGradient(cx - 3, cy - 3, 2, cx, cy, 22);
        centerGrad.addColorStop(0, '#a5b4fc');
        centerGrad.addColorStop(0.5, '#818cf8');
        centerGrad.addColorStop(1, '#6366f1');
        wheelCtx.beginPath();
        wheelCtx.arc(cx, cy, 22, 0, Math.PI * 2);
        wheelCtx.fillStyle = centerGrad;
        wheelCtx.fill();
        wheelCtx.strokeStyle = 'rgba(255,255,255,0.4)';
        wheelCtx.lineWidth = 2;
        wheelCtx.stroke();

        // Center star icon
        wheelCtx.shadowColor = 'rgba(0,0,0,0.4)';
        wheelCtx.shadowBlur = 3;
        wheelCtx.fillStyle = '#fbbf24';
        wheelCtx.font = 'bold 16px sans-serif';
        wheelCtx.textAlign = 'center';
        wheelCtx.textBaseline = 'middle';
        wheelCtx.fillText('‚òÖ', cx, cy);
        wheelCtx.shadowBlur = 0;
    }

    function spinWheel() {
        if (!fortuneEnabled) {
            showToast('Roue d√©sactiv√©e', 'Activez la roue dans les param√®tres', 'info');
            return;
        }
        const btn = document.getElementById('spin-wheel-btn');
        if (btn.disabled) return;
        btn.disabled = true;

        let currentRotation = 0;
        const spins = 1800 + Math.random() * 360;
        const duration = 3000;
        const startTime = Date.now();

        function animate() {
            const elapsed = Date.now() - startTime;
            const progress = Math.min(elapsed / duration, 1);
            currentRotation = spins * progress;
            if (wheelCanvas) wheelCanvas.style.transform = `rotate(${currentRotation}deg)`;

            if (progress < 1) {
                requestAnimationFrame(animate);
            } else {
                const winningIndex = Math.floor((currentRotation % 360) / (360 / wheelSegments.length));
                const prize = wheelSegments[winningIndex];
                showToast('üéâ Gagn√©!', `${prize.text}`, 'success');
                confetti({ spread: 180, origin: { y: 0.6 } });
                setTimeout(() => btn.disabled = false, 500);
            }
        }
        animate();
    }

    function toggleFortune() {
        const toggle = document.getElementById('fortune-toggle');
        fortuneEnabled = toggle.checked;
        showToast(fortuneEnabled ? 'Roue activ√©e' : 'Roue d√©sactiv√©e', '', fortuneEnabled ? 'success' : 'info');
        savePrefs();
    }

    function renderSegmentsList() {
        const list = document.getElementById('wheel-segments-list');
        if (!list) return;
        list.innerHTML = wheelSegments.map((seg, i) => `
            <div class="flex items-center gap-1.5 p-1.5 bg-white/5 rounded-lg group hover:bg-white/10 transition-all">
                <div class="w-3 h-3 rounded-sm flex-shrink-0" style="background: ${seg.color}"></div>
                <input type="text" value="${seg.text}" onchange="updateSegmentText(${i}, this.value)" class="flex-1 bg-transparent text-xs text-white border-0 outline-none focus:bg-white/10 rounded px-1 py-0.5 transition-all cursor-text" />
                <button onclick="removeSegment(${i})" class="opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-300 transition-all text-[10px] px-1" title="Supprimer">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
        `).join('');
    }

    function updateSegmentText(index, newText) {
        if (!newText.trim()) return;
        wheelSegments[index].text = newText.trim();
        drawWheel();
        savePrefs();
    }

    function addSegment() {
        if (wheelSegments.length >= 12) {
            showToast('Maximum 12 segments', '', 'warning');
            return;
        }
        const colors = ['#818cf8', '#10b981', '#f59e0b', '#f43f5e', '#ec4899', '#06b6d4', '#8b5cf6', '#14b8a6'];
        const newColor = colors[wheelSegments.length % colors.length];
        wheelSegments.push({ text: 'Autre r√©compense', color: newColor });
        drawWheel();
        renderSegmentsList();
        savePrefs();
        // Focus the new input for immediate editing
        setTimeout(() => {
            const list = document.getElementById('wheel-segments-list');
            const inputs = list?.querySelectorAll('input[type="text"]');
            if (inputs && inputs.length > 0) {
                const lastInput = inputs[inputs.length - 1];
                lastInput.focus();
                lastInput.select();
            }
        }, 100);
    }

    function removeSegment(index) {
        if (wheelSegments.length <= 2) {
            showToast('Minimum 2 segments requis', '', 'warning');
            return;
        }
        wheelSegments.splice(index, 1);
        drawWheel();
        renderSegmentsList();
        savePrefs();
    }

    function updateWheelColors() {
        const c1 = document.getElementById('wheel-color-1')?.value || '#818cf8';
        const c2 = document.getElementById('wheel-color-2')?.value || '#10b981';
        const c3 = document.getElementById('wheel-color-3')?.value || '#f59e0b';
        // Update segment colors cyclically
        wheelSegments.forEach((seg, i) => {
            const colorIndex = i % 3;
            if (colorIndex === 0) seg.color = c1;
            else if (colorIndex === 1) seg.color = c2;
            else seg.color = c3;
        });
        drawWheel();
        renderSegmentsList();
    }

    // ============================================
    // FEATURE 2: FOMO / SOCIAL PROOF BUBBLE
    // ============================================
    // FOMO / Social Proof ‚Äî bas√© sur vrais √©v√©nements QR r√©cents
    let fomoEnabled = true;
    let fomoInterval = null;
    let fomoRecentEvents = []; // Populated from Supabase qr_tokens

    async function loadFomoEvents() {
        if (!USE_SUPABASE || !supabaseClient) return;
        try {
            const since = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();
            const { data } = await supabaseClient
                .from('qr_tokens')
                .select('reward, used_at, business_name')
                .eq('used', true)
                .gte('used_at', since)
                .order('used_at', { ascending: false })
                .limit(20);
            if (data && data.length > 0) {
                fomoRecentEvents = data;
            }
        } catch(e) { console.warn('FOMO events load error:', e); }
    }

    function initFomoBubble() {
        loadFomoEvents();
        if (fomoEnabled && !fomoInterval) {
            fomoInterval = setInterval(showFomoBubble, 30000);
        }
    }

    function toggleFomoSetting() {
        const toggle = document.getElementById('fomo-toggle');
        fomoEnabled = toggle.checked;
        if (fomoEnabled && !fomoInterval) {
            fomoInterval = setInterval(showFomoBubble, 30000);
        } else if (!fomoEnabled && fomoInterval) {
            clearInterval(fomoInterval);
            fomoInterval = null;
        }
        showToast(fomoEnabled ? 'Bulles FOMO activ√©es' : 'Bulles FOMO d√©sactiv√©es', '', fomoEnabled ? 'success' : 'info');
        savePrefs();
    }

    function showFomoBubble() {
        if (!fomoEnabled) return;

        // Ne montrer les bulles FOMO que sur la vue client, pas sur le dashboard commer√ßant
        const customerView = document.getElementById('view-customer');
        if (!customerView || customerView.classList.contains('view-hidden')) return;

        // Si pas d'√©v√©nements r√©els, ne pas afficher de fausses bulles
        if (fomoRecentEvents.length === 0) return;

        const evt = fomoRecentEvents[Math.floor(Math.random() * fomoRecentEvents.length)];
        const minsAgo = Math.max(1, Math.floor((Date.now() - new Date(evt.used_at).getTime()) / 60000));
        const timeLabel = minsAgo < 60 ? `il y a ${minsAgo} min` : minsAgo < 1440 ? `il y a ${Math.floor(minsAgo / 60)}h` : 'r√©cemment';
        const rewardText = typeof escapeHtml === 'function' ? escapeHtml(evt.reward || '') : (evt.reward || '');
        const message = `üéÅ Un client vient de gagner "${rewardText}" ${timeLabel}`;

        const bubble = document.createElement('div');
        bubble.className = 'fomo-bubble';
        bubble.innerHTML = `
            <div class="flex items-start justify-between gap-3 text-white">
                <div class="flex-1">
                    <p class="text-sm font-bold">${message}</p>
                </div>
                <button onclick="this.closest('.fomo-bubble').classList.add('slide-out'); setTimeout(() => this.closest('.fomo-bubble').remove(), 500)" class="fomo-close text-lg leading-none">√ó</button>
            </div>
        `;
        document.body.appendChild(bubble);

        setTimeout(() => {
            if (bubble.parentNode) {
                bubble.classList.add('slide-out');
                setTimeout(() => bubble.remove(), 500);
            }
        }, 5000);
    }

    // ============================================
    // FEATURE 3: MODE KIOSQUE (KIOSK MODE)
    // ============================================
    function activateKioskMode() {
        const container = document.getElementById('main-content');
        if (!container) return;

        const html = `
            <div class="kiosk-container">
                <div class="kiosk-content">
                    <div class="kiosk-logo">üèÜ</div>
                    <h1 class="kiosk-message">Scannez pour<br>laisser un avis ‚≠ê</h1>
                    <div class="kiosk-qr">
                        <canvas id="kiosk-qr-canvas"></canvas>
                    </div>
                    <div class="kiosk-reward-info">
                        <p class="text-2xl font-bold">Gagnez des r√©compenses</p>
                        <p class="text-base mt-2">Tapez 5 fois sur le logo pour quitter</p>
                    </div>
                </div>
            </div>
        `;
        container.innerHTML = html;

        // Generate QR code
        setTimeout(() => {
            const qrCanvas = document.getElementById('kiosk-qr-canvas');
            if (qrCanvas && window.QRCode) {
                new QRCode(qrCanvas, {
                    text: window.location.href,
                    width: 300,
                    height: 300,
                    colorDark: '#0f172a',
                    colorLight: '#ffffff'
                });
            }
        }, 100);

        // 5-tap exit gesture on logo
        let tapCount = 0;
        const logo = document.querySelector('.kiosk-logo');
        if (logo) {
            logo.addEventListener('click', () => {
                tapCount++;
                if (tapCount >= 5) {
                    exitKioskMode();
                }
            });
            setInterval(() => tapCount = 0, 2000);
        }
    }

    function exitKioskMode() {
        showToast('Mode kiosque d√©sactiv√©', '', 'info');
        switchTab('portal');
        location.reload();
    }

    // ============================================
    // FEATURE 4: LEADERBOARD EMPLOY√âS (EMPLOYEE LEADERBOARD)
    // ============================================
    // Leaderboard ‚Äî Bient√¥t disponible (V2, donn√©es r√©elles Supabase)
    let employees = [];

    function initLeaderboard() {
        // Bient√¥t disponible ‚Äî afficher √©tat vide
        const podium = document.getElementById('podium-container');
        if (podium) podium.innerHTML = '<div class="text-center py-8 opacity-60"><div class="w-14 h-14 rounded-2xl bg-warning/10 flex items-center justify-center mx-auto mb-3"><i class="fa-solid fa-medal text-2xl text-warning/50"></i></div><p class="text-sm font-bold text-slate-400">Leaderboard √©quipe</p><p class="text-[10px] text-slate-500 mt-1">Bient√¥t disponible</p><span class="inline-block mt-2 text-[9px] font-bold bg-warning/10 text-warning px-2 py-0.5 rounded-full">V2</span></div>';
        const list = document.getElementById('employees-list');
        if (list) list.innerHTML = '<p class="text-xs text-slate-500 text-center py-6 opacity-60">Ajoutez vos employ√©s pour suivre leurs performances individuelles</p>';
    }

    function renderPodium() {
        // Handled by initLeaderboard()
    }

    function renderEmployeesList() {
        // Handled by initLeaderboard()
    }

    function openAddEmployeeModal() {
        const name = prompt('Nom de l\'employ√©:');
        if (name && name.trim()) {
            const newEmp = {
                id: employees.length + 1,
                name: name.trim(),
                reviews: 0,
                stars: 5,
                qrCode: 'emp-' + String(employees.length + 1).padStart(3, '0')
            };
            employees.push(newEmp);
            initLeaderboard();
            showToast('Employ√© ajout√©', `${name} a √©t√© ajout√© √† l'√©quipe`, 'success');
        }
    }

    function downloadEmployeeQR(qrCode) {
        showToast('QR Code', `Pr√™t √† t√©l√©charger pour ${qrCode}`, 'info');
    }

    // ============================================
    // FEATURE 5: CONSIGNE VOCALE AI (VOICE INSTRUCTION)
    // ============================================
    let voiceInstruction = '';
    let isVoiceRecording = false;

    function initVoiceFeature() {
        const settingsTab = document.getElementById('tab-settings');
        if (!settingsTab) return;

        const voiceSection = document.createElement('div');
        voiceSection.className = 'glass-card p-6 rounded-2xl mt-6';
        voiceSection.innerHTML = `
            <h3 class="font-bold text-white mb-4 flex items-center">
                <span class="w-8 h-8 rounded-lg bg-danger/10 flex items-center justify-center mr-3"><i class="fa-solid fa-microphone text-danger text-sm"></i></span>
                Consigne Vocale IA
            </h3>
            <p class="text-xs text-slate-400 mb-4">Donnez des instructions vocales √† l'IA pour personnaliser les r√©ponses</p>
            <div class="space-y-4">
                <button id="voice-record-btn" onclick="toggleVoiceRecording()" class="w-full py-3.5 rounded-xl font-bold text-sm bg-danger/20 text-danger-light border border-danger/30 hover:bg-danger/30 transition-all flex items-center justify-center gap-2">
                    <i class="fa-solid fa-microphone mr-2"></i> <span id="voice-btn-text">Enregistrer</span>
                </button>
                <textarea id="voice-instruction-text" class="w-full bg-slate-900/50 border border-white/10 rounded-xl p-4 text-sm text-white resize-none focus:outline-none focus:border-brand focus:ring-2 focus:ring-brand/20 min-h-[100px]" placeholder="L'IA g√©n√©rera des r√©ponses selon vos instructions..."></textarea>
                <button onclick="saveVoiceInstruction()" class="w-full py-2.5 rounded-xl font-bold text-sm bg-brand/20 text-brand-light border border-brand/30 hover:bg-brand/30 transition-all">
                    <i class="fa-solid fa-save mr-2"></i> Sauvegarder
                </button>
            </div>
        `;

        const accountSection = settingsTab.querySelector('.glass-card');
        if (accountSection && accountSection.parentNode) {
            accountSection.parentNode.insertBefore(voiceSection, accountSection.nextSibling);
        }
    }

    let _voiceRecognition = null;
    function toggleVoiceRecording() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            showToast('Erreur', 'Votre navigateur ne supporte pas la reconnaissance vocale', 'error');
            return;
        }

        const btn = document.getElementById('voice-record-btn');
        const btnText = document.getElementById('voice-btn-text');

        if (isVoiceRecording && _voiceRecognition) {
            _voiceRecognition.stop();
            isVoiceRecording = false;
            btn.classList.remove('animate-pulse');
            btnText.textContent = 'Enregistrer';
            return;
        }

        _voiceRecognition = new SpeechRecognition();
        _voiceRecognition.lang = 'fr-FR';
        _voiceRecognition.continuous = false;
        _voiceRecognition.interimResults = false;

        isVoiceRecording = true;
        btn.classList.add('animate-pulse');
        btnText.textContent = 'En √©coute...';
        _voiceRecognition.start();

        _voiceRecognition.onresult = (event) => {
            let transcript = '';
            for (let i = 0; i < event.results.length; i++) {
                transcript += event.results[i][0].transcript;
            }
            const textarea = document.getElementById('voice-instruction-text');
            if (textarea) textarea.value = transcript;
            voiceInstruction = transcript;
            isVoiceRecording = false;
            btnText.textContent = 'Enregistrer';
            btn.classList.remove('animate-pulse');
            showToast('Transcription compl√®te', '', 'success');
        };

        _voiceRecognition.onend = () => {
            isVoiceRecording = false;
            if (btnText) btnText.textContent = 'Enregistrer';
            if (btn) btn.classList.remove('animate-pulse');
        };

        _voiceRecognition.onerror = () => {
            isVoiceRecording = false;
            btnText.textContent = 'Enregistrer';
            btn.classList.remove('animate-pulse');
            showToast('Erreur lors de l\'enregistrement', '', 'error');
        };
    }

    function saveVoiceInstruction() {
        const textarea = document.getElementById('voice-instruction-text');
        if (textarea) {
            voiceInstruction = textarea.value;
            showToast('Consigne sauvegard√©e', 'L\'IA utilisera cette instruction', 'success');
            savePrefs();
        }
    }

    // (Initialization merged into main DOMContentLoaded above)

    </script>

<!-- Modal ajout manuel d'avis -->
<div id="manual-review-modal" class="fixed inset-0 z-[200] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 hidden">
    <div class="glass-card rounded-2xl p-6 max-w-lg w-full border border-white/10 shadow-2xl max-h-[90vh] overflow-y-auto" style="animation: slideUp 0.3s ease">
        <div class="flex items-center justify-between mb-5">
            <h3 class="text-lg font-extrabold text-white flex items-center gap-2">
                <span class="w-9 h-9 rounded-xl bg-brand/20 flex items-center justify-center"><i class="fa-solid fa-paste text-brand"></i></span>
                Ajouter un avis manuellement
            </h3>
            <button onclick="closeManualReviewModal()" class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center text-slate-400 hover:text-white transition-colors"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <p class="text-xs text-slate-400 mb-5">Copiez-collez un avis depuis n'importe quelle plateforme. L'IA g√©n√©rera la r√©ponse automatiquement.</p>
        <div class="mb-4">
            <label class="block text-[10px] font-bold text-slate-500 mb-1.5 uppercase tracking-wider">Plateforme</label>
            <select id="manual-platform" class="w-full bg-slate-800 border border-white/10 rounded-xl p-3 text-white text-sm focus:border-brand outline-none cursor-pointer" style="color-scheme:dark">
                <option value="google">Google</option><option value="airbnb">Airbnb</option><option value="booking">Booking.com</option>
                <option value="thefork">TheFork</option><option value="tripadvisor">TripAdvisor</option><option value="trustpilot">Trustpilot</option>
                <option value="facebook">Facebook</option><option value="instagram">Instagram</option><option value="expedia">Expedia</option><option value="other">Autre</option>
            </select>
        </div>
        <div class="mb-4">
            <label class="block text-[10px] font-bold text-slate-500 mb-1.5 uppercase tracking-wider">Langue de l'avis</label>
            <select id="manual-lang" class="w-full bg-slate-800 border border-white/10 rounded-xl p-3 text-white text-sm focus:border-brand outline-none cursor-pointer" style="color-scheme:dark">
                <option value="fr" selected>&#127467;&#127479; Fran&#231;ais</option>
                <option value="en">&#127468;&#127463; English</option>
                <option value="es">&#127466;&#127480; Espa&#241;ol</option>
                <option value="it">&#127470;&#127481; Italiano</option>
                <option value="de">&#127465;&#127466; Deutsch</option>
                <option value="pt">&#127477;&#127481; Portugu&#234;s</option>
                <option value="nl">&#127475;&#127473; Nederlands</option>
                <option value="ar">&#127480;&#127462; &#1575;&#1604;&#1593;&#1585;&#1576;&#1610;&#1577;</option>
            </select>
        </div>
        <div class="mb-4">
            <label class="block text-[10px] font-bold text-slate-500 mb-1.5 uppercase tracking-wider">Nom du client</label>
            <input id="manual-author" type="text" class="w-full bg-slate-900/50 border border-white/10 rounded-xl p-3 text-white text-sm focus:border-brand outline-none" placeholder="Ex: Sophie L.">
        </div>
        <div class="mb-4">
            <label class="block text-[10px] font-bold text-slate-500 mb-1.5 uppercase tracking-wider">Note</label>
            <div id="manual-stars" class="flex gap-2">
                <i class="fa-solid fa-star text-2xl text-slate-600 cursor-pointer hover:text-yellow-400 transition-colors" onclick="setManualStar(1)"></i>
                <i class="fa-solid fa-star text-2xl text-slate-600 cursor-pointer hover:text-yellow-400 transition-colors" onclick="setManualStar(2)"></i>
                <i class="fa-solid fa-star text-2xl text-slate-600 cursor-pointer hover:text-yellow-400 transition-colors" onclick="setManualStar(3)"></i>
                <i class="fa-solid fa-star text-2xl text-slate-600 cursor-pointer hover:text-yellow-400 transition-colors" onclick="setManualStar(4)"></i>
                <i class="fa-solid fa-star text-2xl text-slate-600 cursor-pointer hover:text-yellow-400 transition-colors" onclick="setManualStar(5)"></i>
            </div>
        </div>
        <div class="mb-4">
            <label class="block text-[10px] font-bold text-slate-500 mb-1.5 uppercase tracking-wider">Texte de l'avis</label>
            <textarea id="manual-review-text" class="w-full bg-slate-900/50 border border-white/10 rounded-xl p-3 text-white text-sm focus:border-brand outline-none resize-none h-32 leading-relaxed" placeholder="Collez l'avis du client ici..."></textarea>
        </div>
        <p id="manual-review-error" class="text-danger text-xs mb-3 hidden"></p>
        <div class="flex gap-3">
            <button onclick="closeManualReviewModal()" class="flex-1 py-3 border border-white/10 rounded-xl text-sm font-bold text-slate-400 hover:bg-white/5 transition-all">Annuler</button>
            <button onclick="submitManualReview()" class="flex-1 py-3 bg-white text-slate-900 rounded-xl text-sm font-black hover:bg-slate-100 transition-all flex items-center justify-center gap-2"><i class="fa-solid fa-robot"></i> G√©n√©rer la r√©ponse IA</button>
        </div>
    </div>
</div>

</body>
</html>
